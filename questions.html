<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive Quiz</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">


  <style>
/* =========================================================
   DESKTOP / PC (DEFAULT)
   ========================================================= */
:root{
  --bg1:#f6f7fb; --bg2:#eef2ff;
  --ink:#0f172a; --muted:rgba(15,23,42,.62);
  --card:rgba(255,255,255,.92);
  --border:rgba(15,23,42,.10);
  --shadow:0 18px 44px rgba(15,23,42,.10);

  --r-xl: clamp(18px, 1.8vw, 28px);

  /* classification card height (desktop/base) */
  --clsCardH: clamp(110px, 15vh, 150px);

  --fs0: clamp(12px, .25vw + 11px, 14px);
  --fs1: clamp(14px, .35vw + 13px, 16.5px);
  --fs2: clamp(16px, .55vw + 15px, 20px);

  --btnH: clamp(42px, 5.2vh, 50px);

  --pad: clamp(10px, 1.2vw, 16px);
  --gap: clamp(8px, 1.1vw, 12px);

  --imgSz: clamp(54px, 5.6vw, 76px);

  /* Choice */
  --choiceAR: 4 / 3;

  /* MATCH */
  --matchImgH: clamp(72px, 12vw, 120px);
  --matchPadX: clamp(8px, 4vw, 56px);

  /* DRAG & DROP */
  --ddColGap: clamp(10px, 4vw, 48px);
  --ddCardH:  clamp(64px, 8vh, 86px);
  --ddImg:    clamp(54px, 6vw, 78px);

  /* CLASSIFICATION chip remove */
  --chipX: clamp(22px, 2.6vw, 26px);

  /* unified icon btn size */
  --iconBtn: 42px;

  /* Mobile helpers (defaults overridden in mobile query) */
  --vvh: 100dvh;
  --appPad: 0px;
  --topBarH: 0px;
  --stagePad: 10px;

  --choiceMobileImgH: 110px;

  /* Tall mobile list budget */
  --tallListMax: 60vh;
  --matchRowH: var(--matchImgH);
}

html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:var(--ink);
  background:
    radial-gradient(1200px 600px at 15% 20%, rgba(59,130,246,.20), transparent 55%),
    radial-gradient(900px 520px at 85% 15%, rgba(245,158,11,.18), transparent 60%),
    radial-gradient(900px 520px at 70% 90%, rgba(16,185,129,.16), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}

.appWrap{min-height:100vh; padding:var(--pad);}
.app{
  max-width:1180px;
  margin:0 auto;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--r-xl);
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:calc(100vh - (var(--pad) * 2));
}

.topBar{
  background:rgba(255,255,255,.96);
  border-bottom:1px solid rgba(15,23,42,.08);
  padding:clamp(8px, 1vw, 12px) clamp(10px, 1.2vw, 14px);
  flex:0 0 auto;
}

/* ==============================
   HEADER
   ============================== */
.qHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:var(--gap);
}
.qHead > div{
  flex:1;
  min-width:0;
  display:grid;
  grid-template-columns:1fr auto;
  grid-template-rows:auto auto;
  grid-template-areas:
    "title meta"
    "sub   sub";
  align-items:start;
  gap:6px var(--gap);
}

.qTitle{
  grid-area:title;
  font-size:var(--fs2);
  font-weight:1000;
  line-height:1.15;
  margin:0;
  text-align:right;
  min-width:0;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.qSub{
  grid-area:sub;
  font-size:var(--fs0);
  color:var(--muted);
  font-weight:900;
  margin:0;
  text-align:right;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.topMeta{
  grid-area:meta;
  display:flex;
  flex-wrap:nowrap;
  gap:var(--gap);
  white-space:nowrap;
  align-items:center;
  justify-self:end;
  margin-top:0;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  font-weight:1000;
  font-size:var(--fs0);
  background:rgba(15,23,42,.04);
  border:1px solid rgba(15,23,42,.08);
  white-space:nowrap;
  line-height:1;
}

/* ==============================
   BUTTONS
   ============================== */
.btnKid{
  border-radius:14px;
  font-weight:1000;
  font-size:var(--fs1);
  box-shadow:0 10px 18px rgba(15,23,42,.10);
  border:0;
  transition:transform .12s ease, opacity .16s ease;
  padding-inline:14px;
}
.btnKid:active{transform:scale(.99)}
.btnKid[disabled]{opacity:.55; transform:none; cursor:not-allowed}
.btnPrimary{color:#fff; background:linear-gradient(135deg, rgba(59,130,246,.98), rgba(139,92,246,.98));}
.btnSecondary{
  color:var(--ink);
  background:rgba(255,255,255,.98);
  border:1px solid rgba(15,23,42,.12);
  box-shadow:0 8px 14px rgba(15,23,42,.08);
}

.btnSound{
  height:var(--btnH);
  min-width:56px;
  border-radius:14px;
  font-weight:1000;
  border:0;
  color:#fff;
  background:linear-gradient(135deg, rgba(16,185,129,.98), rgba(59,130,246,.98));
  box-shadow:0 10px 18px rgba(15,23,42,.10);
  transition:transform .12s ease, opacity .16s ease;
  display:grid;
  place-items:center;
}
.btnSound:active{transform:scale(.99)}
.btnSound[disabled]{opacity:.55; transform:none; cursor:not-allowed}

/* ==============================
   LAYOUT
   ============================== */
.stage{
  flex:1;
  padding:var(--pad);
  position:relative;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  min-height:0;
}

.panelKid{
  background:rgba(255,255,255,.96);
  border:1px solid rgba(15,23,42,.10);
  box-shadow:0 8px 14px rgba(15,23,42,.06);
  border-radius:var(--r-xl);
  padding:var(--pad);
}
.panelFlex{display:flex; flex-direction:column; min-height:0;}
.panelBodyGrow{flex:1; min-height:0;}

.panelTitle{font-weight:1000; font-size:var(--fs1); margin:0 0 10px}
.panelTitle small{color:var(--muted); font-weight:900; font-size:var(--fs0)}

/* ==============================
   CARDS
   ============================== */
.cardBtn{
  text-align:right;
  border-radius:var(--r-xl);
  border:1px solid rgba(15,23,42,.10);
  background:rgba(255,255,255,.98);
  box-shadow:0 10px 18px rgba(15,23,42,.08);
  padding:clamp(10px, 1.1vw, 14px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  transition:transform .12s ease, border-color .15s ease, box-shadow .15s ease;
  cursor:pointer;
  width:fit-content;
  min-width:clamp(180px, 24vw, 320px);
  max-width:100%;
}
.cardBtn:active{transform:scale(.995)}
.cardBtn[data-selected="1"]{
  border-color:rgba(59,130,246,.55);
  box-shadow:0 14px 26px rgba(59,130,246,.14);
}

.cardLeft{display:flex; align-items:center; gap:10px; min-width:0;}
.cardImg{
  width:var(--imgSz);
  height:var(--imgSz);
  border-radius:16px;
  border:1px solid rgba(15,23,42,.10);
  background:rgba(15,23,42,.03);
  object-fit:cover;
  flex:0 0 auto;
}
.cardText{
  font-weight:1000;
  font-size:var(--fs1);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:42ch;
}
.cardSide{
  flex:0 0 auto;
  display:flex;
  align-items:center;
}

/* ==============================
   ICON BUTTON
   ============================== */
.iconBtn{
  width:var(--iconBtn);
  height:var(--iconBtn);
  border-radius:14px;
  border:1px solid rgba(15,23,42,.12);
  background:rgba(255,255,255,.98);
  box-shadow:0 8px 14px rgba(15,23,42,.06);
  display:grid;
  place-items:center;
  font-weight:1000;
  padding:0;
  flex:0 0 auto;
  cursor:pointer;
  transition:transform .12s ease, opacity .16s ease;
}
.iconBtn:active{transform:scale(.99)}
.iconBtn:disabled{opacity:.45; cursor:not-allowed}
.iconBtn i{font-size:20px; line-height:1}

/* ==============================
   CHOICE (DESKTOP)
   ============================== */
.choiceGrid{
  display:grid;
  gap:var(--gap);
  grid-template-columns:repeat(4, 1fr); /* PC: 4 */
  align-items:stretch;
  justify-items:stretch;
  min-height:0;
}
.choiceCard{
  width:100% !important;
  min-width:0 !important;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  justify-content:flex-start;
  text-align:center;
  padding:clamp(10px, 1.1vw, 14px);
  gap:10px;
}

.choiceImgWrap{
  position:relative;
  width:100%;
  border-radius:clamp(16px, 1.6vw, 22px);
  border:1px solid rgba(15,23,42,.10);
  background:rgba(15,23,42,.03);
  overflow:hidden;
  box-shadow:0 8px 14px rgba(15,23,42,.06);
  aspect-ratio:var(--choiceAR);
  flex:0 0 auto;
}
.choiceImg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain; /* responsive inside container */
  object-position:center;
  display:block;
  background:rgba(15,23,42,.03);
}
.choiceNoImg{position:absolute; inset:0; display:grid; place-items:center;}

.choiceMetaDesktop{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:2px 6px 0;
}
.choiceNameDesktop{
  font-weight:1000;
  font-size:var(--fs1);
  line-height:1.2;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  max-width:46ch;
}

/* Exists in HTML but OFF by default */
.choiceMetaMobile{display:none;}

.vList{display:flex; flex-direction:column; gap:var(--gap); align-items:stretch;}

.dropZone{
  width:100%;
  border-radius:var(--r-xl);
  border:2px dashed rgba(15,23,42,.18);
  background:rgba(15,23,42,.02);
  padding:clamp(10px, 1.1vw, 14px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  min-height:clamp(64px, 7.2vh, 86px);
}
.dropZone[data-active="1"]{
  border-color:rgba(59,130,246,.55);
  background:rgba(59,130,246,.06);
}
.zoneFill{
  font-weight:1000;
  font-size:var(--fs0);
  color:rgba(15,23,42,.70);
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.10);
  background:rgba(255,255,255,.90);
  white-space:nowrap;
  max-width:48%;
  overflow:hidden;
  text-overflow:ellipsis;
}

.dragItem{user-select:none;}
.dragging{opacity:.75; transform:scale(.99);}

.orderIdx{
  width:36px;
  height:36px;
  border-radius:12px;
  display:grid;
  place-items:center;
  font-weight:1000;
  background:rgba(59,130,246,.10);
  border:1px solid rgba(59,130,246,.18);
  flex:0 0 auto;
}

.footerControls{
  margin-top:var(--gap);
  display:flex;
  flex-wrap:wrap;
  gap:var(--gap);
  align-items:center;
  justify-content:flex-start;
}
.footerControls .btnKid{flex:0 0 auto;}

.grid2_1{
  display:grid;
  gap:var(--gap);
  grid-template-columns:2fr 1fr; /* PC: two columns */
  align-items:stretch;
  min-height:0;
}

/* Canvases responsive in container */
.paintCanvas,.traceCanvas{
  width:100%;
  display:block;
  border-radius:clamp(16px, 1.8vw, 22px);
  border:1px solid rgba(15,23,42,.10);
  box-shadow:0 10px 18px rgba(15,23,42,.08);
  background:rgba(255,255,255,.98);
  touch-action:none;
}

.swatch{
  width:clamp(30px, 3.8vw, 36px);
  height:clamp(30px, 3.8vw, 36px);
  border-radius:14px;
  border:2px solid rgba(15,23,42,.15);
  cursor:pointer;
  box-shadow:0 8px 14px rgba(15,23,42,.08);
}
.swatch[data-selected="1"]{outline:4px solid rgba(59,130,246,.55); outline-offset:2px;}

/* ==============================
   MATCH (PC)
   ============================== */
.pairGrid{
  display:flex;
  flex-direction:column;
  gap:clamp(8px, 1.2vw, 14px);
  width:100%;
  padding-inline:var(--matchPadX);
  box-sizing:border-box;
}
.pairRow{
  display:flex;
  width:100%;
  align-items:stretch;
  gap:clamp(24px, 6vw, 72px);
}
.pairRow > .cardBtn{
  flex:0 0 50%;
  max-width:50%;
  min-width:0;
  height:var(--matchImgH);
  padding:0 !important;
  display:flex;
  align-items:stretch;
  justify-content:stretch;
  border-radius:clamp(14px, 2vw, 18px);
}
.pairRow [data-left]{overflow:hidden;}
.pairRow [data-left] .cardLeft{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0;
}
.matchLeftImg{
  width:100% !important;
  height:100% !important;
  display:block;
  object-fit:contain;
  object-position:center;
  border:0;
  background:rgba(15,23,42,.03);
  border-radius:inherit;
}
.pairRow [data-right]{
  display:flex;
  align-items:center;
  justify-content:center;
}
.pairRow [data-right] .cardLeft{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.pairRow [data-right] .cardText{
  width:100%;
  max-width:100%;
  text-align:center;
  white-space:normal;
  overflow:hidden;
  padding:10px 14px;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
}

/* ==============================
   DRAG & DROP + CLASSIFICATION (PC)
   ============================== */
.twoColGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:var(--ddColGap);
  align-items:stretch;
  width:100%;
}
.twoColGrid > .panelKid{min-width:0 !important; height:100%;}
.twoColGrid .panelFlex{min-height:0;}
.twoColGrid .panelBodyGrow{min-height:0; overflow:auto; -webkit-overflow-scrolling:touch;}
.twoColGrid .panelBodyGrow{ overflow: visible !important; } /* PC: no nested scroll issues */

/* DRAG & DROP — PC */
#ddLeft .cardBtn{
  width:100% !important;
  min-width:0 !important;
  max-width:100% !important;
  height:var(--ddCardH);
  padding:10px 12px !important;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
#ddLeft .cardLeft{
  height:100%;
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
#ddLeft .cardImg{
  width:var(--ddImg) !important;
  height:var(--ddImg) !important;
  object-fit:contain !important;
  object-position:center;
  background:rgba(15,23,42,.03);
  flex:0 0 auto;
}
#ddLeft .cardText{
  white-space:normal !important;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  max-width:100% !important;
}

#ddRight .dropZone{
  width:100%;
  min-height:var(--ddCardH);
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
#ddRight .dropZone > .d-flex{
  height:100%;
  min-width:0;
  align-items:center;
}
#ddRight .dropZone .cardImg{
  width:var(--ddImg) !important;
  height:var(--ddImg) !important;
  object-fit:contain !important;
  object-position:center;
  background:rgba(15,23,42,.03);
}
#ddRight .dropZone .d-flex > div{
  white-space:normal !important;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
}
#ddRight .zoneFill{
  max-width:42%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* CLASSIFICATION — PC */
#clsItems .cardBtn{
  width:100% !important;
  min-width:0 !important;
  max-width:100% !important;

  height: var(--clsCardH);
  min-height: var(--clsCardH);
  max-height: var(--clsCardH);

  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;

  padding:10px;
  justify-content:flex-start !important;
}
#clsCats .dropZone{
  min-height: var(--clsCardH);
  height: auto;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
}
#clsItems .cardImg{
  width:100%;
  height: calc(var(--clsCardH) - 46px);
  object-fit:contain;
  border-radius:18px;
  margin-bottom:5px;
}
#clsItems .clsTitleRow{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:5px;
  margin-top:-14px;
  min-width:0;
}
#clsItems .clsTitleRow .cardText{
  margin:0 !important;
  font-weight:1000;
  font-size:var(--fs1);
  text-align:center;
  max-width:70%;
  min-width:0;
  flex:0 1 auto;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#clsItems .clsTitleRow .cardSide{
  width:auto !important;
  margin:0 !important;
  flex:0 0 auto;
  display:flex;
  align-items:center;
  justify-content:center;
}
#clsItems .cardLeft{
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
}
#clsItems .iconBtn{
  width:32px;
  height:32px;
  border-radius:10px;
}
#clsItems .iconBtn i{font-size:18px;}

/* XL desktop classification horizontal layout */
@media (min-width: 1280px){
  #clsItems .cardBtn{
    flex-direction:row !important;
    align-items:center !important;
    gap:12px;
  }
  #clsItems .cardLeft{
    flex-direction:row !important;
    align-items:center !important;
    width:50%;
    gap:32px;
  }
  #clsItems .cardImg{
    flex:1 1 auto !important;
    width:50% !important;
    height:50% !important;
    object-fit:contain;
  }
  #clsItems .clsTitleRow{
    flex:0 0 auto !important;
    justify-content:flex-start !important;
    margin-top:0 !important;
    max-width:50%;
    gap:30px;
  }
  #clsItems .clsTitleRow .cardText{
    max-width:100%;
    text-align:right;
  }
}

/* ORDERING — PC width */
#orderList{
  display:flex;
  flex-direction:column;
  align-items:center;
}
#orderList > .cardBtn{
  width:70% !important;
  max-width:70% !important;
  min-width:70% !important;
  margin-inline:auto;
}

/* ==============================
   VISUAL EFFECTS (ALL)
   ============================== */
.correctPulse{
  animation: correctPulse .6s ease-out;
  outline: 4px solid rgba(34,197,94,.45);
  box-shadow: 0 14px 30px rgba(34,197,94,.20);
}
@keyframes correctPulse{
  0%{ transform: scale(1); }
  35%{ transform: scale(1.03); }
  100%{ transform: scale(1); }
}
.wrongShake{
  animation: wrongShake .45s ease-in-out;
  outline: 4px solid rgba(239,68,68,.40);
  box-shadow: 0 14px 28px rgba(239,68,68,.18);
}
@keyframes wrongShake{
  0%,100%{ transform: translateX(0); }
  20%{ transform: translateX(-10px); }
  40%{ transform: translateX(10px); }
  60%{ transform: translateX(-7px); }
  80%{ transform: translateX(7px); }
}
.starBurst{
  position: fixed;
  left: 50%;
  top: 18%;
  transform: translateX(-50%);
  font-size: 42px;
  z-index: 9999;
  pointer-events: none;
  animation: starBurst .7s ease-out;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.22));
}
@keyframes starBurst{
  0%{ opacity: 0; transform: translateX(-50%) translateY(12px) scale(.7); }
  25%{ opacity: 1; }
  100%{ opacity: 0; transform: translateX(-50%) translateY(-22px) scale(1.2); }
}

/* Selection/result common styles */
.selSingle{
  outline: 4px solid rgba(59,130,246,.45);
  background: rgba(59,130,246,.08);
  box-shadow: 0 14px 28px rgba(59,130,246,.18);
}
.answerOK{
  outline: 4px solid rgba(34,197,94,.55) !important;
  background: rgba(34,197,94,.10) !important;
  box-shadow: 0 14px 30px rgba(34,197,94,.22) !important;
}
.answerBAD{
  outline: 4px solid rgba(239,68,68,.55) !important;
  background: rgba(239,68,68,.10) !important;
  box-shadow: 0 14px 30px rgba(239,68,68,.22) !important;
}
.answerOK, .answerBAD{ animation: answerPulse .45s ease-out; }
@keyframes answerPulse{
  0%{ transform: scale(1); }
  35%{ transform: scale(1.03); }
  100%{ transform: scale(1); }
}

/* Pair helpers */
.fxRel{ position: relative; }
.fxBadge{
  position: absolute;
  top: 10px;
  inset-inline-start: 10px;
  width: 28px;
  height: 28px;
  border-radius: 999px;
  display: grid;
  place-items: center;
  font-weight: 1000;
  font-size: 13px;
  background: #6366f1;
  color: #fff;
}
.matchArmed{
  outline: 4px dashed rgba(59,130,246,.55);
  background: rgba(59,130,246,.06);
}
.matchPaired{
  outline: 4px solid rgba(245,158,11,.40);
  background: rgba(245,158,11,.08);
}

/* Center modal feedback */
.fxOverlay{
  position: fixed;
  inset: 0;
  z-index: 5000;
  display: none;
  place-items: center;
  padding: 18px;
  background: rgba(15,23,42,.35);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.fxOverlay.show{ display: grid; }
.fxModal{
  width: min(520px, 92vw);
  border-radius: 22px;
  border: 1px solid rgba(15,23,42,.12);
  background: rgba(255,255,255,.96);
  box-shadow: 0 24px 60px rgba(15,23,42,.22);
  padding: 18px 18px 16px;
  display: grid;
  gap: 10px;
  transform: translateY(8px) scale(.98);
  opacity: 0;
  animation: fxIn .22s ease-out forwards;
}
@keyframes fxIn{ to{ transform: translateY(0) scale(1); opacity: 1; } }
.fxIcon{
  width: 56px;
  height: 56px;
  border-radius: 18px;
  display: grid;
  place-items: center;
  font-size: 26px;
  font-weight: 1000;
  border: 1px solid rgba(15,23,42,.10);
  box-shadow: 0 10px 18px rgba(15,23,42,.08);
}
.fxTitle{
  margin: 0;
  font-weight: 1000;
  font-size: clamp(18px, .7vw + 16px, 22px);
}
.fxMsg{
  margin: 0;
  color: rgba(15,23,42,.68);
  font-weight: 900;
  line-height: 1.7;
  font-size: var(--fs1);
}
.fxRow{ display: flex; align-items: center; gap: 12px; }
.fxOK .fxIcon{
  background: rgba(34,197,94,.12);
  outline: 4px solid rgba(34,197,94,.18);
}
.fxBAD .fxIcon{
  background: rgba(239,68,68,.12);
  outline: 4px solid rgba(239,68,68,.18);
}
.fxModal.fxOut{ animation: fxOut .18s ease-in forwards; }
@keyframes fxOut{ to{ transform: translateY(10px) scale(.98); opacity: 0; } }

/* Popup overlay (CSS-only version) */
.popOverlay{
  position:fixed;
  inset:0;
  display:none;
  place-items:center;
  background:rgba(15,23,42,.35);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index:9999;
  padding:16px;
}
.popOverlay.show{ display:grid; }
.popCard{
  width:min(520px, 100%);
  border-radius:22px;
  border:1px solid rgba(15,23,42,.10);
  background:rgba(255,255,255,.96);
  box-shadow:0 22px 60px rgba(15,23,42,.22);
  padding:18px 18px 16px;
  transform: translateY(10px) scale(.98);
  opacity:0;
  transition: transform .22s ease, opacity .22s ease;
}
.popOverlay.show .popCard{ transform: translateY(0) scale(1); opacity:1; }
.popTitle{
  font-weight:1000;
  font-size:clamp(18px, .6vw + 16px, 22px);
  margin:0 0 6px;
  line-height:1.2;
  text-align:center;
}
.popMsg{
  margin:0;
  color:rgba(15,23,42,.70);
  font-weight:900;
  line-height:1.7;
  text-align:center;
  font-size:var(--fs1);
}
.popIcon{
  width:56px;
  height:56px;
  border-radius:18px;
  display:grid;
  place-items:center;
  margin:0 auto 10px;
  font-size:30px;
  font-weight:1000;
  border:1px solid rgba(15,23,42,.10);
}
.popCard[data-kind="ok"]  .popIcon{ background: rgba(34,197,94,.12); }
.popCard[data-kind="bad"] .popIcon{ background: rgba(239,68,68,.12); }

/* Sticky footer */
#footerControls{
  position: sticky;
  bottom: 0;
  z-index: 50;
  background: rgba(255,255,255,.96);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-top: 1px solid rgba(15,23,42,.10);
  padding: 10px;
  margin-top: var(--gap);
  padding-bottom: calc(10px + env(safe-area-inset-bottom));
}

/* Classification items: never exceed column width */
#clsItems .cardBtn{
  width: 100% !important;
  min-width: 0 !important;
  max-width: 100% !important;
}
#clsItems .cardLeft,
#clsItems .clsTitleRow{
  min-width: 0 !important;
}

/* =========================================================
   MOBILE ONLY (<=520px)
   ========================================================= */
@media (max-width: 520px){

  :root{
    --ddColGap: clamp(8px, 3vw, 12px);
    --ddCardH:  clamp(60px, 10vh, 76px);
    --ddImg:    clamp(46px, 9vw, 64px);

    --vvh: 100dvh;     /* JS overrides with px value */
    --appPad: 0px;
    --topBarH: 0px;    /* JS sets */
    --stagePad: 10px;

    --choiceMobileImgH: 110px;

    /* default mobile list height budget */
    --tallListMax: 60vh;

    /* match row height on normal mobile */
    --matchRowH: clamp(100px, 14vh, 140px);
  }

  html, body{
    height:100%;
    overflow:hidden; /* prevent body scroll + blank folds */
  }

  /* APP fills viewport */
  .appWrap{
    padding: var(--appPad) !important;
    height: var(--vvh) !important;
    min-height: var(--vvh) !important;
  }

  .app{
    max-width:none !important;
    width:100% !important;
    height: var(--vvh) !important;
    min-height: var(--vvh) !important;
    border-radius:0 !important;
    overflow:hidden !important;
    display:flex !important;
    flex-direction:column !important;
  }

  /* Outer .stage wrapper (you have two stages) */
  .appWrap > .stage{
    display:flex !important;
    flex-direction:column !important;
    height:100% !important;
    min-height:0 !important;
    overflow:hidden !important;
    padding:0 !important;
    border-radius:0 !important;
  }

  #topMeta{display:none !important;}

  /* Stage: ONLY scroll container */
  #stage{
    flex: 1 1 auto !important;
    min-height:0 !important;
    height: calc(var(--vvh) - var(--topBarH)) !important;
    max-height: calc(var(--vvh) - var(--topBarH)) !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
    padding: var(--stagePad) !important;
  }

  /* Avoid forcing 100% height -> blank space */
  #stage > .panelKid,
  #stage > .twoColGrid,
  #stage > .grid2_1{
    min-height:0 !important;
    height:auto !important;
  }

  .panelKid{min-width:0 !important;}
  .panelFlex{
    display:flex !important;
    flex-direction:column !important;
    min-height:0 !important;
    height:auto !important;
  }

  /* Default: natural height panels */
  .panelBodyGrow{
    flex: 0 0 auto !important;
    min-height:0 !important;
    overflow:visible !important;
  }

  /* Two columns: allow inner scroll for lists */
  .twoColGrid{
    height:auto !important;
    min-height:0 !important;
    align-content:stretch !important;
    gap: var(--ddColGap) !important;
  }
  .twoColGrid > .panelKid{
    min-height:0 !important;
    height:auto !important;
  }
  .twoColGrid .panelFlex{min-height:0 !important;}
  .twoColGrid .panelBodyGrow{
    flex: 1 1 auto !important;
    min-height:0 !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
  }

  /* Footer: sticky without big gap */
  #footerControls{
    position: sticky !important;
    bottom: 0 !important;
    z-index: 50 !important;
    margin-top: 10px !important;
    padding-bottom: max(10px, env(safe-area-inset-bottom)) !important;
    background: rgba(255,255,255,.96);
  }
  .footerControls .btnKid{flex:1 1 auto;}

  /* Smaller icon buttons on mobile */
  .choiceMetaDesktop .iconBtn,
  #orderList .iconBtn{
    width:34px;
    height:34px;
    border-radius:10px;
  }
  .iconBtn i{font-size:18px;}

  /* =========================
     CHOICE (listen_choose + multiple_choice)
     ========================= */
  .choiceGrid{grid-template-columns:1fr !important;}
  .choiceCard{padding:12px !important; gap:12px !important;}

  .choiceImgWrap{
    aspect-ratio:auto !important;
    height: var(--choiceMobileImgH) !important;
    min-height:0 !important;
  }
  .choiceImg{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:contain !important;
    object-position:center;
  }

  /* overlay OFF, desktop row ON */
  .choiceMetaMobile{display:none !important;}
  .choiceMetaDesktop{display:flex !important;}

  .choiceNameDesktop{
    -webkit-line-clamp:1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* =========================
     MATCH
     ========================= */
  .pairRow{gap:clamp(6px, 3vw, 10px) !important;}
  .pairRow > .cardBtn{height: var(--matchRowH) !important;}
  #pairGrid{
    min-height:0 !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
    max-height: var(--tallListMax);
  }

  /* =========================
     DRAG & DROP
     ========================= */
  #ddLeft, #ddRight{
    min-height:0 !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
    max-height: var(--tallListMax);
  }
  #ddLeft .cardBtn{height: var(--ddCardH) !important;}
  #ddLeft .cardImg{
    width:var(--ddImg) !important;
    height:var(--ddImg) !important;
    object-fit:contain !important;
  }
  #ddRight .dropZone{min-height: var(--ddCardH) !important;}
  #ddRight .dropZone .cardImg{
    width:var(--ddImg) !important;
    height:var(--ddImg) !important;
    object-fit:contain !important;
  }

  /* =========================
     ORDERING
     ========================= */
  .orderIdx{
    width:28px !important;
    height:28px !important;
    border-radius:10px !important;
    font-size:12px !important;
  }

  #orderList{
    min-height:0 !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
    max-height: var(--tallListMax);
    align-items: stretch !important;
  }
  #orderList > .cardBtn{
    width:92% !important;
    max-width:92% !important;
    min-width:92% !important;
    margin-inline:auto;
    padding:12px 12px !important;
  }
  #orderList .cardImg{
    width: clamp(54px, 12vw, 74px) !important;
    height: clamp(54px, 12vw, 74px) !important;
    object-fit: contain !important;
  }

  #orderList .iconBtn{
    width:28px !important;
    height:28px !important;
    border-radius:10px !important;
    padding:0 !important;
  }
  #orderList .iconBtn i{font-size:16px !important;}
  #orderList [data-orderid] .d-flex.gap-2.align-items-center{gap:6px !important;}
  #orderList .cardLeft{gap:8px !important;}
  #orderList .cardText{max-width:100% !important; -webkit-line-clamp:2 !important; white-space:normal !important;}

  /* =========================
     CLASSIFICATION
     ========================= */
  #clsItems, #clsCats{
    min-height:0 !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
    max-height: var(--tallListMax);
  }
  #clsItems .cardBtn{
    min-height: clamp(100px, 13vh, 140px) !important;
    height:auto !important;
    padding:12px !important;
  }
  #clsItems .cardImg{
    width:100% !important;
    height: clamp(70px, 10vh, 100px) !important;
    object-fit: contain !important;
  }
  #clsItems .clsTitleRow{
    flex-wrap:nowrap !important;
    gap:2px !important;
  }
  #clsItems .clsTitleRow .cardText{max-width:70% !important;}

  /* =========================
     COLORING / TRACE (grid2_1 -> single col)
     ========================= */
  .grid2_1{
    grid-template-columns:1fr !important;
    height:auto !important;
    min-height:0 !important;
  }
  .grid2_1 > .panelKid{
    min-height:0 !important;
    height:auto !important;
    padding: 14px !important;
  }

  /* coloring & trace canvases: taller on mobile */
  .paintCanvas,
  .traceCanvas{
    max-height: 52vh;
  }

  /* Coloring controls: label+value row, slider under (mobile clean) */
  .paintSizeRow,
  .paintOpacityRow{
    display: grid !important;
    grid-template-columns: 1fr auto !important;
    grid-template-areas:
      "label val"
      "range range" !important;
    gap: 8px !important;
    align-items: center !important;
    width:100%;
    min-width:0;
  }
  .paintSizeLabel{ grid-area: label !important; }
  .paintSizeVal{   grid-area: val !important; }
  .paintSizeRange{ grid-area: range !important; width: 100% !important; min-width: 0 !important; margin: 0 !important; }

  .paintOpacityLabel{ grid-area: label !important; }
  .paintOpacityVal{   grid-area: val !important; }
  .paintOpacityRange{ grid-area: range !important; width: 100% !important; min-width: 0 !important; margin: 0 !important; }

  /* =========================
     BUILD (construct)
     ========================= */
  #tiles{
    max-height: 45vh;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }
  #buildWrap{padding: 14px !important;}
  #buildWrap .pill{
    font-size: clamp(16px, 2.2vw + 14px, 20px) !important;
    padding: 12px 14px !important;
  }
  #buildWrap [data-tile]{
    height: 52px !important;
    min-width: 70px !important;
    font-size: clamp(14px, 1.8vw + 12px, 18px) !important;
  }

  /* =========================================================
     TALL MOBILE OVERRIDE (390×844 / 393×873 and similar)
     - minimal duplication: mostly variables change
     ========================================================= */
/* =========================================================
   MOBILE ONLY (360×800 base → tall phones 390×844 / 393×873)
   ========================================================= */
@media (max-width: 520px){

  /* ---------------------------
     BASE MOBILE VARIABLES
     --------------------------- */
  :root{
    --vvh: 100dvh;   /* JS overrides with px */
    --appPad: 0px;
    --topBarH: 0px;  /* JS sets */
    --stagePad: 10px;

    /* Global “use space” budgets */
    --listMax: 72vh;        /* was 60vh => too small */
    --panelPad: 14px;

    /* Choice cards */
    --choiceCardGap: 12px;
    --choiceCardPad: 14px;
    --choiceMobileImgH: 150px; /* base mobile bigger */

    /* Match */
    --matchRowH: clamp(124px, 18vh, 170px);

    /* Drag & Drop */
    --ddColGap: 12px;
    --ddCardH: clamp(74px, 10vh, 98px);
    --ddImg:   clamp(56px, 12vw, 78px);

    /* Ordering */
    --orderRowH: clamp(78px, 10vh, 100px);
    --orderImg:  clamp(60px, 13vw, 84px);

    /* Classification */
    --clsItemImgH: clamp(84px, 12vh, 120px);
    --clsItemMinH: clamp(130px, 16vh, 180px);
    --clsCatMinH:  clamp(120px, 15vh, 170px);

    /* Coloring / Trace canvases */
    --canvasMax: 64vh;
    --toolsMin:  220px;

    /* Build */
    --buildSlotsPad: 14px;
    --buildTileH: 56px;
    --buildTileMinW: 76px;
  }

  html, body{
    height:100%;
    overflow:hidden; /* prevent body scroll */
  }

  /* App fills viewport */
  .appWrap{
    padding: var(--appPad) !important;
    height: var(--vvh) !important;
    min-height: var(--vvh) !important;
  }
  .app{
    max-width:none !important;
    width:100% !important;
    height: var(--vvh) !important;
    min-height: var(--vvh) !important;
    border-radius:0 !important;
    overflow:hidden !important;
    display:flex !important;
    flex-direction:column !important;
  }

  /* Outer wrapper stage (you have two .stage elements) */
  .appWrap > .stage{
    display:flex !important;
    flex-direction:column !important;
    height:100% !important;
    min-height:0 !important;
    overflow:hidden !important;
    padding:0 !important;
    border-radius:0 !important;
  }

  #topMeta{ display:none !important; }

  /* Main scroll container */
  #stage{
    flex: 1 1 auto !important;
    min-height:0 !important;
    height: calc(var(--vvh) - var(--topBarH)) !important;
    max-height: calc(var(--vvh) - var(--topBarH)) !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
    padding: var(--stagePad) !important;
  }

  /* Prevent “blank space under short content” */
  #stage > .panelKid,
  #stage > .twoColGrid,
  #stage > .grid2_1{
    height:auto !important;
    min-height:0 !important;
  }

  .panelKid{
    min-width:0 !important;
    padding: var(--panelPad) !important;
  }

  /* Footer sticky (no gap) */
  #footerControls{
    position: sticky !important;
    bottom: 0 !important;
    z-index: 50 !important;
    margin-top: 10px !important;
    padding-bottom: max(10px, env(safe-area-inset-bottom)) !important;
    background: rgba(255,255,255,.96);
  }
  .footerControls .btnKid{ flex:1 1 auto; }

  /* Smaller icon buttons (but still tappable) */
  .iconBtn{
    width: 36px !important;
    height: 36px !important;
    border-radius: 12px !important;
  }
  .iconBtn i{ font-size:18px !important; }

  /* =========================================================
     CHOICE (multiple_choice + listen_choose)
     - Card higher
     - Image container higher
     - Image responsive
     ========================================================= */
  .choiceGrid{ grid-template-columns:1fr !important; }

  .choiceCard{
    padding: var(--choiceCardPad) !important;
    gap: var(--choiceCardGap) !important;
  }

  .choiceImgWrap{
    aspect-ratio:auto !important;
    height: var(--choiceMobileImgH) !important;
    border-radius: 18px !important;
    overflow:hidden !important;
  }

  .choiceImg{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:contain !important;
    object-position:center !important;
  }

  .choiceMetaMobile{ display:none !important; }
  .choiceMetaDesktop{ display:flex !important; }
  .choiceNameDesktop{
    -webkit-line-clamp:2 !important;
    white-space:normal !important;
  }

  /* =========================================================
     MATCH
     - Make boxes taller to consume unused space
     ========================================================= */
  .pairGrid{
    padding-inline: 6px !important;
  }
  .pairRow{
    gap: 10px !important;
  }
  .pairRow > .cardBtn{
    height: var(--matchRowH) !important;
  }

  /* Instead of limiting to 60vh, allow it to use more */
  #pairGrid{
    max-height: var(--listMax) !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
  }

  /* =========================================================
     TWO COLUMN LAYOUTS (drag_drop + classification)
     - Let lists grow taller (use free space)
     ========================================================= */
  .twoColGrid{
    gap: var(--ddColGap) !important;
    align-items: stretch !important;
  }
  .twoColGrid > .panelKid{
    min-height: 0 !important;
  }
  .twoColGrid .panelFlex{
    min-height: 0 !important;
  }
  .twoColGrid .panelBodyGrow{
    flex: 1 1 auto !important;
    min-height: 0 !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
    max-height: var(--listMax) !important;
  }

  /* =========================================================
     DRAG & DROP
     - Taller cards + bigger image
     ========================================================= */
  #ddLeft .cardBtn{
    height: var(--ddCardH) !important;
    padding: 12px !important;
  }
  #ddLeft .cardImg{
    width: var(--ddImg) !important;
    height: var(--ddImg) !important;
    object-fit:contain !important;
  }

  #ddRight .dropZone{
    min-height: var(--ddCardH) !important;
    padding: 12px !important;
  }
  #ddRight .dropZone .cardImg{
    width: var(--ddImg) !important;
    height: var(--ddImg) !important;
    object-fit:contain !important;
  }
  #ddLeft, #ddRight{
    max-height: var(--listMax) !important;
  }

  /* =========================================================
     ORDERING
     - Taller row + bigger image + keep responsive
     ========================================================= */
  #orderList{
    max-height: var(--listMax) !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
    align-items: stretch !important;
  }
  #orderList > .cardBtn{
    width: 94% !important;
    min-width: 94% !important;
    max-width: 94% !important;
    margin-inline:auto;
    min-height: var(--orderRowH) !important;
    padding: 12px !important;
  }
  #orderList .cardImg{
    width: var(--orderImg) !important;
    height: var(--orderImg) !important;
    object-fit: contain !important;
  }
  .orderIdx{
    width: 32px !important;
    height: 32px !important;
    border-radius: 12px !important;
    font-size: 13px !important;
  }

  /* =========================================================
     CLASSIFICATION
     - Bigger item cards + bigger category zones
     ========================================================= */
  #clsItems, #clsCats{
    max-height: var(--listMax) !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
  }

  #clsItems .cardBtn{
    min-height: var(--clsItemMinH) !important;
    height:auto !important;
    padding: 12px !important;
  }
  #clsItems .cardImg{
    width: 100% !important;
    height: var(--clsItemImgH) !important;
    object-fit: contain !important;
  }

  #clsCats .dropZone{
    min-height: var(--clsCatMinH) !important;
  }

  /* =========================================================
     COLORING + TRACE (grid2_1 -> single column)
     - Taller canvas
     - Taller tools panel
     - Sliders UNDER text (not aligned in same row)
     ========================================================= */
  .grid2_1{
    grid-template-columns:1fr !important;
    min-height:0 !important;
  }

  .paintCanvas,
  .traceCanvas{
    max-height: var(--canvasMax) !important;
  }

  /* Tools panel uses more height */
  .grid2_1 > .panelKid:nth-child(2){
    min-height: var(--toolsMin) !important;
  }

  /* Sliders under the labels */
  .paintSizeRow,
  .paintOpacityRow{
    display: grid !important;
    grid-template-columns: 1fr auto !important;
    grid-template-areas:
      "label val"
      "range range" !important;
    gap: 10px !important;
  }
  .paintSizeLabel{ grid-area: label !important; }
  .paintSizeVal{   grid-area: val !important; }
  .paintSizeRange{ grid-area: range !important; width:100% !important; margin:0 !important; }

  .paintOpacityLabel{ grid-area: label !important; }
  .paintOpacityVal{   grid-area: val !important; }
  .paintOpacityRange{ grid-area: range !important; width:100% !important; margin:0 !important; }

  /* =========================================================
     BUILD (construct)
     - Use free space: bigger slots + bigger tiles + more height
     ========================================================= */
  #buildWrap{
    padding: 14px !important;
  }

  #buildWrap .d-flex.gap-2.flex-wrap.justify-content-center.p-3{
    padding: var(--buildSlotsPad) !important;
  }

  #buildWrap .pill{
    font-size: clamp(16px, 2.4vw + 13px, 22px) !important;
    padding: 12px 14px !important;
    min-width: 64px !important;
  }

  #tiles{
    max-height: 58vh !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
  }

  #buildWrap [data-tile]{
    height: var(--buildTileH) !important;
    min-width: var(--buildTileMinW) !important;
    font-size: clamp(14px, 2vw + 12px, 18px) !important;
    border-radius: 14px !important;
  }

  /* =========================================================
     TALL PHONE BOOST (390×844 / 393×873)
     - This is the key part you were missing
     ========================================================= */
  @media (max-width: 520px) and (min-height: 830px){
    :root{
      --listMax: 80vh;

      --choiceMobileImgH: clamp(170px, 22vh, 230px);

      --matchRowH: clamp(150px, 20vh, 200px);

      --ddCardH: clamp(86px, 11vh, 110px);
      --ddImg:   clamp(62px, 13vw, 86px);

      --orderRowH: clamp(90px, 11vh, 120px);
      --orderImg:  clamp(70px, 15vw, 96px);

      --clsItemImgH: clamp(100px, 14vh, 140px);
      --clsItemMinH: clamp(160px, 18vh, 220px);
      --clsCatMinH:  clamp(150px, 17vh, 210px);

      --canvasMax: 72vh;
      --toolsMin:  260px;

      --buildTileH: 60px;
      --buildTileMinW: 86px;
    }
  }

}


}

  </style>
</head>

<body>
<body dir="rtl">
  <div class="appWrap">
    <div class="stage">
      <div class="topBar">
        <div class="qHead">
          <button class="btnSound" id="btnSound" type="button" disabled>
            <i class="bi bi-volume-up-fill" aria-hidden="true"></i>
          </button>

          <div style="flex:1; min-width:0;">
            <h1 class="qTitle" id="qTitle">—</h1>
            <p class="qSub" id="qSub">—</p>

            <div class="topMeta" id="topMeta">
              <span class="pill" id="pillLesson">—</span>
              <span class="pill" id="pillProgress">0/0</span>
              <span class="pill" id="pillType">—</span>
            </div>
          </div>
        </div>
      </div>

      <!-- This is your actual app mount point -->
      <div class="stage" id="stage">جاري التحميل...</div>
    </div>
  </div>

  <!-- Center feedback popup -->
  <div class="fxOverlay" id="fxOverlay" role="status" aria-live="polite" aria-atomic="true">
    <div class="fxModal" id="fxModal">
      <div class="fxRow">
        <div class="fxIcon" id="fxIcon">—</div>
        <div style="min-width:0">
          <p class="fxTitle" id="fxTitle">—</p>
          <p class="fxMsg" id="fxMsg">—</p>
        </div>
      </div>
    </div>
  </div>

</body>

<script>
/* =========================================================
  SETTINGS
========================================================= */
const DATA_FILE = "sections-lessens.json"; // ensure this matches your real filename exactly
const urlParams = new URL(location.href).searchParams;

const levelId   = (urlParams.get("level")   || "preliminary").toLowerCase();
const sectionId = (urlParams.get("section") || "").toLowerCase();
const lessonId  = (urlParams.get("lesson")  || "").toLowerCase(); // ✅ make lesson lowercase too


const audio = new Audio();

/* =========================================================
  HELPERS (DOM + TEXT)
========================================================= */
const $stage = () => $("#stage");

const esc = (s) => String(s ?? "")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

const norm = (s) => String(s||"").replace(/\s+/g," ").trim();
const isTouch = () => matchMedia("(max-width: 900px)").matches || ("ontouchstart" in window);

function pickText(o){
  return String(o?.text ?? o?.label ?? o?.name ?? o?.letter ?? "").trim();
}
function visualSrc(o){
  return String(o?.imageUrl ?? "").trim() || "";
}

function setStageMode(mode){
  const st = document.getElementById("stage");
  if(!st) return;
  st.classList.toggle("stage--choice", mode === "choice");
}

/* Show audio icon ONLY when there is visible text (not image-only) */
function hasVisibleText(o){
  const t = pickText(o);
  return typeof t === "string" && t.trim().length > 0;
}

function hintFor(type){
  const touch = isTouch();
  return ({
    multiple_choice: "اختر الإجابة ثم اضغط (تحقق)",
    listen_choose:   "اضغط (اسمع) ثم اختر ثم (تحقق)",
    match:           "اختر من اليسار ثم من اليمين ثم (تحقق)",
    drag_drop:       touch ? "اختر العنصر ثم اضغط الهدف" : "اسحب وضع العنصر على الهدف",
    ordering:        touch ? "استخدم ⬆️⬇️ ثم (تحقق)" : "اسحب لترتيب العناصر ثم (تحقق)",
    classification:  touch ? "اختر عنصرًا ثم اضغط الفئة" : "اسحب كل عنصر للفئة ثم (تحقق)",
    coloring:        "لوّن داخل الشكل فقط ثم (تحقق)",
    build_construct: "اضغط القطع لتكوين الكلمة ثم (تحقق)",
    trace_write:     "اكتب فوق القالب ثم (تحقق)"
  })[type] || "اختر/حرّك ثم اضغط (تحقق)";
}

/* =========================================================
  POPUP (Centered Auto-hide) + FX + AUDIO
========================================================= */

/* Inject popup DOM + CSS (so you don't need to edit HTML/CSS) */
function ensurePopup(){
  if(document.getElementById("popOverlay")) return;

  const css = `
  .popOverlay{
    position:fixed; inset:0;
    display:none; place-items:center;
    background:rgba(15,23,42,.35);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index:9999;
    padding:16px;
  }
  .popOverlay.show{ display:grid; }
  .popCard{
    width:min(520px, 100%);
    border-radius:22px;
    border:1px solid rgba(15,23,42,.10);
    background:rgba(255,255,255,.96);
    box-shadow:0 22px 60px rgba(15,23,42,.22);
    padding:18px 18px 16px;
    transform: translateY(10px) scale(.98);
    opacity:0;
    transition: transform .22s ease, opacity .22s ease;
  }
  .popOverlay.show .popCard{ transform: translateY(0) scale(1); opacity:1; }
  .popTitle{
    font-weight:1000;
    font-size:clamp(18px, .6vw + 16px, 22px);
    margin:0 0 6px;
    line-height:1.2;
    text-align:center;
  }
  .popMsg{
    margin:0;
    color:rgba(15,23,42,.70);
    font-weight:900;
    line-height:1.7;
    text-align:center;
    font-size:var(--fs1);
  }
  .popIcon{
    width:56px; height:56px;
    border-radius:18px;
    display:grid; place-items:center;
    margin:0 auto 10px;
    font-size:30px;
    font-weight:1000;
    border:1px solid rgba(15,23,42,.10);
  }
  .popCard[data-kind="ok"]  .popIcon{ background: rgba(34,197,94,.12); }
  .popCard[data-kind="bad"] .popIcon{ background: rgba(239,68,68,.12); }
  `;

  const st = document.createElement("style");
  st.textContent = css;
  document.head.appendChild(st);

  const overlay = document.createElement("div");
  overlay.className = "popOverlay";
  overlay.id = "popOverlay";
  overlay.setAttribute("aria-live","polite");
  overlay.setAttribute("aria-atomic","true");
  overlay.innerHTML = `
    <div class="popCard" id="popCard" data-kind="ok" role="status">
      <div class="popIcon" id="popIcon">✅</div>
      <h3 class="popTitle" id="popTitle">—</h3>
      <p class="popMsg" id="popMsg">—</p>
    </div>
  `;
  document.body.appendChild(overlay);

  // Optional: click outside to hide (doesn't block your UX)
  overlay.addEventListener("pointerdown", (e)=>{
    if(e.target === overlay) hidePopup();
  });
}

let popTimer = null;

function showPopup({ kind="ok", title="—", msg="", ms=900 }){
  ensurePopup();
  clearTimeout(popTimer);

  const $ov = $("#popOverlay");
  const $card = $("#popCard");

  $card.attr("data-kind", kind);
  $("#popIcon").text(kind === "ok" ? "✅" : "❌");
  $("#popTitle").text(title);
  $("#popMsg").text(msg);

  $ov.addClass("show");

  popTimer = setTimeout(() => {
    $ov.removeClass("show");
  }, ms);
}

function hidePopup(){
  clearTimeout(popTimer);
  $("#popOverlay").removeClass("show");
}

function burstStars(){
  const d = document.createElement("div");
  d.className = "starBurst";
  d.textContent = "⭐🎉⭐";
  document.body.appendChild(d);
  setTimeout(()=>d.remove(), 700);
}
function animCorrect($el){
  const el = ($el && $el[0]) ? $el[0] : $stage()[0];
  el.classList.add("correctPulse");
  burstStars();
  setTimeout(()=>el.classList.remove("correctPulse"), 650);
}
function animWrong($el){
  const el = ($el && $el[0]) ? $el[0] : $stage()[0];
  el.classList.add("wrongShake");
  setTimeout(()=>el.classList.remove("wrongShake"), 460);
}

function playSound(url){
  if(!url){
    showPopup({kind:"bad", title:"تنبيه", msg:"لا يوجد ملف صوت", ms:900});
    return;
  }
  audio.pause();
  audio.src = url;
  audio.currentTime = 0;
  audio.play().catch(()=>showPopup({kind:"bad", title:"تنبيه", msg:"تعذر تشغيل الصوت", ms:900}));
}

/* Unified feedback: centered popup + auto-hide (no close button) */
function feedback(ok, msg, $target){
  const fb = state.lesson?.interactive?.feedbackAudio || {};
  const snd = ok ? fb.correct : fb.wrong;
  if(snd) playSound(snd);

  ok ? animCorrect($target) : animWrong($target);

  if(ok){
    showPopup({
      kind: "ok",
      title: "صحيح",
      msg: msg || "إجابة صحيحة",
      ms: 850
    });
  }else{
    showPopup({
      kind: "bad",
      title: "خطأ",
      msg: (msg || "جرّب مرة أخرى") + " — من فضلك حاول مرة أخرى",
      ms: 900
    });
  }
}

/* =========================================================
  TOP BAR
========================================================= */
function setTop({title, sub, lesson, progress, type, audioUrl}){
  $("#qTitle").text(title || "سؤال");
  $("#qSub").text(sub || "");
  $("#pillLesson").text(lesson || "—");
  $("#pillProgress").text(progress || "—");
  $("#pillType").text(type || "—");

  const $btn = $("#btnSound");
  $btn.prop("disabled", !audioUrl);
  $btn.off("click").on("click", () => playSound(audioUrl));
}

/* =========================================================
  FOOTER CONTROLS (shared)
========================================================= */
function footerControls(){
  return `
    <div class="footerControls" id="footerControls">
      <button class="btnKid btnPrimary" id="btnCheck" type="button">✅ تحقق</button>
      <button class="btnKid btnSecondary" id="btnTry" type="button">🔁 حاول مرة أخرى</button>
      <button class="btnKid btnSecondary" id="btnBack" type="button">⬅️ رجوع</button>
    </div>
  `;
}
function wireFooter(){
  $("#btnCheck").off("click").on("click", ()=>validate());
  $("#btnTry").off("click").on("click", ()=>{ resetQ(); render(); });
  $("#btnBack").off("click").on("click", ()=>history.back());

  // If your old toast close button still exists, we neutralize it:
  $("#toastClose").off("click").on("click", ()=>{ /* no-op */ });
}

/* =========================================================
  CANVAS UTIL (paint/trace)
========================================================= */
function canvasPos(canvas, clientX, clientY){
  const r = canvas.getBoundingClientRect();
  const x = (clientX - r.left) * (canvas.width / r.width);
  const y = (clientY - r.top)  * (canvas.height / r.height);
  return {x, y};
}

function applyStrokeStyle(ctx, st){
  ctx.globalAlpha = st.opacity ?? 1;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.strokeStyle = st.color ?? "#111827";
  ctx.lineWidth = st.size ?? 10;
  ctx.globalCompositeOperation = st.composite ?? "source-over";
}

/* HARD CLIP DRAWING TO MASK (prevents painting outside) */
function applyMaskToDrawing(drawCtx, maskCtx){
  const w = drawCtx.canvas.width, h = drawCtx.canvas.height;
  const drawImg = drawCtx.getImageData(0,0,w,h);
  const maskImg = maskCtx.getImageData(0,0,w,h);

  const d = drawImg.data;
  const m = maskImg.data;

  for(let i=0; i<m.length; i+=4){
    const maskA = m[i+3];
    if(maskA <= 20){
      d[i+3] = 0;
    }
  }
  drawCtx.putImageData(drawImg,0,0);
}

function installPointerDraw({ canvas, ctx, getStrokeStyle, onStrokeStart, onDraw, onEnd }){
  let drawing = false;
  let last = null;

  function getPoint(e){ return canvasPos(canvas, e.clientX, e.clientY); }

  function start(e){
    e.preventDefault();
    drawing = true;
    const p = getPoint(e);
    last = p;

    const st = getStrokeStyle();
    ctx.save();
    applyStrokeStyle(ctx, st);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    ctx.lineTo(p.x + 0.01, p.y + 0.01);
    ctx.stroke();
    ctx.restore();

    onStrokeStart && onStrokeStart();
    onDraw && onDraw();
  }

  function move(e){
    if(!drawing) return;
    e.preventDefault();
    const p = getPoint(e);

    const st = getStrokeStyle();
    ctx.save();
    applyStrokeStyle(ctx, st);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    ctx.restore();

    last = p;
    onDraw && onDraw();
  }

  function end(e){
    if(!drawing) return;
    e.preventDefault();
    drawing = false;
    last = null;
    onEnd && onEnd();
  }

  canvas.addEventListener("pointerdown", start, {passive:false});
  canvas.addEventListener("pointermove", move, {passive:false});
  window.addEventListener("pointerup", end, {passive:false});
  window.addEventListener("pointercancel", end, {passive:false});
}

/* Layout helpers */
function fitChoiceCardsHard(){
  if(!matchMedia("(max-width: 520px)").matches) return;

  const app = document.querySelector(".app");
  const topBar = document.querySelector(".topBar");
  const stage = document.getElementById("stage");
  if(!stage || !stage.classList.contains("stage--choice")) return;

  const footer = document.getElementById("footerControls");
  if(!app || !topBar || !stage) return;

  const vh = window.visualViewport?.height || window.innerHeight;
  const appRect = app.getBoundingClientRect();
  const topRect = topBar.getBoundingClientRect();

  const availableStage = vh - (topRect.height) - (appRect.top);
  const stageH = Math.max(availableStage, 200);
  document.documentElement.style.setProperty("--stageH", stageH + "px");

  const grid = document.getElementById("choiceGrid");
  if(!grid) return;

  const footerH = footer ? footer.getBoundingClientRect().height : 0;
  const stageStyle = getComputedStyle(stage);
  const stagePadY = (parseFloat(stageStyle.paddingTop) || 0) + (parseFloat(stageStyle.paddingBottom) || 0);
  const gridArea = stageH - stagePadY - footerH - 10;

  const cards = [...grid.querySelectorAll(".choiceCard")];
  if(!cards.length) return;

  const gap = parseFloat(getComputedStyle(grid).rowGap) || 10;
  const fixedPerCard = 78;
  const totalFixed = (fixedPerCard * cards.length) + (gap * (cards.length - 1));
  const imgH = Math.floor((gridArea - totalFixed) / cards.length);

  const finalImgH = Math.max(70, Math.min(imgH, 160));
  document.documentElement.style.setProperty("--choiceMobileImgH", finalImgH + "px");
}

function fitStageToViewport(){
  if(!matchMedia("(max-width: 520px)").matches) return;

  const app = document.querySelector(".app");
  const topBar = document.querySelector(".topBar");
  const stage = document.getElementById("stage");
  if(!app || !topBar || !stage) return;

  const vh = window.visualViewport?.height || window.innerHeight;
  const appRect = app.getBoundingClientRect();
  const topRect = topBar.getBoundingClientRect();

  const availableStage = vh - topRect.height - appRect.top;
  const stageH = Math.max(availableStage, 240);
  document.documentElement.style.setProperty("--stageH", stageH + "px");
}

function countNonTransparentPixels(ctx){
  const {width, height} = ctx.canvas;
  const img = ctx.getImageData(0,0,width,height).data;
  let n = 0;
  for(let i=3; i<img.length; i+=4){
    if(img[i] > 20) n++;
  }
  return n;
}

function drawTemplateText(ctx, text){
  const cw = ctx.canvas.width, ch = ctx.canvas.height;
  ctx.save();
  ctx.clearRect(0,0,cw,ch);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,cw,ch);

  ctx.fillStyle = "rgba(15,23,42,.55)";
  ctx.font = `900 ${Math.floor(Math.min(cw, ch) * 0.40)}px Tahoma, Arial, sans-serif`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.lineWidth = Math.max(6, Math.floor(Math.min(cw,ch)*0.02));
  ctx.setLineDash([2, 16]);
  ctx.strokeStyle = "rgba(15,23,42,.35)";
  ctx.strokeText(text, cw/2, ch/2);
  ctx.setLineDash([]);
  ctx.restore();
}

/* Coloring + SVG helpers */
function loadImg(url){
  return new Promise((resolve, reject)=>{
    if(!url) return reject(new Error("missing url"));
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>resolve(img);
    img.onerror = ()=>reject(new Error("image load failed: " + url));
    img.src = url;
  });
}

/* =========================================================
  RANDOMIZATION (SAFE — ID BASED)
========================================================= */
function shuffleArr(arr){
  const a = Array.isArray(arr) ? arr.slice() : [];
  for(let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

function randomizeQuestion(q){
  const Q = deepClone(q);
  switch(Q.type){
    case "multiple_choice":
    case "listen_choose":
      Q.choices = shuffleArr(Q.choices);
      break;
    case "match":
      Q.left  = shuffleArr(Q.left);
      Q.right = shuffleArr(Q.right);
      break;
    case "drag_drop":
      Q.draggable = shuffleArr(Q.draggable || Q.draggables);
      Q.targets   = shuffleArr(Q.targets || Q.dropZones);
      break;
    case "ordering":
      Q.tiles = shuffleArr(Q.tiles || Q.items);
      break;
    case "classification":
      Q.items      = shuffleArr(Q.items);
      Q.categories = shuffleArr(Q.categories);
      break;
    case "build_construct":
      Q.tiles = shuffleArr(Q.tiles);
      break;
  }
  return Q;
}

function randomizeInteractive(interactive){
  if(!interactive) return interactive;
  const out = deepClone(interactive);

  out.questionBank = shuffleArr(out.questionBank).map(randomizeQuestion);

  const newFlow = {};
  for(const [itemId, qIds] of Object.entries(out.flowByItem || {})){
    newFlow[itemId] = shuffleArr(qIds);
  }
  out.flowByItem = newFlow;

  return out;
}

function drawContain(ctx, img, pad=18){
  const cw = ctx.canvas.width, ch = ctx.canvas.height;
  const maxW = cw - pad*2, maxH = ch - pad*2;
  const s = Math.min(maxW / img.width, maxH / img.height);
  const w = img.width * s, h = img.height * s;
  const x = (cw - w)/2, y = (ch - h)/2;
  ctx.drawImage(img, x, y, w, h);
}

async function drawSvgToCanvas(ctx, svgUrl, cw, ch){
  const res = await fetch(svgUrl, {cache:"no-store"});
  if(!res.ok) throw new Error("SVG fetch failed");
  const svgText = await res.text();
  const blob = new Blob([svgText], {type:"image/svg+xml"});
  const url = URL.createObjectURL(blob);
  try{
    const img = await loadImg(url);
    ctx.clearRect(0,0,cw,ch);
    ctx.fillStyle="#ffffff";
    ctx.fillRect(0,0,cw,ch);
    drawContain(ctx, img, 18);
  } finally {
    URL.revokeObjectURL(url);
  }
}

function coverageFromMask(drawCtx, maskCtx){
  const w = drawCtx.canvas.width, h = drawCtx.canvas.height;
  const draw = drawCtx.getImageData(0,0,w,h).data;
  const mask = maskCtx.getImageData(0,0,w,h).data;

  let allowed = 0;
  let paintedInside = 0;

  for(let i=0; i<mask.length; i+=4){
    const maskA = mask[i+3];
    if(maskA > 20){
      allowed++;
      const drawA = draw[i+3];
      if(drawA > 20) paintedInside++;
    }
  }
  return allowed ? (paintedInside / allowed) : 0;
}

/* =========================================================
  DATA + FLOW
========================================================= */
const state = {
  data:null, level:null, section:null, lesson:null,
  flow:[], idx:0,
  q:{},
  dragId:"",
  selectedForTap:null,
  paint:null,
  trace:null,
  validated:false
};

function findBy(arr, key, val){
  return (Array.isArray(arr)?arr:[])
    .find(x => String(x?.[key]||"").toLowerCase() === String(val||"").toLowerCase()) || null;
}
function findLesson(level, section, lesson){
  const sec = findBy(level?.sections, "sectionId", section);
  if(!sec) return {sec:null, les:null};

  const les = (Array.isArray(sec.lessons)?sec.lessons:[])
    .find(L => String(L.lessonId||"").toLowerCase() === String(lesson||"").toLowerCase()) || null;

  return {sec, les};
}


function buildFlowAllQuestions(lesson){
  const bank = Array.isArray(lesson?.interactive?.questionBank)
    ? lesson.interactive.questionBank
    : [];

  // Each entry matches what your render/resolveQuestion expects: { itemId, qId, q }
  return bank.map(q => ({
    itemId: q.itemId ?? q.forItemId ?? "", // optional; safe if your questions include item binding
    qId: q.id,
    q
  }));
}


/* ===== Per-item question resolving ===== */
function getItemById(itemId){
  return (state.lesson?.items || []).find(it => String(it.itemId) === String(itemId)) || null;
}

function resolveQuestion(entry){
  const q = entry?.q || {};
  const item = getItemById(entry.itemId);
  const itemText = String(item?.front?.text || item?.back?.title || "").trim();

  const out = JSON.parse(JSON.stringify(q));
  out.prompt = out.prompt || {};

  if(String(out.prompt.text || "").includes("{item}")){
    out.prompt.text = String(out.prompt.text).replaceAll("{item}", itemText);
  }

  if(!out.prompt.imageUrl && item?.front?.imageUrl) out.prompt.imageUrl = item.front.imageUrl;
  if(!out.prompt.audioUrl && item?.front?.audioUrl) out.prompt.audioUrl = item.front.audioUrl;

  if(out.type === "trace_write"){
    if(!out.prompt.text) out.prompt.text = itemText ? `اكتب كلمة: ${itemText}` : "اكتب";
    out.trace = out.trace || {};
    if(!out.trace.text) out.trace.text = itemText || out.traceText || out.letter || "ا";
  }

  if(out.type === "build_construct"){
    out.answer = out.answer || {};
    if(!out.answer.text && itemText) out.answer.text = itemText;
  }

  return out;
}

/* =========================================================
  GLOBAL DND (bind once)
========================================================= */
$(document).on("dragstart", "[data-dragid],[data-orderid]", function(e){
  state.dragId = $(this).attr("data-dragid") || $(this).attr("data-orderid") || "";
  $(this).addClass("dragging");
  try{ e.originalEvent.dataTransfer.setData("text/plain", state.dragId); }catch(_){}
});
$(document).on("dragend", "[data-dragid],[data-orderid]", function(){
  $(this).removeClass("dragging");
  state.dragId = "";
});
$(document).on("dragover", "[data-dropid],[data-orderid]", function(e){ e.preventDefault(); });
$(document).on("dragenter", "[data-dropid]", function(){ $(this).attr("data-active","1"); });
$(document).on("dragleave", "[data-dropid]", function(e){
  if(this.contains(e.relatedTarget)) return;
  $(this).attr("data-active","0");
});

/* =========================================================
  RENDER CORE
========================================================= */
function resetQ(){
  state.q = {};
  state.selectedForTap = null;
  state.paint = null;
  state.trace = null;
  state.validated = false;
}

function curEntry(){ return state.flow[state.idx]; }
function progressText(){ return `${Math.min(state.idx+1, state.flow.length)}/${state.flow.length}`; }

function nextQ(){
  hidePopup();
  if(state.idx < state.flow.length - 1){
    state.idx++; resetQ(); render();
    return;
  }
  setTop({
    title:"أحسنت! انتهيت 🎉",
    sub:"يمكنك الرجوع أو إعادة التشغيل",
    lesson: state.lesson?.title || "—",
    progress:`${state.flow.length}/${state.flow.length}`,
    type:"النهاية",
    audioUrl:""
  });
  $stage().html(`
    <div class="panelKid text-center">
      <div style="font-size:clamp(28px, 2vw + 18px, 44px); font-weight:1000">🏁</div>
      <div class="mt-2" style="font-size:var(--fs2); font-weight:1000;">تم إنهاء جميع الأسئلة لهذا الدرس.</div>
      <div class="mt-2" style="color:rgba(15,23,42,.62); font-weight:900; line-height:1.7;">
        يمكنك الرجوع أو إعادة التشغيل من البداية.
      </div>
      <div class="d-flex gap-2 justify-content-center flex-wrap mt-3">
        <button class="btnKid btnSecondary px-3" id="doneBack" type="button">⬅️ رجوع</button>
        <button class="btnKid btnPrimary px-3" id="doneRestart" type="button">🔄 إعادة من البداية</button>
      </div>
    </div>
  `);
  $("#doneBack").on("click", ()=>history.back());
  $("#doneRestart").on("click", ()=>{ state.idx=0; resetQ(); render(); });
}

/* =========================================================
  SMALL TEMPLATE HELPERS
========================================================= */
function soundIconBtn(audioUrl){
  const aud = String(audioUrl || "").trim();
  return aud
    ? `<button class="iconBtn" type="button" data-choice-audio="${esc(aud)}" aria-label="تشغيل الصوت">
         <i class="bi bi-volume-up-fill" aria-hidden="true"></i>
       </button>`
    : `<button class="iconBtn" type="button" disabled title="لا يوجد صوت" aria-label="لا يوجد صوت">
         <i class="bi bi-volume-mute-fill" aria-hidden="true"></i>
       </button>`;
}

function inlineAudioBtn(obj){
  if(!hasVisibleText(obj)) return "";
  const aud = String(obj?.audioUrl || "").trim();
  if(!aud) return "";
  return `
    <button class="iconBtn" type="button" data-audio="${esc(aud)}" aria-label="تشغيل الصوت">
      <i class="bi bi-volume-up-fill" aria-hidden="true"></i>
    </button>
  `;
}

function normalizeDragDrop(q){
  const drags = Array.isArray(q.draggable) ? q.draggable
             : Array.isArray(q.draggables) ? q.draggables
             : [];
  const drops = Array.isArray(q.targets) ? q.targets
             : Array.isArray(q.dropZones) ? q.dropZones
             : [];
  return { drags, drops };
}

/* =========================================================
  RENDERERS
========================================================= */

/* CHOICE (multiple_choice + listen_choose) */
function renderChoice(entry){
  const q = entry.q;
  const choices = Array.isArray(q.choices)?q.choices:[];
  state.q.selected ??= null;

  setTop({
    title: q?.prompt?.text || "سؤال",
    sub: hintFor(q.type),
    lesson: state.lesson?.title || "—",
    progress: progressText(),
    type: (q.type === "listen_choose") ? "استمع واختر" : "اختيار",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  $stage().html(`
    <div class="choiceGrid" id="choiceGrid">
      ${choices.map((c, i) => {
        const id  = String(c.id ?? i);
        const img = visualSrc(c);
        const txt = pickText(c);
        const showMic = hasVisibleText(c) && String(c.audioUrl||"").trim().length>0;
        const micBtn = showMic ? soundIconBtn(c.audioUrl) : "";

        const isSel = (state.q.selected === id);

        return `
          <div class="cardBtn choiceCard ${isSel ? "selSingle" : ""} ${state.validated ? "pe-none" : ""}"
               role="button" tabindex="0"
               data-choice="${esc(id)}"
               data-selected="${isSel ? "1":"0"}">

            <div class="choiceImgWrap">
              ${ img
                ? `<img class="choiceImg" src="${esc(img)}" alt=""/>`
                : `<div class="choiceNoImg"><span class="pill">بدون صورة</span></div>`
              }

              <div class="choiceMetaMobile">
                <div class="choiceNameMobile">${esc(txt || "—")}</div>
                ${micBtn}
              </div>
            </div>

            <div class="choiceMetaDesktop">
              <div class="choiceNameDesktop">${esc(txt || "—")}</div>
              ${micBtn}
            </div>

          </div>
        `;
      }).join("")}
    </div>

    ${footerControls()}
  `);

  fitChoiceCardsHard();
  $(window).off("resize.fitChoice").on("resize.fitChoice", ()=>fitChoiceCardsHard());

  $stage()
    .off("click.choice").on("click.choice", "[data-choice]", function(e){
      if(state.validated) return;
      if($(e.target).is("[data-choice-audio]")) return;
      state.q.selected = $(this).attr("data-choice");
      render();
    })
    .off("click.choiceAudio").on("click.choiceAudio", "[data-choice-audio]", function(e){
      e.stopPropagation();
      playSound($(this).attr("data-choice-audio"));
    });

  wireFooter();
}

/* MATCH (pairs) — persistent link visuals */
function renderMatch(entry){
  const q = entry.q;
  const left  = Array.isArray(q.left)?q.left:[];
  const right = Array.isArray(q.right)?q.right:[];
  state.q.leftPick ??= null;     // armed left
  state.q.pairs ??= {};          // leftId -> rightId

  setTop({
    title: q?.prompt?.text || "طابق",
    sub: hintFor("match"),
    lesson: state.lesson?.title || "—",
    progress: progressText(),
    type: `مطابقة (${Object.keys(state.q.pairs).length}/${left.length})`,
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const rows = Math.max(left.length, right.length);

  // RightId -> pairNumber (based on left order)
  const rightBadge = {};
  left.forEach((l, idx) => {
    const rid = state.q.pairs?.[String(l.id)];
    if(rid) rightBadge[String(rid)] = idx + 1;
  });

  // Helper: is right used?
  const usedRightSet = new Set(Object.values(state.q.pairs || {}).map(String));

  $stage().html(`
    <div class="panelKid panelFlex">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <p class="panelTitle m-0">المطابقة <small>اختر يسار ثم يمين</small></p>

        <div class="d-flex align-items-center gap-2">
          <button class="btnKid btnSecondary px-3" id="matchClear" type="button" ${state.validated ? "disabled" : ""}>مسح</button>
          <span class="pill">التحديد يبقى حتى (تحقق)</span>
        </div>
      </div>

      <div class="pairGrid panelBodyGrow mt-2" id="pairGrid">
        ${Array.from({length: rows}).map((_, i) => {
          const l = left[i] || null;
          const r = right[i] || null;

          const lHtml = l ? (() => {
            const lId = String(l.id);
            const pairedRid = state.q.pairs?.[lId] ? String(state.q.pairs[lId]) : "";
            const isArmed  = state.q.leftPick === lId;
            const isPaired = Boolean(pairedRid);

            const img = visualSrc(l);
            const txt = pickText(l);
            const audioHtml = inlineAudioBtn(l);

            return `
              <div class="cardBtn fxRel ${isArmed ? "matchArmed" : ""} ${isPaired ? "matchPaired" : ""} ${state.validated ? "pe-none" : ""}"
                   role="button" tabindex="0"
                   data-left="${esc(lId)}">

                ${isPaired ? `<div class="fxBadge" title="زوج رقم ${i+1}">${i+1}</div>` : ``}

                <div class="cardLeft">
                  ${img
                    ? `<img class="matchLeftImg" src="${esc(img)}" alt=""/>`
                    : `<div class="cardText">${esc(txt || "—")}</div>`
                  }
                </div>

                ${audioHtml ? `<div class="cardSide">${audioHtml}</div>` : ``}
              </div>
            `;
          })() : `<div></div>`;

          const rHtml = r ? (() => {
            const rId = String(r.id);
            const isUsed = usedRightSet.has(rId);
            const badgeNo = rightBadge[rId] || "";

            const txt = pickText(r);
            const audioHtml = inlineAudioBtn(r);

            return `
              <div class="cardBtn fxRel ${isUsed ? "matchPaired" : ""} ${state.validated ? "pe-none" : ""}"
                   role="button" tabindex="0"
                   data-right="${esc(rId)}">

                ${badgeNo ? `<div class="fxBadge" title="مرتبط بزوج رقم ${badgeNo}">${badgeNo}</div>` : ``}

                <div class="cardLeft">
                  <div class="cardText">${esc(txt || "—")}</div>
                </div>

                ${audioHtml ? `<div class="cardSide">${audioHtml}</div>` : ``}
              </div>
            `;
          })() : `<div></div>`;

          return `<div class="pairRow">${lHtml}${rHtml}</div>`;
        }).join("")}
      </div>
    </div>

    ${footerControls()}
  `);

  $stage()
    .off("click.matchAudio").on("click.matchAudio", "[data-audio]", function(e){
      e.stopPropagation();
      playSound($(this).attr("data-audio"));
    })
    .off("click.matchL").on("click.matchL", "[data-left]", function(){
      if(state.validated) return;
      const lid = $(this).attr("data-left");
      state.q.leftPick = (state.q.leftPick === lid) ? null : lid;
      render();
    })
    .off("click.matchR").on("click.matchR", "[data-right]", function(){
      if(state.validated) return;
      const rid = $(this).attr("data-right");
      const lid = state.q.leftPick;

      if(!lid){
        feedback(false, "اختر عنصرًا من اليسار أولًا", $stage());
        return;
      }

      state.q.pairs = state.q.pairs || {};

      // enforce unique right: if another left used this right, remove it
      for(const [L, R] of Object.entries(state.q.pairs)){
        if(String(R) === String(rid) && String(L) !== String(lid)){
          delete state.q.pairs[L];
        }
      }

      state.q.pairs[String(lid)] = String(rid);
      state.q.leftPick = null;
      render();
    })
    .off("click.matchClear").on("click.matchClear", "#matchClear", function(){
      if(state.validated) return;
      state.q.leftPick = null;
      state.q.pairs = {};
      render();
    });

  wireFooter();
}

/* DRAG & DROP */
function renderDragDrop(entry){
  const q = entry.q;
  const { drags, drops } = normalizeDragDrop(q);
  state.q.assign ??= {};

  setTop({
    title: q?.prompt?.text || "اسحب وضع",
    sub: hintFor("drag_drop"),
    lesson: state.lesson?.title || "—",
    progress: progressText(),
    type: "سحب وإفلات",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const leftHtml = drags.map(d => {
    const used = Object.values(state.q.assign).includes(String(d.id));
    const img = visualSrc(d);
    const txt = pickText(d);
    const audioHtml = inlineAudioBtn(d);

    const isPicked = isTouch() && String(state.selectedForTap) === String(d.id);

    return `
      <div class="cardBtn dragItem ${isPicked ? "selSingle" : ""} ${state.validated ? "pe-none" : ""}"
           role="button" tabindex="0"
        ${isTouch() ? "" : `draggable="true"`}
        data-dragid="${esc(d.id)}"
        style="${used ? "opacity:.55" : ""}">
        <div class="cardLeft">
          ${img ? `<img class="cardImg" src="${esc(img)}" alt=""/>` : ``}
          <div class="cardText">${esc(txt || "—")}</div>
        </div>
        ${audioHtml ? `<div class="cardSide">${audioHtml}</div>` : ``}
      </div>
    `;
  }).join("");

  const rightHtml = drops.map(z => {
    const tid = String(z.id);
    const fillId = state.q.assign[tid] || "";
    const fillObj = drags.find(d => String(d.id) === String(fillId));
    const fillText = fillObj ? pickText(fillObj) : (isTouch() ? "اضغط لاختيار" : "اسحب هنا");

    const img = visualSrc(z);
    const label = String(z.label ?? pickText(z) ?? "").trim();

    return `
      <div class="dropZone ${state.validated ? "pe-none" : ""}" data-dropid="${esc(tid)}" data-active="0">
        <div class="d-flex align-items-center gap-2 min-w-0" style="min-width:0">
          ${img ? `<img class="cardImg" src="${esc(img)}" alt=""/>` : ``}
          <div style="font-weight:1000; font-size:var(--fs1); overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            ${esc(label || "—")}
          </div>
        </div>
        <div class="zoneFill">${esc(fillText || "—")}</div>
      </div>
    `;
  }).join("");

  $stage().html(`
    <div class="twoColGrid">
      <div class="panelKid panelFlex">
        <p class="panelTitle">العناصر <small>${isTouch() ? "اضغط للاختيار" : "اسحب"}</small></p>
        <div class="vList panelBodyGrow" id="ddLeft">${leftHtml}</div>
        ${isTouch() ? `<div class="mt-2"><span class="pill">المختار: <span id="tapPick">—</span></span></div>` : ``}
      </div>

      <div class="panelKid panelFlex">
        <p class="panelTitle">الأهداف <small>${isTouch() ? "اضغط الهدف لوضع المختار" : "إفلات"}</small></p>
        <div class="vList panelBodyGrow" id="ddRight">${rightHtml}</div>
        <div class="d-flex gap-2 flex-wrap mt-3">
          <button class="btnKid btnSecondary px-3" id="ddClear" type="button" ${state.validated ? "disabled" : ""}>مسح</button>
        </div>
      </div>
    </div>

    ${footerControls()}
  `);

  if(isTouch()){
    const name = state.selectedForTap
      ? pickText(drags.find(d=>String(d.id)===String(state.selectedForTap))||{})
      : "—";
    $("#tapPick").text(name || "—");
  }

  $stage()
    .off("click.ddAudio").on("click.ddAudio", "[data-audio]", function(e){
      e.stopPropagation();
      playSound($(this).attr("data-audio"));
    })
    .off("drop.dd").on("drop.dd", "[data-dropid]", function(e){
      if(state.validated) return;
      e.preventDefault();
      $(this).attr("data-active","0");

      const targetId = $(this).attr("data-dropid");
      const dragId = state.dragId || (()=>{ try{return e.originalEvent.dataTransfer.getData("text/plain")}catch(_){return ""} })();
      if(!dragId || !targetId) return;

      state.q.assign = state.q.assign || {};
      state.q.assign[targetId] = String(dragId);
      render();
    })
    .off("click.ddtapDrag").on("click.ddtapDrag", "#ddLeft [data-dragid]", function(e){
      if(state.validated) return;
      if($(e.target).closest("[data-audio]").length) return;
      if(!isTouch()) return;
      state.selectedForTap = $(this).attr("data-dragid");
      render();
    })
    .off("click.ddtapDrop").on("click.ddtapDrop", "#ddRight [data-dropid]", function(){
      if(state.validated) return;
      if(!isTouch()) return;
      const targetId = $(this).attr("data-dropid");
      if(!state.selectedForTap){ feedback(false, "اختر عنصرًا أولًا", $stage()); return; }
      state.q.assign = state.q.assign || {};
      state.q.assign[targetId] = String(state.selectedForTap);
      state.selectedForTap = null;
      render();
    })
    .off("click.ddClear").on("click.ddClear", "#ddClear", function(){
      if(state.validated) return;
      state.q.assign = {}; state.selectedForTap=null; render();
    });

  wireFooter();
}

/* ORDERING */
function renderOrdering(entry){
  const q = entry.q;
  const items = Array.isArray(q.tiles) ? q.tiles
             : Array.isArray(q.items) ? q.items
             : [];
  state.q.order ??= items.map(x => String(x.id));

  setTop({
    title: q?.prompt?.text || "رتّب",
    sub: hintFor("ordering"),
    lesson: state.lesson?.title || "—",
    progress: progressText(),
    type: "ترتيب",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const byId = new Map(items.map(it => [String(it.id), it]));
  const rows = state.q.order.map((id, idx) => {
    const it = byId.get(String(id)) || {};
    const img = visualSrc(it);
    const txt = pickText(it);
    const audioHtml = inlineAudioBtn(it);

    return `
      <div class="cardBtn ${isTouch() ? "" : "dragItem"} ${state.validated ? "pe-none" : ""}"
           ${isTouch() ? "" : `draggable="true"`}
           data-orderid="${esc(id)}" data-index="${idx}">
        <div class="cardLeft">
          <div class="orderIdx">${idx+1}</div>
          ${img ? `<img class="cardImg" src="${esc(img)}" alt=""/>` : ``}
          <div class="cardText">${esc(txt || "—")}</div>
        </div>

        <div class="d-flex gap-2 align-items-center">
          ${audioHtml ? `<div class="cardSide">${audioHtml}</div>` : ``}

          ${isTouch() ? `
            <button class="iconBtn" type="button" data-move="up" ${idx===0 || state.validated ? "disabled":""}>⬆️</button>
            <button class="iconBtn" type="button" data-move="down" ${idx===state.q.order.length-1 || state.validated ? "disabled":""}>⬇️</button>
          ` : `<span class="pill">↕️</span>`}
        </div>
      </div>
    `;
  }).join("");

  $stage().html(`
    <div class="panelKid panelFlex">
      <p class="panelTitle">رتّب العناصر <small>${isTouch() ? "بالأسهم" : "اسحب لأعلى/أسفل"}</small></p>
      <div class="vList panelBodyGrow" id="orderList">${rows}</div>
    </div>

    ${footerControls()}
  `);

  $stage()
    .off("click.orderAudio").on("click.orderAudio", "[data-audio]", function(e){
      e.stopPropagation();
      playSound($(this).attr("data-audio"));
    })
    .off("click.orderMove").on("click.orderMove", "[data-move]", function(e){
      if(state.validated) return;
      e.stopPropagation();
      const dir = $(this).attr("data-move");
      const $row = $(this).closest("[data-orderid]");
      const idx = Number($row.attr("data-index"));
      const arr = (state.q.order || []).slice();
      const swapWith = dir === "up" ? idx-1 : idx+1;
      if(swapWith < 0 || swapWith >= arr.length) return;
      [arr[idx], arr[swapWith]] = [arr[swapWith], arr[idx]];
      state.q.order = arr;
      render();
    })
    .off("drop.order").on("drop.order", "[data-orderid]", function(e){
      if(state.validated) return;
      e.preventDefault();
      if(isTouch()) return;

      const targetId = $(this).attr("data-orderid");
      const dragId = state.dragId;
      if(!dragId || !targetId || dragId === targetId) return;

      const arr = (state.q.order || []).slice();
      const from = arr.indexOf(String(dragId));
      const to   = arr.indexOf(String(targetId));
      if(from < 0 || to < 0) return;
      arr.splice(to, 0, arr.splice(from, 1)[0]);
      state.q.order = arr;
      render();
    });

  wireFooter();
}

/* CLASSIFICATION */
function renderClassification(entry){
  const q = entry.q;
  const items = Array.isArray(q.items)?q.items:[];
  const cats  = Array.isArray(q.categories)?q.categories:[];
  state.q.catAssign ??= {};

  setTop({
    title: q?.prompt?.text || "صنّف",
    sub: hintFor("classification"),
    lesson: state.lesson?.title || "—",
    progress: progressText(),
    type: "تصنيف",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const itemsHtml = items.map(it => {
    const used = !!state.q.catAssign[String(it.id)];
    const img = visualSrc(it);
    const txt = pickText(it);
    const audioHtml = inlineAudioBtn(it);

    const isPicked = isTouch() && String(state.selectedForTap) === String(it.id);

    return `
      <div class="cardBtn dragItem ${isPicked ? "selSingle" : ""} ${state.validated ? "pe-none" : ""}"
           role="button" tabindex="0"
        ${isTouch() ? "" : `draggable="true"`}
        data-dragid="${esc(it.id)}"
        style="${used ? "opacity:.55" : ""}">
        <div class="cardLeft">
          ${img ? `<img class="cardImg" src="${esc(img)}" alt=""/>` : ``}

          <div class="clsTitleRow">
            ${txt ? `<div class="cardText">${esc(txt)}</div>` : ``}
            ${audioHtml ? `<div class="cardSide">${audioHtml}</div>` : ``}
          </div>
        </div>
      </div>
    `;
  }).join("");

  const catsHtml = cats.map(c => {
    const label = String(c.label ?? c.name ?? c.text ?? "");
    const assigned = items
      .filter(it => String(state.q.catAssign[String(it.id)]||"") === String(c.id))
      .map(it => ({ id: String(it.id), text: pickText(it) }))
      .filter(x => x.text);

    return `
      <div class="dropZone ${state.validated ? "pe-none" : ""}" data-dropid="${esc(c.id)}" data-active="0"
           style="flex-direction:column; align-items:stretch;">
        <div class="d-flex align-items-center justify-content-between gap-2">
          <div style="font-weight:1000; font-size:var(--fs1);">${esc(label || "فئة")}</div>
          <span class="pill">${assigned.length} عنصر</span>
        </div>

        <div class="mt-2" style="display:flex; gap:8px; flex-wrap:wrap;">
          ${
            assigned.length
              ? assigned.map(a => `
                  <span class="clsChip">
                    <span>${esc(a.text)}</span>
                    <button type="button" class="clsX"
                            title="حذف" aria-label="حذف"
                            ${state.validated ? "disabled" : ""}
                            data-unassign="${esc(a.id)}">×</button>
                  </span>
                `).join("")
              : `<span class="pill">ضع العناصر هنا</span>`
          }
        </div>
      </div>
    `;
  }).join("");

  $stage().html(`
    <div class="twoColGrid">
      <div class="panelKid panelFlex">
        <p class="panelTitle">العناصر <small>${isTouch() ? "اضغط للاختيار" : "اسحب"}</small></p>
        <div class="panelBodyGrow" id="clsItems" style="display:flex; flex-direction:column; gap: var(--gap);">${itemsHtml}</div>
        ${isTouch() ? `<div class="mt-2"><span class="pill">المختار: <span id="clsPick">—</span></span></div>` : ``}
      </div>

      <div class="panelKid panelFlex">
        <p class="panelTitle">الفئات <small>${isTouch() ? "اضغط الفئة لوضع المختار" : "إفلات"}</small></p>
        <div class="panelBodyGrow vList" id="clsCats">${catsHtml}</div>
      </div>
    </div>

    ${footerControls()}
  `);

  if(isTouch()){
    const name = state.selectedForTap ? pickText(items.find(d=>String(d.id)===String(state.selectedForTap))||{}) : "—";
    $("#clsPick").text(name || "—");
  }

  $stage()
    .off("click.clsAudio").on("click.clsAudio", "[data-audio]", function(e){
      e.stopPropagation();
      playSound($(this).attr("data-audio"));
    })
    .off("drop.cls").on("drop.cls", "#clsCats [data-dropid]", function(e){
      if(state.validated) return;
      e.preventDefault();
      $(this).attr("data-active","0");
      const catId = $(this).attr("data-dropid");
      const itemId = state.dragId;
      if(!catId || !itemId) return;
      state.q.catAssign = state.q.catAssign || {};
      state.q.catAssign[String(itemId)] = String(catId);
      render();
    })
    .off("click.clsPick").on("click.clsPick", "#clsItems [data-dragid]", function(e){
      if(state.validated) return;
      if($(e.target).closest("[data-audio]").length) return;
      if(!isTouch()) return;
      state.selectedForTap = $(this).attr("data-dragid");
      render();
    })
    .off("click.clsCat").on("click.clsCat", "#clsCats [data-dropid]", function(e){
      if(state.validated) return;
      if(!isTouch()) return;
      if($(e.target).closest("[data-unassign]").length) return;
      const catId = $(this).attr("data-dropid");
      if(!state.selectedForTap){ feedback(false, "اختر عنصرًا أولًا", $stage()); return; }
      state.q.catAssign = state.q.catAssign || {};
      state.q.catAssign[String(state.selectedForTap)] = String(catId);
      state.selectedForTap = null;
      render();
    })
    .off("click.clsRemove").on("click.clsRemove", "[data-unassign]", function(e){
      if(state.validated) return;
      e.stopPropagation();
      const itemId = $(this).attr("data-unassign");
      if(!itemId) return;
      if(state.q.catAssign) delete state.q.catAssign[String(itemId)];
      render();
    });

  wireFooter();
}

/* BUILD */
function renderBuild(entry){
  const q = entry.q;
  const tiles = Array.isArray(q.tiles)?q.tiles:[];
  const target = norm(q?.answer?.text || "");

  state.q.built ??= [];
  const builtText = state.q.built
    .map(id => tiles.find(t => String(t.id)===String(id)))
    .filter(Boolean).map(t => pickText(t)).join("");

  setTop({
    title: q?.prompt?.text || "كوّن الكلمة",
    sub: hintFor("build_construct"),
    lesson: state.lesson?.title || "—",
    progress: progressText(),
    type: "تكوين",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const slotCount = Math.max(target.length || 0, state.q.built.length, 3);
  const slots = Array.from({length: slotCount}).map((_,i)=>`
    <div class="pill" style="min-width:56px; justify-content:center; font-size:var(--fs2); padding:10px 12px;">
      ${esc(builtText[i]||" ")}
    </div>
  `).join("");

  $stage().html(`
    <div class="panelKid" id="buildWrap">
      <p class="panelTitle">كلمة التكوين <small>كوّن الكلمة المطلوبة</small></p>

      <div class="d-flex gap-2 flex-wrap justify-content-center p-3"
           style="border-radius:22px;border:1px solid rgba(15,23,42,.10);background:rgba(255,255,255,.98);box-shadow:0 8px 14px rgba(15,23,42,.06);">
        ${slots}
      </div>

      <div class="d-flex gap-2 flex-wrap justify-content-center mt-3">
        <button class="btnKid btnSecondary px-3" id="buildBack" type="button" ${state.validated ? "disabled" : ""}>حذف</button>
        <button class="btnKid btnSecondary px-3" id="buildClear" type="button" ${state.validated ? "disabled" : ""}>مسح</button>
        <span class="pill">الناتج: <b>${esc(builtText||"—")}</b></span>
      </div>

      <div class="d-flex gap-2 flex-wrap justify-content-center mt-3" id="tiles">
        ${tiles.map(t => `
          <button class="btnKid btnSecondary ${state.validated ? "pe-none" : ""}" style="height:48px; min-width:64px;" type="button" data-tile="${esc(t.id)}">
            ${esc(pickText(t) || t.id)}
          </button>
        `).join("")}
      </div>

      <div class="mt-3 text-center" style="color:rgba(15,23,42,.62);font-weight:900;line-height:1.7;">
        الهدف: <b>${esc(target || "—")}</b>
      </div>
    </div>

    ${footerControls()}
  `);

  $stage()
    .off("click.tile").on("click.tile", "[data-tile]", function(){
      if(state.validated) return;
      state.q.built = state.q.built || [];
      state.q.built.push($(this).attr("data-tile"));
      render();
    })
    .off("click.buildBack").on("click.buildBack", "#buildBack", function(){
      if(state.validated) return;
      state.q.built = state.q.built || [];
      state.q.built.pop();
      render();
    })
    .off("click.buildClear").on("click.buildClear", "#buildClear", function(){
      if(state.validated) return;
      state.q.built = [];
      render();
    });

  wireFooter();
}

/* COLORING */
async function renderColoring(entry){
  const q = entry.q;

  setTop({
    title: q?.prompt?.text || "تلوين",
    sub: hintFor("coloring"),
    lesson: state.lesson?.title || "—",
    progress: progressText(),
    type: "تلوين",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const cw = Number(q?.canvas?.width  || 900);
  const ch = Number(q?.canvas?.height || 520);

  const baseUrl = String(q?.canvas?.baseImageUrl || "").trim();
  const maskUrl = String(q?.canvas?.maskImageUrl || "").trim();
  const hintUrl = String(q?.canvas?.targetHintImageUrl || "").trim();

  const requiredCoverage = Number(q?.successCriteria?.coveragePercent ?? 0.6);

  const palette = Array.isArray(q?.palette) && q.palette.length ? q.palette : [
    "#111827","#ef4444","#f59e0b","#22c55e","#3b82f6","#a855f7","#ec4899","#06b6d4"
  ];
  const brushSizeDefault = Number(q?.brush?.size || 18);
  const brushOpacityDefault = Number(q?.brush?.opacity || 1);

  $stage().html(`
    <div class="grid2_1">
      <div class="panelKid">
        <p class="panelTitle">منطقة التلوين <small>${baseUrl ? "لوّن فوق الشكل" : "تلوين حر"}</small></p>
        <div style="position:relative;">
          <canvas class="paintCanvas" id="paintBase" width="${cw}" height="${ch}"
                  style="position:absolute; inset:0; z-index:1;"></canvas>

          <canvas class="paintCanvas" id="paintHintLayer" width="${cw}" height="${ch}"
                  style="position:absolute; inset:0; z-index:2; opacity:0; pointer-events:none;"></canvas>

          <canvas class="paintCanvas" id="paintDraw" width="${cw}" height="${ch}"
                  style="position:relative; z-index:3; background:transparent;"></canvas>
        </div>
      </div>

      <div class="panelKid">
        <p class="panelTitle">أدوات <small>اختر لونًا وحجمًا</small></p>

        <div class="d-flex gap-2 flex-wrap" id="paintPalette"></div>

        <div class="mt-3">
          <div class="paintSizeRow">
            <span class="pill paintSizeLabel">حجم الفرشاة</span>
            <span class="pill paintSizeVal" id="paintSizeVal">—</span>

            <input class="form-range paintSizeRange"
              id="paintSize"
              type="range"
              min="6"
              max="52"
              step="1"
              value="${brushSizeDefault}"
              ${state.validated ? "disabled" : ""}>
          </div>

          <div class="mt-3">
            <div class="paintOpacityRow">
              <span class="pill paintOpacityLabel">الشفافية</span>
              <span class="pill paintOpacityVal" id="paintOpacityVal">—</span>

              <input class="form-range paintOpacityRange"
                id="paintOpacity"
                type="range"
                min="0.2"
                max="1"
                step="0.05"
                value="${brushOpacityDefault}"
                ${state.validated ? "disabled" : ""}>
            </div>
          </div>

          <div class="d-flex gap-2 flex-wrap mt-3">
            <button class="btnKid btnSecondary px-3" id="paintUndo" type="button" ${state.validated ? "disabled" : ""}>تراجع</button>
            <button class="btnKid btnSecondary px-3" id="paintClear" type="button" ${state.validated ? "disabled" : ""}>مسح</button>
            <button class="btnKid btnSecondary px-3" id="paintHint" type="button" ${hintUrl && !state.validated ? "" : "disabled"}>تلميح</button>
          </div>

          <div class="mt-3">
            <div class="pill"
                 style="display:flex;justify-content:space-between;align-items:center;gap:12px;font-weight:900;">
              <span>الإنجاز: <b><span id="colorPct">0</span>%</b></span>
              <span>شرط النجاح: <b>${Math.round(requiredCoverage*100)}%</b></span>
            </div>
          </div>

          ${footerControls()}
        </div>
      </div>
    </div>
  `);

  wireFooter();

  $("#paintPalette").html(
    palette.map((c,i)=>`
      <div class="swatch ${state.validated ? "pe-none" : ""}" data-color="${esc(c)}" data-selected="${i===0?"1":"0"}" style="background:${esc(c)}"></div>
    `).join("")
  );

  const baseCanvas = $("#paintBase")[0];
  const hintCanvas = $("#paintHintLayer")[0];
  const drawCanvas = $("#paintDraw")[0];

  const bctx = baseCanvas.getContext("2d", { willReadFrequently:true });
  const hctx = hintCanvas.getContext("2d", { willReadFrequently:true });
  const dctx = drawCanvas.getContext("2d", { willReadFrequently:true });

  const maskC = document.createElement("canvas");
  maskC.width = cw; maskC.height = ch;
  const mctx = maskC.getContext("2d", { willReadFrequently:true });

  bctx.clearRect(0,0,cw,ch);
  bctx.fillStyle = "#ffffff";
  bctx.fillRect(0,0,cw,ch);
  hctx.clearRect(0,0,cw,ch);
  dctx.clearRect(0,0,cw,ch);
  mctx.clearRect(0,0,cw,ch);

  try{ if(baseUrl){ const img = await loadImg(baseUrl); drawContain(bctx, img, 18); } }catch(_){}
  try{ if(hintUrl){ const img = await loadImg(hintUrl); drawContain(hctx, img, 18); } }catch(_){}

  try{
    if(maskUrl){
      const img = await loadImg(maskUrl);
      drawContain(mctx, img, 18);
    }else{
      mctx.fillStyle = "rgba(0,0,0,1)";
      mctx.fillRect(0,0,cw,ch);
    }
  }catch(_){
    mctx.clearRect(0,0,cw,ch);
    mctx.fillStyle = "rgba(0,0,0,1)";
    mctx.fillRect(0,0,cw,ch);
  }

  state.paint = {
    drawCtx: dctx,
    maskCtx: mctx,
    undo: [],
    size: brushSizeDefault,
    opacity: brushOpacityDefault,
    color: palette[0],
    requiredCoverage
  };

  function pushUndo(){
    applyMaskToDrawing(dctx, mctx);
    const img = dctx.getImageData(0,0,cw,ch);
    state.paint.undo.push(img);
    if(state.paint.undo.length > 20) state.paint.undo.shift();
  }
  pushUndo();

  function updateLabels(){
    $("#paintSizeVal").text(String(state.paint.size));
    $("#paintOpacityVal").text(String(state.paint.opacity));
  }
  updateLabels();

  function updateColorProgress(){
    if(!state.paint?.drawCtx || !state.paint?.maskCtx) return;
    applyMaskToDrawing(state.paint.drawCtx, state.paint.maskCtx);

    const pct = coverageFromMask(state.paint.drawCtx, state.paint.maskCtx);
    const percent = Math.min(100, Math.floor(pct * 100));
    $("#colorPct").text(String(percent));
  }
  updateColorProgress();

  $("#paintPalette").off("click").on("click", ".swatch", function(){
    if(state.validated) return;
    const c = $(this).attr("data-color");
    state.paint.color = c;
    $(".swatch").attr("data-selected","0");
    $(this).attr("data-selected","1");
  });

  $("#paintSize").off("input").on("input", function(){
    if(state.validated) return;
    state.paint.size = Number(this.value);
    updateLabels();
  });
  $("#paintOpacity").off("input").on("input", function(){
    if(state.validated) return;
    state.paint.opacity = Number(this.value);
    updateLabels();
  });

  $("#paintUndo").off("click").on("click", function(){
    if(state.validated) return;
    const u = state.paint.undo;
    if(u.length <= 1) return;
    u.pop();
    dctx.putImageData(u[u.length-1],0,0);
    updateColorProgress();
  });

  $("#paintClear").off("click").on("click", function(){
    if(state.validated) return;
    pushUndo();
    dctx.clearRect(0,0,cw,ch);
    applyMaskToDrawing(dctx, mctx);
    pushUndo();
    updateColorProgress();
  });

  $("#paintHint").off(".hint");
  $("#paintHint").on("pointerdown.hint", function(e){
    if(state.validated) return;
    if(!hintUrl) return;
    e.preventDefault();
    $("#paintHintLayer").css("opacity","0.85");
  });
  $(window).off(".hint");
  $(window).on("pointerup.hint pointercancel.hint", function(){
    $("#paintHintLayer").css("opacity","0");
  });

  if(!state.validated){
    installPointerDraw({
      canvas: drawCanvas,
      ctx: dctx,
      getStrokeStyle: () => ({
        color: state.paint.color,
        size: state.paint.size,
        opacity: state.paint.opacity,
        composite: "source-over"
      }),
      onStrokeStart: () => pushUndo(),
      onDraw: () => applyMaskToDrawing(dctx, mctx),
      onEnd: () => updateColorProgress()
    });
  }
}

/* TRACE */
async function renderTrace(entry){
  const q = entry.q;

  setTop({
    title: q?.prompt?.text || "كتابة",
    sub: hintFor("trace_write"),
    lesson: state.lesson?.title || "—",
    progress: progressText(),
    type: "كتابة وتتبع",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const cw = Number(q?.canvas?.width  || 900);
  const ch = Number(q?.canvas?.height || 520);

  const traceText = String(q?.trace?.text || q?.traceText || q?.letter || "").trim()
                 || String(q?.target?.text || "").trim()
                 || "ا";

  const svgUrl = String(q?.trace?.svgUrl || q?.target?.svgUrl || "").trim();

  let minInkPixels = Number(q?.minInkPixels || 0);
  const minInkPercent = Number(q?.successCriteria?.minInkPercent || 0);
  if(!minInkPixels && minInkPercent){
    minInkPixels = Math.floor((cw * ch) * minInkPercent);
  }
  if(!minInkPixels) minInkPixels = Math.floor((cw*ch) * 0.006);

  $stage().html(`
    <div class="grid2_1">
      <div class="panelKid">
        <p class="panelTitle">منطقة الكتابة <small>اكتب فوق القالب</small></p>
        <div style="position:relative;">
          <canvas class="traceCanvas" id="traceBase" width="${cw}" height="${ch}"
                  style="position:absolute; inset:0; z-index:1;"></canvas>
          <canvas class="traceCanvas" id="traceDraw" width="${cw}" height="${ch}"
                  style="position:relative; z-index:2; background:transparent;"></canvas>
        </div>
      </div>

      <div class="panelKid">
        <p class="panelTitle">أدوات</p>

        <div class="mt-3">
          <div class="d-flex align-items-center justify-content-between">
            <span class="pill">سمك القلم</span>
            <span class="pill" id="traceSizeVal">—</span>
          </div>
          <input class="form-range mt-2" id="traceSize" type="range" min="6" max="44" step="1" value="18" ${state.validated ? "disabled" : ""}>
        </div>

        <div class="d-flex gap-2 flex-wrap mt-3">
          <button class="btnKid btnSecondary px-3" id="traceUndo" type="button" ${state.validated ? "disabled" : ""}>تراجع</button>
          <button class="btnKid btnSecondary px-3" id="traceClear" type="button" ${state.validated ? "disabled" : ""}>مسح</button>
        </div>

        <div class="mt-3" style="color:rgba(15,23,42,.62);font-weight:900;line-height:1.7;">
          شرط التحقق: وجود كتابة كافية على اللوحة.
        </div>

        ${footerControls()}
      </div>
    </div>
  `);

  wireFooter();

  const base = $("#traceBase")[0];
  const draw = $("#traceDraw")[0];

  const bctx = base.getContext("2d", { willReadFrequently:true });
  const dctx = draw.getContext("2d", { willReadFrequently:true });

  bctx.clearRect(0,0,cw,ch);
  bctx.fillStyle = "#ffffff";
  bctx.fillRect(0,0,cw,ch);

  try{
    if(svgUrl){
      await drawSvgToCanvas(bctx, svgUrl, cw, ch);
    }else{
      drawTemplateText(bctx, traceText);
    }
  }catch(_){
    drawTemplateText(bctx, traceText);
  }

  dctx.clearRect(0,0,draw.width, draw.height);

  state.trace = {
    drawCtx: dctx,
    undo: [],
    minInkPixels,
    size: 18
  };

  function pushUndo(){
    const img = dctx.getImageData(0,0,draw.width, draw.height);
    state.trace.undo.push(img);
    if(state.trace.undo.length > 20) state.trace.undo.shift();
  }
  pushUndo();

  function updateLabels(){ $("#traceSizeVal").text(String(state.trace.size)); }
  updateLabels();

  $("#traceSize").off("input").on("input", function(){
    if(state.validated) return;
    state.trace.size = Number(this.value);
    updateLabels();
  });

  $("#traceUndo").off("click").on("click", function(){
    if(state.validated) return;
    const u = state.trace.undo;
    if(u.length <= 1) return;
    u.pop();
    dctx.putImageData(u[u.length-1],0,0);
  });

  $("#traceClear").off("click").on("click", function(){
    if(state.validated) return;
    pushUndo();
    dctx.clearRect(0,0,draw.width, draw.height);
    pushUndo();
  });

  if(!state.validated){
    installPointerDraw({
      canvas: draw,
      ctx: dctx,
      getStrokeStyle: () => ({
        color: "rgba(59,130,246,0.95)",
        size: state.trace.size,
        opacity: 1,
        composite: "source-over"
      }),
      onStrokeStart: () => pushUndo()
    });
  }
}

function renderUnsupported(entry){
  setTop({
    title:"نوع سؤال غير مدعوم",
    sub:"تحقق من type داخل questionBank",
    lesson:state.lesson?.title||"—",
    progress:progressText(),
    type:"تحذير",
    audioUrl:""
  });
  $stage().html(`<div class="panelKid">هذا النوع غير مدعوم: <b>${esc(entry?.q?.type || "")}</b></div>`);
}

/* =========================================================
  VALIDATION (UPDATED)
  - Only lock UI (state.validated = true) when CORRECT
  - On WRONG: keep validated=false so user can answer immediately
========================================================= */
function validate(){
  const entry = curEntry();
  const q = entry?.q || {};
  const type = String(q.type||"");

  // default: do NOT lock. Lock only if correct.
  state.validated = false;

  if(type === "multiple_choice" || type === "listen_choose"){
    if(!state.q.selected){
      feedback(false, "اختر إجابة أولًا", $stage());
      render();
      return;
    }
    const ok = String(state.q.selected) === String(q?.answer?.choiceId);
    if(ok){
      state.validated = true;
      feedback(true, "إجابة صحيحة", $(`[data-choice="${CSS.escape(state.q.selected)}"]`));
      render();
      setTimeout(nextQ, 520);
    }else{
      state.validated = false;
      feedback(false, "جرّب مرة أخرى", $(`[data-choice="${CSS.escape(state.q.selected)}"]`));
      render();
    }
    return;
  }

  if(type === "match"){
    const expected = Array.isArray(q.pairs)?q.pairs:[];
    const got = state.q.pairs || {};
    let ok = expected.length > 0;
    for(const p of expected){
      if(String(got[p.leftId]) !== String(p.rightId)){ ok=false; break; }
    }
    if(ok){
      state.validated = true;
      feedback(true, "تطابق صحيح", $stage());
      render();
      setTimeout(nextQ, 520);
    }else{
      state.validated = false;
      feedback(false, "بعض التطابقات غير صحيحة", $stage());
      render();
    }
    return;
  }

  if(type === "drag_drop"){
    const expected = Array.isArray(q.map) ? q.map
                   : Array.isArray(q.answers) ? q.answers
                   : [];
    const got = state.q.assign || {};
    let ok = expected.length > 0;
    for(const a of expected){
      const targetId = String(a.targetId ?? a.dropId);
      const dragId   = String(a.dragId);
      if(String(got[targetId]) !== dragId){ ok=false; break; }
    }
    if(ok){
      state.validated = true;
      feedback(true, "توزيع صحيح", $stage());
      render();
      setTimeout(nextQ, 520);
    }else{
      state.validated = false;
      feedback(false, "جرّب مرة أخرى", $stage());
      render();
    }
    return;
  }

  if(type === "ordering"){
    const expected = Array.isArray(q.answer?.orderedIds) ? q.answer.orderedIds.map(String) : [];
    const got = (state.q.order||[]).map(String);
    const ok = expected.length && expected.length === got.length && expected.every((v,i)=>v===got[i]);
    if(ok){
      state.validated = true;
      feedback(true, "ترتيب صحيح", $stage());
      render();
      setTimeout(nextQ, 520);
    }else{
      state.validated = false;
      feedback(false, "الترتيب غير صحيح", $stage());
      render();
    }
    return;
  }

  if(type === "classification"){
    const expected = Array.isArray(q.answer?.map) ? q.answer.map
                   : Array.isArray(q.answers) ? q.answers
                   : [];
    const got = state.q.catAssign || {};
    let ok = expected.length > 0;
    for(const a of expected){
      const itemId = String(a.itemId);
      const catId  = String(a.categoryId);
      if(String(got[itemId]) !== catId){ ok=false; break; }
    }
    if(ok){
      state.validated = true;
      feedback(true, "تصنيف صحيح", $stage());
      render();
      setTimeout(nextQ, 520);
    }else{
      state.validated = false;
      feedback(false, "بعض العناصر في فئة خاطئة", $stage());
      render();
    }
    return;
  }

  if(type === "build_construct"){
    const tiles = Array.isArray(q.tiles)?q.tiles:[];
    const target = norm(q?.answer?.text || "");
    const built = (state.q.built||[])
      .map(id => tiles.find(t => String(t.id)===String(id)))
      .filter(Boolean).map(t=>pickText(t)).join("");
    const ok = norm(built) === target;
    if(ok){
      state.validated = true;
      feedback(true, "الكلمة صحيحة", $stage());
      render();
      setTimeout(nextQ, 520);
    }else{
      state.validated = false;
      feedback(false, "جرّب مرة أخرى", $stage());
      render();
    }
    return;
  }

  if(type === "coloring"){
    if(!state.paint?.drawCtx || !state.paint?.maskCtx){
      feedback(false, "تعذر تحميل لوحة التلوين", $stage());
      render();
      return;
    }
    applyMaskToDrawing(state.paint.drawCtx, state.paint.maskCtx);

    const pct = coverageFromMask(state.paint.drawCtx, state.paint.maskCtx);
    const ok = pct >= Number(state.paint.requiredCoverage || 0.6);

    if(ok){
      state.validated = true;
      feedback(true, `ممتاز (${(pct*100).toFixed(0)}%)`, $("#paintDraw"));
      render();
      setTimeout(nextQ, 520);
    }else{
      state.validated = false;
      feedback(false, `لوّن أكثر (${(pct*100).toFixed(0)}%)`, $("#paintDraw"));
      render();
    }
    return;
  }

  if(type === "trace_write"){
    if(!state.trace?.drawCtx){
      feedback(false, "تعذر تحميل لوحة الكتابة", $stage());
      render();
      return;
    }
    const ink = countNonTransparentPixels(state.trace.drawCtx);
    const ok = ink >= state.trace.minInkPixels;

    if(ok){
      state.validated = true;
      feedback(true, "كتابة ممتازة", $("#traceDraw"));
      render();
      setTimeout(nextQ, 520);
    }else{
      state.validated = false;
      feedback(false, "اكتب أكثر فوق القالب", $("#traceDraw"));
      render();
    }
    return;
  }

  feedback(false, "هذا النوع غير مدعوم", $stage());
  render();
}

/* =========================================================
  MAIN RENDER SWITCH
========================================================= */
const RENDERERS = {
  multiple_choice: renderChoice,
  listen_choose:   renderChoice,
  match:           renderMatch,
  drag_drop:       renderDragDrop,
  ordering:        renderOrdering,
  classification:  renderClassification,
  build_construct: renderBuild,
  coloring:        renderColoring,
  trace_write:     renderTrace
};

async function render(){
  wireFooter();

  if(!state.flow.length){
    setTop({
      title:"لا توجد أسئلة",
      sub:"تحقق من questionBank",
      lesson:state.lesson?.title||"—",
      progress:"0/0",
      type:"—",
      audioUrl:""
    });
    $stage().html(`<div class="panelKid">لا توجد أسئلة لهذا الدرس.</div>`);
    return;
  }

  const entry = curEntry();
  entry.q = resolveQuestion(entry);

  const type = String(entry.q?.type || "");
  const isChoiceType = (type === "multiple_choice" || type === "listen_choose");
  setStageMode(isChoiceType ? "choice" : "default");

  fitStageToViewport();
  if(isChoiceType) fitChoiceCardsHard();

  const fn = RENDERERS[type];
  if(!fn) return renderUnsupported(entry);
  return await fn(entry);
}

/* =========================================================
  LOAD
========================================================= */
async function load(){
  try{
    ensurePopup(); // ready early
    resetQ();
    $stage().text("جاري التحميل...");

    const res = await fetch(DATA_FILE, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const level = findBy(data?.levels, "levelId", levelId);
    if(!level) throw new Error(`لا يوجد levelId=${levelId}`);

    const {sec, les} = findLesson(level, sectionId, lessonId);
    if(!sec) throw new Error(`لا يوجد section=${sectionId}`);
    if(!les) throw new Error(`لا يوجد lesson=${lessonId}`);

    // Optional randomize (keep if you want)
    les.interactive = randomizeInteractive(les.interactive);

    state.data = data;
    state.level = level;
    state.section = sec;
    state.lesson = les;

    // ✅ IMPORTANT: fetch ALL questions for this lesson
    state.flow = buildFlowAllQuestions(les);
    state.idx = 0;

    await render();
  }catch(e){
    setTop({
      title:"تعذر التحميل",
      sub:"تأكد من sections-lessens.json والمسار",
      lesson:"—",
      progress:"—",
      type:"⚠️",
      audioUrl:""
    });

    $stage().html(`
      <div class="panelKid">
        <div style="font-weight:1000;">تفاصيل الخطأ</div>
        <div class="mt-2" style="color:rgba(15,23,42,.65);font-weight:900;line-height:1.7;">
          ${esc(e?.message||"")}
        </div>
        <div class="d-flex gap-2 flex-wrap mt-3">
          <button class="btnKid btnPrimary px-3" id="retry" type="button">🔄 حاول مرة أخرى</button>
        </div>
      </div>
    `);

    $("#retry").off("click").on("click", load);
  }
}

/* =========================================================
  INIT
========================================================= */function syncViewportVars(){
  const vvh = window.visualViewport?.height || window.innerHeight;
  document.documentElement.style.setProperty("--vvh", vvh + "px");

  const topBar = document.querySelector(".topBar");
  const topH = topBar ? topBar.getBoundingClientRect().height : 0;
  document.documentElement.style.setProperty("--topBarH", topH + "px");
}

window.addEventListener("resize", syncViewportVars);
window.visualViewport?.addEventListener("resize", syncViewportVars);
window.visualViewport?.addEventListener("scroll", syncViewportVars);
syncViewportVars();

load();
</script>


</body>
</html>
