<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive Quiz</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">


  <style>
:root{
  --bg1:#f6f7fb; --bg2:#eef2ff;
  --ink:#0f172a; --muted:rgba(15,23,42,.62);
  --card:rgba(255,255,255,.92);
  --border:rgba(15,23,42,.10);
  --shadow:0 18px 44px rgba(15,23,42,.10);

  --r-xl: clamp(18px, 1.8vw, 28px);

  /* classification card height (desktop/base) */
  --clsCardH: clamp(140px, 22vw, 190px);

  --fs0: clamp(12px, .25vw + 11px, 14px);
  --fs1: clamp(14px, .35vw + 13px, 16.5px);
  --fs2: clamp(16px, .55vw + 15px, 20px);

  --btnH: clamp(42px, 5.2vh, 50px);

  --pad: clamp(10px, 1.2vw, 16px);
  --gap: clamp(8px, 1.1vw, 12px);

  --imgSz: clamp(54px, 5.6vw, 76px);

  /* Choice */
  --choiceAR: 4 / 3;
  --choiceAR_mobile: 16 / 11;

  /* MATCH */
  --matchImgH: clamp(72px, 12vw, 120px);
  --matchPadX: clamp(8px, 4vw, 56px);

  /* DRAG & DROP */
  --ddColGap: clamp(10px, 4vw, 48px);
  --ddCardH:  clamp(64px, 8vh, 86px);
  --ddImg:    clamp(54px, 6vw, 78px);

  /* CLASSIFICATION chip remove */
  --chipX: clamp(22px, 2.6vw, 26px);

  /* unified icon btn size */
  --iconBtn: 42px;
}

html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:var(--ink);
  background:
    radial-gradient(1200px 600px at 15% 20%, rgba(59,130,246,.20), transparent 55%),
    radial-gradient(900px 520px at 85% 15%, rgba(245,158,11,.18), transparent 60%),
    radial-gradient(900px 520px at 70% 90%, rgba(16,185,129,.16), transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
}

.appWrap{min-height:100vh; padding:var(--pad);}
.app{
  max-width:1180px;
  margin:0 auto;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--r-xl);
  box-shadow:var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:calc(100vh - (var(--pad) * 2));
}
@media (max-width:768px){
  .appWrap{padding:0}
  .app{border-radius:0; min-height:100vh;}
}

.topBar{
  background:rgba(255,255,255,.96);
  border-bottom:1px solid rgba(15,23,42,.08);
  padding:clamp(8px, 1vw, 12px) clamp(10px, 1.2vw, 14px);
  flex:0 0 auto;
}

/* ==============================
   HEADER
   ============================== */
.qHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:var(--gap);
}
.qHead > div{
  flex:1;
  min-width:0;
  display:grid;
  grid-template-columns:1fr auto;
  grid-template-rows:auto auto;
  grid-template-areas:
    "title meta"
    "sub   sub";
  align-items:start;
  gap:6px var(--gap);
}

.qTitle{
  grid-area:title;
  font-size:var(--fs2);
  font-weight:1000;
  line-height:1.15;
  margin:0;
  text-align:right;
  min-width:0;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.qSub{
  grid-area:sub;
  font-size:var(--fs0);
  color:var(--muted);
  font-weight:900;
  margin:0;
  text-align:right;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.topMeta{
  grid-area:meta;
  display:flex;
  flex-wrap:nowrap;
  gap:var(--gap);
  white-space:nowrap;
  align-items:center;
  justify-self:end;
  margin-top:0;
}
@media (max-width:767.98px){
  #topMeta{display:none !important;}
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  font-weight:1000;
  font-size:var(--fs0);
  background:rgba(15,23,42,.04);
  border:1px solid rgba(15,23,42,.08);
  white-space:nowrap;
  line-height:1;
}

/* ==============================
   BUTTONS
   ============================== */
.btnKid{
  border-radius:14px;
  font-weight:1000;
  font-size:var(--fs1);
  box-shadow:0 10px 18px rgba(15,23,42,.10);
  border:0;
  transition:transform .12s ease, opacity .16s ease;
  padding-inline:14px;
}
.btnKid:active{transform:scale(.99)}
.btnKid[disabled]{opacity:.55; transform:none; cursor:not-allowed}
.btnPrimary{color:#fff; background:linear-gradient(135deg, rgba(59,130,246,.98), rgba(139,92,246,.98));}
.btnSecondary{
  color:var(--ink);
  background:rgba(255,255,255,.98);
  border:1px solid rgba(15,23,42,.12);
  box-shadow:0 8px 14px rgba(15,23,42,.08);
}

.btnSound{
  height:var(--btnH);
  min-width:56px;
  border-radius:14px;
  font-weight:1000;
  border:0;
  color:#fff;
  background:linear-gradient(135deg, rgba(16,185,129,.98), rgba(59,130,246,.98));
  box-shadow:0 10px 18px rgba(15,23,42,.10);
  transition:transform .12s ease, opacity .16s ease;
  display:grid;
  place-items:center;
}
.btnSound:active{transform:scale(.99)}
.btnSound[disabled]{opacity:.55; transform:none; cursor:not-allowed}

/* ==============================
   LAYOUT
   ============================== */
.stage{
  flex:1;
  padding:var(--pad);
  position:relative;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  min-height:0;
}

.panelKid{
  background:rgba(255,255,255,.96);
  border:1px solid rgba(15,23,42,.10);
  box-shadow:0 8px 14px rgba(15,23,42,.06);
  border-radius:var(--r-xl);
  padding:var(--pad);
}
.panelFlex{display:flex; flex-direction:column; min-height:0;}
.panelBodyGrow{flex:1; min-height:0;}

.panelTitle{font-weight:1000; font-size:var(--fs1); margin:0 0 10px}
.panelTitle small{color:var(--muted); font-weight:900; font-size:var(--fs0)}

/* ==============================
   CARDS
   ============================== */
.cardBtn{
  text-align:right;
  border-radius:var(--r-xl);
  border:1px solid rgba(15,23,42,.10);
  background:rgba(255,255,255,.98);
  box-shadow:0 10px 18px rgba(15,23,42,.08);
  padding:clamp(10px, 1.1vw, 14px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  transition:transform .12s ease, border-color .15s ease, box-shadow .15s ease;
  cursor:pointer;
  width:fit-content;
  min-width:clamp(180px, 24vw, 320px);
  max-width:100%;
}/* Classification items: never exceed column width (prevents horizontal scroll on mobile) */
#clsItems .cardBtn{
  width: 100% !important;
  min-width: 0 !important;
  max-width: 100% !important;
}

/* Ensure children can shrink instead of forcing overflow */
#clsItems .cardLeft,
#clsItems .clsTitleRow{
  min-width: 0 !important;
}

.cardBtn:active{transform:scale(.995)}
.cardBtn[data-selected="1"]{
  border-color:rgba(59,130,246,.55);
  box-shadow:0 14px 26px rgba(59,130,246,.14);
}

.cardLeft{display:flex; align-items:center; gap:10px; min-width:0;}
.cardImg{
  width:var(--imgSz);
  height:var(--imgSz);
  border-radius:16px;
  border:1px solid rgba(15,23,42,.10);
  background:rgba(15,23,42,.03);
  object-fit:cover;
  flex:0 0 auto;
}
.cardText{
  font-weight:1000;
  font-size:var(--fs1);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:42ch;
}
.cardSide{
  flex:0 0 auto;
  display:flex;
  align-items:center;
}

/* ==============================
   ICON BUTTON
   ============================== */
.iconBtn{
  width:var(--iconBtn);
  height:var(--iconBtn);
  border-radius:14px;
  border:1px solid rgba(15,23,42,.12);
  background:rgba(255,255,255,.98);
  box-shadow:0 8px 14px rgba(15,23,42,.06);
  display:grid;
  place-items:center;
  font-weight:1000;
  padding:0;
  flex:0 0 auto;
  cursor:pointer;
  transition:transform .12s ease, opacity .16s ease;
}
.iconBtn:active{transform:scale(.99)}
.iconBtn:disabled{opacity:.45; cursor:not-allowed}
.iconBtn i{font-size:20px; line-height:1}

/* ==============================
   CHOICE
   ============================== */
.choiceGrid{
  display:grid;
  gap:var(--gap);
  grid-template-columns:repeat(auto-fit, minmax(min(260px, 100%), 1fr));
  align-items:stretch;
  justify-items:stretch;
  min-height:0;
}
@media (min-width:992px){ .choiceGrid{grid-template-columns:repeat(4, 1fr);} }
@media (min-width:768px) and (max-width:991.98px){ .choiceGrid{grid-template-columns:repeat(3, 1fr);} }
@media (max-width:767.98px){ .choiceGrid{grid-template-columns:repeat(2, 1fr);} }
@media (max-width:520px){ .choiceGrid{grid-template-columns:1fr;} }

.choiceCard{
  width:100% !important;
  min-width:0 !important;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  justify-content:flex-start;
  text-align:center;
  padding:clamp(10px, 1.1vw, 14px);
  gap:10px;
}

.choiceImgWrap{
  position:relative;
  width:100%;
  border-radius:clamp(16px, 1.6vw, 22px);
  border:1px solid rgba(15,23,42,.10);
  background:rgba(15,23,42,.03);
  overflow:hidden;
  box-shadow:0 8px 14px rgba(15,23,42,.06);
  aspect-ratio:var(--choiceAR);
  flex:0 0 auto;
}
@media (max-width:520px){
  .choiceImgWrap{aspect-ratio:var(--choiceAR_mobile);
  
  }
}
/* ==============================
   ORDERING ‚Äî MOBILE: shrink arrow icons + number box
   keep images unchanged
   ============================== */
@media (max-width:520px){

  /* smaller number box */
  .orderIdx{
    width:28px !important;
    height:28px !important;
    border-radius:10px !important;
    font-size:12px !important;
  }

  /* smaller up/down icon buttons (only in ordering rows) */
  #orderList .iconBtn{
    width:28px !important;
    height:28px !important;
    border-radius:10px !important;
    padding:0 !important;
  }
  #orderList .iconBtn i{
    font-size:16px !important;
  }

  /* make the right-side controls take less space */
  #orderList [data-orderid] .d-flex.gap-2.align-items-center{
    gap:6px !important;
  }

  /* give text more room without touching the image size */
  #orderList .cardLeft{
    gap:8px !important;
  }
  #orderList .cardText{
    max-width:100% !important;
    -webkit-line-clamp:2 !important;
  }
}

.choiceImg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  object-position:center;
  display:block;
  background:rgba(15,23,42,.03);
}
.choiceNoImg{position:absolute; inset:0; display:grid; place-items:center;}

.choiceMetaDesktop{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:2px 6px 0;
}
.choiceNameDesktop{
  font-weight:1000;
  font-size:var(--fs1);
  line-height:1.2;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  max-width:46ch;
}

/* Exists in HTML but kept OFF on mobile (your approved behavior) */
.choiceMetaMobile{
  display:none;
  position:absolute;
  left:10px; right:10px; bottom:10px;
  background:rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.10);
  border-radius:14px;
  padding:8px 10px;
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);
  align-items:center;
  justify-content:center;
  gap:10px;
}
.choiceNameMobile{
  font-weight:1000;
  font-size:var(--fs1);
  line-height:1.2;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  flex:1;
  min-width:0;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.choiceMetaMobile .iconBtn{flex:0 0 auto; padding:0;}

/* ==============================
   LISTS + DROP ZONES
   ============================== */
.vList{display:flex; flex-direction:column; gap:var(--gap); align-items:stretch;}

.dropZone{
  width:100%;
  border-radius:var(--r-xl);
  border:2px dashed rgba(15,23,42,.18);
  background:rgba(15,23,42,.02);
  padding:clamp(10px, 1.1vw, 14px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  min-height:clamp(64px, 7.2vh, 86px);
}
.dropZone[data-active="1"]{
  border-color:rgba(59,130,246,.55);
  background:rgba(59,130,246,.06);
}
.zoneFill{
  font-weight:1000;
  font-size:var(--fs0);
  color:rgba(15,23,42,.70);
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.10);
  background:rgba(255,255,255,.90);
  white-space:nowrap;
  max-width:48%;
  overflow:hidden;
  text-overflow:ellipsis;
}

.dragItem{user-select:none;}
.dragging{opacity:.75; transform:scale(.99);}

.orderIdx{
  width:36px;
  height:36px;
  border-radius:12px;
  display:grid;
  place-items:center;
  font-weight:1000;
  background:rgba(59,130,246,.10);
  border:1px solid rgba(59,130,246,.18);
  flex:0 0 auto;
}

.footerControls{
  margin-top:var(--gap);
  display:flex;
  flex-wrap:wrap;
  gap:var(--gap);
  align-items:center;
  justify-content:flex-start;
}
.footerControls .btnKid{flex:0 0 auto;}
@media (max-width:520px){
  .footerControls .btnKid{flex:1 1 auto;}
}

.grid2_1{
  display:grid;
  gap:var(--gap);
  grid-template-columns:1fr;
  align-items:stretch;
  min-height:0;
}
@media (min-width:992px){
  .grid2_1{grid-template-columns:2fr 1fr;}
}

.paintCanvas,.traceCanvas{
  width:100%;
  display:block;
  border-radius:clamp(16px, 1.8vw, 22px);
  border:1px solid rgba(15,23,42,.10);
  box-shadow:0 10px 18px rgba(15,23,42,.08);
  background:rgba(255,255,255,.98);
  touch-action:none;
}

.swatch{
  width:clamp(30px, 3.8vw, 36px);
  height:clamp(30px, 3.8vw, 36px);
  border-radius:14px;
  border:2px solid rgba(15,23,42,.15);
  cursor:pointer;
  box-shadow:0 8px 14px rgba(15,23,42,.08);
}
.swatch[data-selected="1"]{outline:4px solid rgba(59,130,246,.55); outline-offset:2px;}

.toastKid{
  position:fixed;
  left:16px;
  bottom:16px;
  z-index:3000;
  width:min(380px, calc(100% - 32px));
  background:rgba(255,255,255,.96);
  border:1px solid rgba(15,23,42,.12);
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:12px;
  display:none;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.toastKid.show{display:flex;}
.toastKid b{font-weight:1000}

.correctPulse{animation:correctPulse .6s ease-out;}
@keyframes correctPulse{0%{transform:scale(1)}40%{transform:scale(1.08)}100%{transform:scale(1)}}
.wrongShake{animation:wrongShake .45s ease-in-out;}
@keyframes wrongShake{
  0%{transform:translateX(0)}
  25%{transform:translateX(-6px)}
  50%{transform:translateX(6px)}
  75%{transform:translateX(-4px)}
  100%{transform:translateX(0)}
}
.starBurst{
  position:fixed; inset:0;
  pointer-events:none;
  display:grid; place-items:center;
  z-index:4000;
  font-size:52px;
  animation:burst .7s ease-out forwards;
}
@keyframes burst{
  0%{opacity:0; transform:scale(.6)}
  40%{opacity:1; transform:scale(1.2)}
  100%{opacity:0; transform:scale(1.6)}
}

/* ==============================
   MATCH ‚Äî TWO COLUMNS + FULL IMAGE DISPLAY
   ============================== */
.pairGrid{
  display:flex;
  flex-direction:column;
  gap:clamp(8px, 1.2vw, 14px);
  width:100%;
  padding-inline:var(--matchPadX);
  box-sizing:border-box;
}
.pairRow{
  display:flex;
  width:100%;
  align-items:stretch;
  gap:clamp(8px, 6vw, 56px);
}
.pairRow > .cardBtn{
  flex:0 0 50%;
  max-width:50%;
  min-width:0;
  height:var(--matchImgH);
  padding:0 !important;
  display:flex;
  align-items:stretch;
  justify-content:stretch;
  border-radius:clamp(14px, 2vw, 18px);
}
.pairRow [data-left]{overflow:hidden;}
.pairRow [data-left] .cardLeft{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0;
}

.matchLeftImg{
  width:clamp(56px, 6.2vw, 88px);
  height:clamp(56px, 6.2vw, 88px);
  border-radius:18px;
  border:1px solid rgba(15,23,42,.10);
  background:rgba(15,23,42,.03);
  object-fit:cover;
  flex:0 0 auto;
}

.pairRow [data-left] .matchLeftImg{
  width:100% !important;
  height:100% !important;
  display:block;
  object-fit:contain;
  object-position:center;
  border:0;
  background:rgba(15,23,42,.03);
  border-radius:inherit;
}

.pairRow [data-left] .cardText{
  width:100%;
  height:100%;
  display:grid;
  place-items:center;
  text-align:center;
  font-weight:1000;
  padding:10px 12px;
  white-space:normal;
}

.pairRow [data-right]{
  display:flex;
  align-items:center;
  justify-content:center;
}
.pairRow [data-right] .cardLeft{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.pairRow [data-right] .cardText{
  width:100%;
  max-width:100%;
  text-align:center;
  white-space:normal;
  overflow:hidden;
  padding:10px 14px;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
}
@media (max-width:520px){
  .pairRow{gap:clamp(6px, 3vw, 10px);}
}
@media (min-width:992px){
  .pairRow{gap:clamp(24px, 6vw, 72px);}
}

/* ==============================
   DRAG & DROP + CLASSIFICATION ‚Äî TWO COLUMNS ALWAYS
   ============================== */
.twoColGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:var(--ddColGap);
  align-items:stretch;
  width:100%;
}
.twoColGrid > .panelKid{min-width:0 !important; height:100%;}
.twoColGrid .panelFlex{min-height:0;}
.twoColGrid .panelBodyGrow{
  min-height:0;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}

/* DRAG & DROP ‚Äî HEIGHT SYNC + FULL IMAGES */
#ddLeft .cardBtn{
  width:100% !important;
  min-width:0 !important;
  max-width:100% !important;
  height:var(--ddCardH);
  padding:10px 12px !important;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
#ddLeft .cardLeft{
  height:100%;
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
#ddLeft .cardImg{
  width:var(--ddImg) !important;
  height:var(--ddImg) !important;
  object-fit:contain !important;
  object-position:center;
  background:rgba(15,23,42,.03);
  flex:0 0 auto;
}
#ddLeft .cardText{
  white-space:normal !important;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  max-width:100% !important;
}

#ddRight .dropZone{
  width:100%;
  min-height:var(--ddCardH);
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
#ddRight .dropZone > .d-flex{
  height:100%;
  min-width:0;
  align-items:center;
}
#ddRight .dropZone .cardImg{
  width:var(--ddImg) !important;
  height:var(--ddImg) !important;
  object-fit:contain !important;
  object-position:center;
  background:rgba(15,23,42,.03);
}
#ddRight .dropZone .d-flex > div{
  white-space:normal !important;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
}
#ddRight .zoneFill{
  max-width:42%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* CLASSIFICATION ‚Äî REMOVABLE CHIPS */
.clsChip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  font-weight:1000;
  font-size:var(--fs0);
  background:rgba(59,130,246,.08);
  border:1px solid rgba(59,130,246,.18);
  line-height:1;
}
.clsX{
  width:var(--chipX);
  height:var(--chipX);
  border-radius:999px;
  border:1px solid rgba(15,23,42,.14);
  background:rgba(255,255,255,.95);
  display:grid;
  place-items:center;
  cursor:pointer;
  font-weight:1000;
  box-shadow:0 6px 12px rgba(15,23,42,.08);
  flex:0 0 auto;
}
.clsX:active{transform:scale(.98)}

/* ORDERING ‚Äî OPTIONS WIDTH (70%) */
#orderList{
  display:flex;
  flex-direction:column;
  align-items:center;
}
#orderList > .cardBtn{
  width:70% !important;
  max-width:70% !important;
  min-width:70% !important;
  margin-inline:auto;
}

/* ==============================
   MOBILE CONSOLIDATION (<=520px)
   ============================== */
@media (max-width:520px){
  :root{
    --ddColGap: clamp(8px, 3vw, 12px);
    --ddCardH:  clamp(60px, 10vh, 76px);
    --ddImg:    clamp(46px, 9vw, 64px);
  }

  /* Choice: hard-fit helpers (only when stage--choice is set via JS) */
  .stage--choice{
    display:flex !important;
    flex-direction:column !important;
    overflow:hidden !important;
    height:var(--stageH, auto) !important;
    max-height:var(--stageH, auto) !important;
  }
  .stage--choice #choiceGrid{
    flex:1 1 auto !important;
    min-height:0 !important;
    align-content:start;
  }
  .stage--choice #footerControls{
    flex:0 0 auto !important;
    margin-top:8px !important;
  }

  #choiceGrid{
    flex:1 1 auto !important;
    min-height:0 !important;
    align-content:start;
  }
  .choiceImgWrap{
    aspect-ratio:auto !important;
    height:var(--choiceMobileImgH, 110px) !important;
    min-height:0 !important;
  }

  /* Approved final behavior: overlay OFF, desktop row ON */
  .choiceMetaMobile{display:none !important;}
  .choiceMetaDesktop{display:flex !important;}

  .choiceNameDesktop{
    -webkit-line-clamp:1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .choiceMetaDesktop .iconBtn{
    width:34px;
    height:34px;
    border-radius:10px;
  }
  .iconBtn i{font-size:18px;}

  /* Ordering width on mobile */
  #orderList > .cardBtn{
    width:92% !important;
    max-width:92% !important;
    min-width:92% !important;
  }

  /* MATCH spacing tighter */
  .pairRow{gap:clamp(6px, 3vw, 10px);}
}

/* ==============================
   STICKY FOOTER (buttons always visible)
   ============================== */
#footerControls{
  position: sticky;
  bottom: 0;
  z-index: 50;

  background: rgba(255,255,255,.96);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);

  border-top: 1px solid rgba(15,23,42,.10);

  padding: 10px;
  margin-top: var(--gap);

  padding-bottom: calc(10px + env(safe-area-inset-bottom));
}

/* ==============================
   CLASSIFICATION (clean + consistent)
   ============================== */

/* Card sizing */
#clsItems .cardBtn{
  height: var(--clsCardH);
  min-height: var(--clsCardH);
  max-height: var(--clsCardH);

  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;

  padding:10px;

  /* IMPORTANT: prevents "space-between" from stretching row */
  justify-content:flex-start !important;
}

/* Category drop zones match height */
#clsCats .dropZone{
  min-height: var(--clsCardH);
  height: auto;

  display:flex;
  flex-direction:column;
  justify-content:flex-start;
}

/* Image area inside classification card */
#clsItems .cardImg{
  width:100%;
  height: calc(var(--clsCardH) - 52px); /* leaves room for title row */
  object-fit:contain;
  border-radius:18px;
  margin-bottom:5px;
}

/* Title row: text + sound icon in ONE ROW */
#clsItems .clsTitleRow{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:5px;              /* your requested spacing */
  margin-top:-14px;
  min-width:0;
}

/* Do NOT force full-width on text; keep it shrinkable */
#clsItems .clsTitleRow .cardText{
  margin:0 !important;
  font-weight:1000;
  font-size:var(--fs1);
  text-align:center;

  max-width:70%;
  min-width:0;
  flex:0 1 auto;

  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Icon stays next to text */
#clsItems .clsTitleRow .cardSide{
  width:auto !important;
  margin:0 !important;
  flex:0 0 auto;

  display:flex;
  align-items:center;
  justify-content:center;
}

/* General classification structure */
#clsItems .cardLeft{
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* Small icon button for classification */
#clsItems .iconBtn{
  width:32px;
  height:32px;
  border-radius:10px;
}
#clsItems .iconBtn i{
  font-size:18px;
}

/* Mobile: keep title row tight */
@media (max-width:520px){
  #clsItems .clsTitleRow{
    flex-wrap:nowrap !important;
    gap:2px !important;
  }
  #clsItems .clsTitleRow .cardText{
    max-width:70% !important;
  }
}

/* Desktop: prevent nested panel scroll issues if you want it visible */
@media (min-width: 992px){
  .twoColGrid .panelBodyGrow{
    overflow: visible !important;
  }
}

/* Desktop: reduce classification height to avoid overflow */
@media (min-width: 992px){
  :root{
    --clsCardH: clamp(110px, 15vh, 150px);
  }
  #clsCats .dropZone{
    min-height: var(--clsCardH) !important;
  }
  #clsItems .cardImg{
    height: calc(var(--clsCardH) - 46px) !important;
  }
  /*  */


}/* ==============================
   COLORING ‚Äî MOBILE + TABLET ONLY
   Label + value + range in ONE ROW
   ============================== */
@media (max-width: 900px){

  .paintSizeRow{
    display:flex;
    align-items:center;
    gap:8px;
    width:100%;
    min-width:0;
  }

  /* keep pills compact so slider has space */
  .paintSizeLabel,
  .paintSizeVal{
    flex:0 0 auto;
    padding:4px 10px;
    font-size:var(--fs0);
    white-space:nowrap;
  }

  /* slider takes remaining width */
  .paintSizeRange{
    flex:1 1 auto;
    min-width:90px;     /* prevents collapsing too much */
    margin:0 !important;/* override mt-2 if present elsewhere */
  }.paintOpacityRow{
    display:flex;
    align-items:center;
    gap:8px;
    width:100%;
    min-width:0;
  }

  .paintOpacityLabel,
  .paintOpacityVal{
    flex:0 0 auto;
    padding:4px 10px;
    font-size:var(--fs0);
    white-space:nowrap;
  }

  .paintOpacityRange{
    flex:1 1 auto;
    min-width:90px;
    margin:0 !important;
  }
}

@media (min-width: 1280px){

  /* Card becomes horizontal */
  #clsItems .cardBtn{
    flex-direction:row !important;
    align-items:center !important;
    gap:12px;
  }

  /* Left container becomes row */
  #clsItems .cardLeft{
    flex-direction:row !important;
    align-items:center !important;
    width:50%;
    gap:32px;
  }

  /* Image takes remaining width */
  #clsItems .cardImg{
    flex:1 1 auto !important;
    width:50% !important;
    height:50% !important;
    object-fit:contain;
  }

  /* Title + sound stay compact */
  #clsItems .clsTitleRow{
    flex:0 0 auto !important;
    justify-content:flex-start !important;
    margin-top:0 !important;
    max-width:50%;
     gap:30px;
    
  }

  #clsItems .clsTitleRow .cardText{
    max-width:100%;
    text-align:right;
  }
}
/* ==============================
   MOBILE: make stage behave like a real viewport container
   so inner panels can stretch (fix empty half screen)
   ============================== */
@media (max-width:520px){

  /* Stage becomes a flex column container with fixed height var(--stageH) */
  .stage{
    display:flex !important;
    flex-direction:column !important;
    height: var(--stageH, auto) !important;
    max-height: var(--stageH, auto) !important;
    overflow:hidden !important;   /* IMPORTANT: prevent outer scroll */
    min-height:0 !important;
  }

  /* Whatever you render at top level should stretch */
  .stage > .panelKid,
  .stage > .twoColGrid,
  .stage > .grid2_1{
    flex:1 1 auto !important;
    min-height:0 !important;
  }

  /* If the top-level is a single flex panel, make it fill */
  .stage > .panelKid.panelFlex{
    height:100% !important;
    min-height:0 !important;
  }

  /* twoColGrid and grid2_1 must also take full height */
  .twoColGrid,
  .grid2_1{
    height:100% !important;
    min-height:0 !important;
  }

  /* Ensure scrolling happens inside the intended ‚ÄúGrow‚Äù areas */
  .panelBodyGrow{
    overflow:auto !important;
    min-height:0 !important;
    -webkit-overflow-scrolling:touch;
  }

  /* If a panel contains a list without panelBodyGrow, it should scroll */
  #orderList,
  #pairGrid,
  #ddLeft,
  #ddRight,
  #clsItems,
  #clsCats{
    min-height:0 !important;
  }
}
/* Tablet: remove sticky footer to avoid empty space under buttons */
@media (min-width: 601px) and (max-width: 900px){
  #footerControls{
    position: static !important;
    bottom: auto !important;
    padding-bottom: 10px !important; /* ÿ®ÿØŸÑ safe-area */
    margin-top: 10px !important;
  }
}
/* Tablet: keep sticky but reduce bottom padding that creates the big gap */
@media (min-width: 521px) and (max-width: 900px){
  #footerControls{
    padding-bottom: 10px !important; /* ŸäŸÑÿ∫Ÿä ÿßŸÑÿ™ÿ∂ÿÆŸäŸÖ ŸÖŸÜ safe-area */
    margin-top: 6px !important;
  }
}
/* TABLET: ordering should not look like half screen */
@media (min-width: 521px) and (max-width: 900px){
  #orderList{
    align-items: stretch !important;   /* stop centering the 70% cards */
  }

  #orderList > .cardBtn{
    width: 92% !important;
    min-width: 92% !important;
    max-width: 92% !important;
    margin-inline: auto;
  }
}
/* TABLET: let stage behave like a full-height container so the panel/list can fill */
@media (min-width: 521px) and (max-width: 900px){
  #stage{
    display: flex !important;
    flex-direction: column !important;
    min-height: 0 !important;
  }

  #stage > .panelKid.panelFlex{
    flex: 1 1 auto !important;
    min-height: 0 !important;
  }

  #orderList.panelBodyGrow{
    flex: 1 1 auto !important;
    min-height: 0 !important;
    overflow: auto !important;
  }
}

  </style>
</head>

<body>
  <div class="appWrap">
    <div class="app">
      <div class="topBar">
        <div class="qHead">
        <button class="btnSound" id="btnSound" type="button" disabled>
  <i class="bi bi-volume-up-fill" aria-hidden="true"></i>
</button>

          <div style="flex:1; min-width:0;">
            <h1 class="qTitle" id="qTitle">‚Äî</h1>
            <p class="qSub" id="qSub">‚Äî</p>
            <div class="topMeta" id="topMeta">
              <span class="pill" id="pillLesson">‚Äî</span>
              <span class="pill" id="pillProgress">0/0</span>
              <span class="pill" id="pillType">‚Äî</span>
            </div>
          </div>
        </div>
      </div>

      <div class="stage" id="stage">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
    </div>
  </div>

  <div class="toastKid" id="toastKid" role="status" aria-live="polite">
    <div>
      <b id="toastTitle">‚Äî</b><br/>
      <span id="toastMsg">‚Äî</span>
    </div>
    <button class="btnKid btnSecondary px-3" id="toastClose" type="button" style="height:44px">ÿ•ÿ∫ŸÑÿßŸÇ</button>
  </div>
<script>
/* =========================================================
  SETTINGS
========================================================= */
const DATA_FILE = "sections-lessens.json"; // ensure this matches your real filename exactly
const urlParams = new URL(location.href).searchParams;
const levelId   = (urlParams.get("level")   || "preliminary").toLowerCase();
const sectionId = (urlParams.get("section") || "").toLowerCase();
const lessonId  = (urlParams.get("lesson")  || "");

const audio = new Audio();

/* =========================================================
  HELPERS (DOM + TEXT)
========================================================= */
const $stage = () => $("#stage");

const esc = (s) => String(s ?? "")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

const norm = (s) => String(s||"").replace(/\s+/g," ").trim();
const isTouch = () => matchMedia("(max-width: 900px)").matches || ("ontouchstart" in window);

function pickText(o){
  return String(o?.text ?? o?.label ?? o?.name ?? o?.letter ?? "").trim();
}
function visualSrc(o){
  return String(o?.imageUrl ?? "").trim() || "";
}
function setStageMode(mode){
  const st = document.getElementById("stage");
  if(!st) return;
  st.classList.toggle("stage--choice", mode === "choice");
}

/* Show audio icon ONLY when there is visible text (not image-only) */
function hasVisibleText(o){
  const t = pickText(o);
  return typeof t === "string" && t.trim().length > 0;
}

function hintFor(type){
  const touch = isTouch();
  return ({
    multiple_choice: "ÿßÿÆÿ™ÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿ´ŸÖ ÿßÿ∂ÿ∫ÿ∑ (ÿ™ÿ≠ŸÇŸÇ)",
    listen_choose:   "ÿßÿ∂ÿ∫ÿ∑ (ÿßÿ≥ŸÖÿπ) ÿ´ŸÖ ÿßÿÆÿ™ÿ± ÿ´ŸÖ (ÿ™ÿ≠ŸÇŸÇ)",
    match:           "ÿßÿÆÿ™ÿ± ŸÖŸÜ ÿßŸÑŸäÿ≥ÿßÿ± ÿ´ŸÖ ŸÖŸÜ ÿßŸÑŸäŸÖŸäŸÜ ÿ´ŸÖ (ÿ™ÿ≠ŸÇŸÇ)",
    drag_drop:       touch ? "ÿßÿÆÿ™ÿ± ÿßŸÑÿπŸÜÿµÿ± ÿ´ŸÖ ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑŸáÿØŸÅ" : "ÿßÿ≥ÿ≠ÿ® Ÿàÿ∂ÿπ ÿßŸÑÿπŸÜÿµÿ± ÿπŸÑŸâ ÿßŸÑŸáÿØŸÅ",
    ordering:        touch ? "ÿßÿ≥ÿ™ÿÆÿØŸÖ ‚¨ÜÔ∏è‚¨áÔ∏è ÿ´ŸÖ (ÿ™ÿ≠ŸÇŸÇ)" : "ÿßÿ≥ÿ≠ÿ® ŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿπŸÜÿßÿµÿ± ÿ´ŸÖ (ÿ™ÿ≠ŸÇŸÇ)",
    classification:  touch ? "ÿßÿÆÿ™ÿ± ÿπŸÜÿµÿ±Ÿãÿß ÿ´ŸÖ ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑŸÅÿ¶ÿ©" : "ÿßÿ≥ÿ≠ÿ® ŸÉŸÑ ÿπŸÜÿµÿ± ŸÑŸÑŸÅÿ¶ÿ© ÿ´ŸÖ (ÿ™ÿ≠ŸÇŸÇ)",
    coloring:        "ŸÑŸàŸëŸÜ ÿØÿßÿÆŸÑ ÿßŸÑÿ¥ŸÉŸÑ ŸÅŸÇÿ∑ ÿ´ŸÖ (ÿ™ÿ≠ŸÇŸÇ)",
    build_construct: "ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑŸÇÿ∑ÿπ ŸÑÿ™ŸÉŸàŸäŸÜ ÿßŸÑŸÉŸÑŸÖÿ© ÿ´ŸÖ (ÿ™ÿ≠ŸÇŸÇ)",
    trace_write:     "ÿßŸÉÿ™ÿ® ŸÅŸàŸÇ ÿßŸÑŸÇÿßŸÑÿ® ÿ´ŸÖ (ÿ™ÿ≠ŸÇŸÇ)"
  })[type] || "ÿßÿÆÿ™ÿ±/ÿ≠ÿ±ŸëŸÉ ÿ´ŸÖ ÿßÿ∂ÿ∫ÿ∑ (ÿ™ÿ≠ŸÇŸÇ)";
}

/* =========================================================
  TOAST + FX + AUDIO
========================================================= */
function toast(titleHtml, msg){
  $("#toastTitle").html(titleHtml);
  $("#toastMsg").text(msg);
  $("#toastKid").addClass("show");
}
function toastHide(){ $("#toastKid").removeClass("show"); }

function burstStars(){
  const d = document.createElement("div");
  d.className = "starBurst";
  d.textContent = "‚≠êüéâ‚≠ê";
  document.body.appendChild(d);
  setTimeout(()=>d.remove(), 700);
}
function animCorrect($el){
  const el = ($el && $el[0]) ? $el[0] : $stage()[0];
  el.classList.add("correctPulse");
  burstStars();
  setTimeout(()=>el.classList.remove("correctPulse"), 650);
}
function animWrong($el){
  const el = ($el && $el[0]) ? $el[0] : $stage()[0];
  el.classList.add("wrongShake");
  setTimeout(()=>el.classList.remove("wrongShake"), 460);
}

function playSound(url){
  if(!url){ toast("ÿ™ŸÜÿ®ŸäŸá","ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸÑŸÅ ÿµŸàÿ™"); return; }
  audio.pause();
  audio.src = url;
  audio.currentTime = 0;
  audio.play().catch(()=>toast("ÿ™ŸÜÿ®ŸäŸá","ÿ™ÿπÿ∞ÿ± ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™"));
}

function feedback(ok, msg, $target){
  toast(ok ? "ÿµÿ≠Ÿäÿ≠ ‚úÖ" : "ÿ¨ÿ±Ÿëÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ üîÑ", msg);
  const fb = state.lesson?.interactive?.feedbackAudio || {};
  const snd = ok ? fb.correct : fb.wrong;
  if(snd) playSound(snd);
  ok ? animCorrect($target) : animWrong($target);
}

/* =========================================================
  TOP BAR
========================================================= */
function setTop({title, sub, lesson, progress, type, audioUrl}){
  $("#qTitle").text(title || "ÿ≥ÿ§ÿßŸÑ");
  $("#qSub").text(sub || "");
  $("#pillLesson").text(lesson || "‚Äî");
  $("#pillProgress").text(progress || "‚Äî");
  $("#pillType").text(type || "‚Äî");

  const $btn = $("#btnSound");
  $btn.prop("disabled", !audioUrl);
  $btn.off("click").on("click", () => playSound(audioUrl));
}

/* =========================================================
  FOOTER CONTROLS (shared)
========================================================= */
function footerControls(){
  return `
    <div class="footerControls" id="footerControls">
      <button class="btnKid btnPrimary" id="btnCheck" type="button">‚úÖ ÿ™ÿ≠ŸÇŸÇ</button>
      <button class="btnKid btnSecondary" id="btnTry" type="button">üîÅ ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</button>
      <button class="btnKid btnSecondary" id="btnBack" type="button">‚¨ÖÔ∏è ÿ±ÿ¨Ÿàÿπ</button>
    </div>
  `;
}
function wireFooter(){
  $("#btnCheck").off("click").on("click", ()=>validate());
  $("#btnTry").off("click").on("click", ()=>{ resetQ(); render(); });
  $("#btnBack").off("click").on("click", ()=>history.back());
  $("#toastClose").off("click").on("click", toastHide);
}

/* =========================================================
  CANVAS UTIL (paint/trace)
========================================================= */
function canvasPos(canvas, clientX, clientY){
  const r = canvas.getBoundingClientRect();
  const x = (clientX - r.left) * (canvas.width / r.width);
  const y = (clientY - r.top)  * (canvas.height / r.height);
  return {x, y};
}

/* reusable stroke-style applier (reduces duplicated code) */
function applyStrokeStyle(ctx, st){
  ctx.globalAlpha = st.opacity ?? 1;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.strokeStyle = st.color ?? "#111827";
  ctx.lineWidth = st.size ?? 10;
  ctx.globalCompositeOperation = st.composite ?? "source-over";
}

/* =========================================================
  NEW: HARD CLIP DRAWING TO MASK (prevents painting outside)
========================================================= */
function applyMaskToDrawing(drawCtx, maskCtx){
  const w = drawCtx.canvas.width, h = drawCtx.canvas.height;
  const drawImg = drawCtx.getImageData(0,0,w,h);
  const maskImg = maskCtx.getImageData(0,0,w,h);

  const d = drawImg.data;
  const m = maskImg.data;

  for(let i=0; i<m.length; i+=4){
    const maskA = m[i+3];
    if(maskA <= 20){
      d[i+3] = 0; // erase drawing outside allowed region
    }
  }
  drawCtx.putImageData(drawImg,0,0);
}

/* Updated pointer draw installer:
   - avoids duplicate touch+pointer drawing
   - now supports onDraw and onEnd hooks */
function installPointerDraw({ canvas, ctx, getStrokeStyle, onStrokeStart, onDraw, onEnd }){
  let drawing = false;
  let last = null;

  function getPoint(e){
    return canvasPos(canvas, e.clientX, e.clientY);
  }

  function start(e){
    e.preventDefault();
    drawing = true;
    const p = getPoint(e);
    last = p;

    const st = getStrokeStyle();
    ctx.save();
    applyStrokeStyle(ctx, st);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    ctx.lineTo(p.x + 0.01, p.y + 0.01);
    ctx.stroke();
    ctx.restore();

    onStrokeStart && onStrokeStart();
    onDraw && onDraw();
  }

  function move(e){
    if(!drawing) return;
    e.preventDefault();
    const p = getPoint(e);

    const st = getStrokeStyle();
    ctx.save();
    applyStrokeStyle(ctx, st);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    ctx.restore();

    last = p;
    onDraw && onDraw();
  }

  function end(e){
    if(!drawing) return;
    e.preventDefault();
    drawing = false;
    last = null;
    onEnd && onEnd();
  }

  canvas.addEventListener("pointerdown", start, {passive:false});
  canvas.addEventListener("pointermove", move, {passive:false});
  window.addEventListener("pointerup", end, {passive:false});
  window.addEventListener("pointercancel", end, {passive:false});
}

/* Optional layout helper (kept) */
function fitChoiceCardsHard(){
  if(!matchMedia("(max-width: 520px)").matches) return;

  const app = document.querySelector(".app");
  const topBar = document.querySelector(".topBar");
  const stage = document.getElementById("stage");
  if(!stage || !stage.classList.contains("stage--choice")) return;

  const footer = document.getElementById("footerControls");

  if(!app || !topBar || !stage) return;

  const vh = window.visualViewport?.height || window.innerHeight;

  const appRect = app.getBoundingClientRect();
  const topRect = topBar.getBoundingClientRect();

  const availableStage = vh - (topRect.height) - (appRect.top);
  const stageH = Math.max(availableStage, 200);
  document.documentElement.style.setProperty("--stageH", stageH + "px");

  const grid = document.getElementById("choiceGrid");
  if(!grid) return;

  const footerH = footer ? footer.getBoundingClientRect().height : 0;

  const stageStyle = getComputedStyle(stage);
  const stagePadY = (parseFloat(stageStyle.paddingTop) || 0) + (parseFloat(stageStyle.paddingBottom) || 0);

  const gridArea = stageH - stagePadY - footerH - 10;

  const cards = [...grid.querySelectorAll(".choiceCard")];
  if(!cards.length) return;

  const gap = parseFloat(getComputedStyle(grid).rowGap) || 10;

  const fixedPerCard = 78;
  const totalFixed = (fixedPerCard * cards.length) + (gap * (cards.length - 1));
  const imgH = Math.floor((gridArea - totalFixed) / cards.length);

  const finalImgH = Math.max(70, Math.min(imgH, 160));
  document.documentElement.style.setProperty("--choiceMobileImgH", finalImgH + "px");
}

function fitStageToViewport(){
  if(!matchMedia("(max-width: 520px)").matches) return;

  const app = document.querySelector(".app");
  const topBar = document.querySelector(".topBar");
  const stage = document.getElementById("stage");
  if(!app || !topBar || !stage) return;

  const vh = window.visualViewport?.height || window.innerHeight;

  const appRect = app.getBoundingClientRect();
  const topRect = topBar.getBoundingClientRect();

  const availableStage = vh - topRect.height - appRect.top;
  const stageH = Math.max(availableStage, 240);

  document.documentElement.style.setProperty("--stageH", stageH + "px");
}

function countNonTransparentPixels(ctx){
  const {width, height} = ctx.canvas;
  const img = ctx.getImageData(0,0,width,height).data;
  let n = 0;
  for(let i=3; i<img.length; i+=4){
    if(img[i] > 20) n++;
  }
  return n;
}

function drawTemplateText(ctx, text){
  const cw = ctx.canvas.width, ch = ctx.canvas.height;
  ctx.save();
  ctx.clearRect(0,0,cw,ch);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,cw,ch);

  ctx.fillStyle = "rgba(15,23,42,.55)";
  ctx.font = `900 ${Math.floor(Math.min(cw, ch) * 0.40)}px Tahoma, Arial, sans-serif`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.lineWidth = Math.max(6, Math.floor(Math.min(cw,ch)*0.02));
  ctx.setLineDash([2, 16]);
  ctx.strokeStyle = "rgba(15,23,42,.35)";
  ctx.strokeText(text, cw/2, ch/2);
  ctx.setLineDash([]);
  ctx.restore();
}

/* Coloring + SVG helpers */
function loadImg(url){
  return new Promise((resolve, reject)=>{
    if(!url) return reject(new Error("missing url"));
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>resolve(img);
    img.onerror = ()=>reject(new Error("image load failed: " + url));
    img.src = url;
  });
}/* =========================================================
  RANDOMIZATION (SAFE ‚Äî ID BASED)
========================================================= */

// Fisher‚ÄìYates shuffle (returns NEW array)
function shuffleArr(arr){
  const a = Array.isArray(arr) ? arr.slice() : [];
  for(let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// Deep clone (plain JSON)
function deepClone(o){
  return JSON.parse(JSON.stringify(o));
}

// Randomize ONE question safely
function randomizeQuestion(q){
  const Q = deepClone(q);

  switch(Q.type){

    case "multiple_choice":
    case "listen_choose":
      Q.choices = shuffleArr(Q.choices);
      break;

    case "match":
      Q.left  = shuffleArr(Q.left);
      Q.right = shuffleArr(Q.right);
      break;

    case "drag_drop":
      Q.draggable = shuffleArr(Q.draggable || Q.draggables);
      Q.targets   = shuffleArr(Q.targets || Q.dropZones);
      break;

    case "ordering":
      Q.tiles = shuffleArr(Q.tiles || Q.items);
      break;

    case "classification":
      Q.items      = shuffleArr(Q.items);
      Q.categories = shuffleArr(Q.categories);
      break;

    case "build_construct":
      Q.tiles = shuffleArr(Q.tiles);
      break;
  }

  return Q;
}

// Randomize entire lesson interactive block
function randomizeInteractive(interactive){
  if(!interactive) return interactive;

  const out = deepClone(interactive);

  // shuffle questions themselves
  out.questionBank = shuffleArr(out.questionBank).map(randomizeQuestion);

  // shuffle flow per item (keeps coverage)
  const newFlow = {};
  for(const [itemId, qIds] of Object.entries(out.flowByItem || {})){
    newFlow[itemId] = shuffleArr(qIds);
  }
  out.flowByItem = newFlow;

  return out;
}

function drawContain(ctx, img, pad=18){
  const cw = ctx.canvas.width, ch = ctx.canvas.height;
  const maxW = cw - pad*2, maxH = ch - pad*2;
  const s = Math.min(maxW / img.width, maxH / img.height);
  const w = img.width * s, h = img.height * s;
  const x = (cw - w)/2, y = (ch - h)/2;
  ctx.drawImage(img, x, y, w, h);
}
async function drawSvgToCanvas(ctx, svgUrl, cw, ch){
  const res = await fetch(svgUrl, {cache:"no-store"});
  if(!res.ok) throw new Error("SVG fetch failed");
  const svgText = await res.text();
  const blob = new Blob([svgText], {type:"image/svg+xml"});
  const url = URL.createObjectURL(blob);
  try{
    const img = await loadImg(url);
    ctx.clearRect(0,0,cw,ch);
    ctx.fillStyle="#ffffff";
    ctx.fillRect(0,0,cw,ch);
    drawContain(ctx, img, 18);
  } finally {
    URL.revokeObjectURL(url);
  }
}

function coverageFromMask(drawCtx, maskCtx){
  const w = drawCtx.canvas.width, h = drawCtx.canvas.height;
  const draw = drawCtx.getImageData(0,0,w,h).data;
  const mask = maskCtx.getImageData(0,0,w,h).data;

  let allowed = 0;
  let paintedInside = 0;

  for(let i=0; i<mask.length; i+=4){
    const maskA = mask[i+3];
    if(maskA > 20){
      allowed++;
      const drawA = draw[i+3];
      if(drawA > 20) paintedInside++;
    }
  }
  return allowed ? (paintedInside / allowed) : 0;
}

/* =========================================================
  DATA + FLOW
========================================================= */
const state = {
  data:null, level:null, section:null, lesson:null,
  flow:[], idx:0,
  q:{},
  dragId:"",
  selectedForTap:null,
  paint:null,
  trace:null
};

function findBy(arr, key, val){
  return (Array.isArray(arr)?arr:[])
    .find(x => String(x?.[key]||"").toLowerCase() === String(val||"").toLowerCase()) || null;
}
function findLesson(level, section, lesson){
  const sec = findBy(level?.sections, "sectionId", section);
  if(!sec) return {sec:null, les:null};
  const les = (Array.isArray(sec.lessons)?sec.lessons:[])
    .find(L => String(L.lessonId||"") === String(lesson)) || null;
  return {sec, les};
}
function buildFlow(lesson){
  const inter = lesson?.interactive || {};
  const byItem = inter.flowByItem || {};
  const bank = Array.isArray(inter.questionBank) ? inter.questionBank : [];
  const byId = new Map(bank.map(q => [q.id, q]));
  const out = [];

  Object.entries(byItem).forEach(([itemId, ids]) => {
    const seen = new Set();
    (ids||[]).forEach(qId => {
      if(seen.has(qId)) return;
      seen.add(qId);
      const qObj = byId.get(qId);
      if(qObj) out.push({itemId, qId, q: qObj});
    });
  });
  return out;
}

/* ===== Per-item question resolving ===== */
function getItemById(itemId){
  return (state.lesson?.items || []).find(it => String(it.itemId) === String(itemId)) || null;
}
function resolveQuestion(entry){
  const q = entry?.q || {};
  const item = getItemById(entry.itemId);
  const itemText = String(item?.front?.text || item?.back?.title || "").trim();

  const out = JSON.parse(JSON.stringify(q));
  out.prompt = out.prompt || {};

  if(String(out.prompt.text || "").includes("{item}")){
    out.prompt.text = String(out.prompt.text).replaceAll("{item}", itemText);
  }

  if(!out.prompt.imageUrl && item?.front?.imageUrl) out.prompt.imageUrl = item.front.imageUrl;
  if(!out.prompt.audioUrl && item?.front?.audioUrl) out.prompt.audioUrl = item.front.audioUrl;

  if(out.type === "trace_write"){
    if(!out.prompt.text) out.prompt.text = itemText ? `ÿßŸÉÿ™ÿ® ŸÉŸÑŸÖÿ©: ${itemText}` : "ÿßŸÉÿ™ÿ®";
    out.trace = out.trace || {};
    if(!out.trace.text) out.trace.text = itemText || out.traceText || out.letter || "ÿß";
  }

  if(out.type === "build_construct"){
    out.answer = out.answer || {};
    if(!out.answer.text && itemText) out.answer.text = itemText;
  }

  return out;
}

/* =========================================================
  GLOBAL DND (bind once)
========================================================= */
$(document).on("dragstart", "[data-dragid],[data-orderid]", function(e){
  state.dragId = $(this).attr("data-dragid") || $(this).attr("data-orderid") || "";
  $(this).addClass("dragging");
  try{ e.originalEvent.dataTransfer.setData("text/plain", state.dragId); }catch(_){}
});
$(document).on("dragend", "[data-dragid],[data-orderid]", function(){
  $(this).removeClass("dragging");
  state.dragId = "";
});
$(document).on("dragover", "[data-dropid],[data-orderid]", function(e){ e.preventDefault(); });
$(document).on("dragenter", "[data-dropid]", function(){ $(this).attr("data-active","1"); });
$(document).on("dragleave", "[data-dropid]", function(e){
  if(this.contains(e.relatedTarget)) return;
  $(this).attr("data-active","0");
});

/* =========================================================
  RENDER CORE
========================================================= */
function resetQ(){
  state.q = {};
  state.selectedForTap = null;
  state.paint = null;
  state.trace = null;
}
function curEntry(){ return state.flow[state.idx]; }
function progressText(){ return `${Math.min(state.idx+1, state.flow.length)}/${state.flow.length}`; }

function nextQ(){
  if(state.idx < state.flow.length - 1){
    state.idx++; resetQ(); render();
    return;
  }
  setTop({
    title:"ÿ£ÿ≠ÿ≥ŸÜÿ™! ÿßŸÜÿ™ŸáŸäÿ™ üéâ",
    sub:"ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ±ÿ¨Ÿàÿπ ÿ£Ÿà ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ",
    lesson: state.lesson?.title || "‚Äî",
    progress:`${state.flow.length}/${state.flow.length}`,
    type:"ÿßŸÑŸÜŸáÿßŸäÿ©",
    audioUrl:""
  });
  $stage().html(`
    <div class="panelKid text-center">
      <div style="font-size:clamp(28px, 2vw + 18px, 44px); font-weight:1000">üèÅ</div>
      <div class="mt-2" style="font-size:var(--fs2); font-weight:1000;">ÿ™ŸÖ ÿ•ŸÜŸáÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸÑŸáÿ∞ÿß ÿßŸÑÿØÿ±ÿ≥.</div>
      <div class="mt-2" style="color:rgba(15,23,42,.62); font-weight:900; line-height:1.7;">
        ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ±ÿ¨Ÿàÿπ ÿ£Ÿà ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖŸÜ ÿßŸÑÿ®ÿØÿßŸäÿ©.
      </div>
      <div class="d-flex gap-2 justify-content-center flex-wrap mt-3">
        <button class="btnKid btnSecondary px-3" id="doneBack" type="button">‚¨ÖÔ∏è ÿ±ÿ¨Ÿàÿπ</button>
        <button class="btnKid btnPrimary px-3" id="doneRestart" type="button">üîÑ ÿ•ÿπÿßÿØÿ© ŸÖŸÜ ÿßŸÑÿ®ÿØÿßŸäÿ©</button>
      </div>
    </div>
  `);
  $("#doneBack").on("click", ()=>history.back());
  $("#doneRestart").on("click", ()=>{ state.idx=0; resetQ(); render(); });
}

/* =========================================================
  SMALL TEMPLATE HELPERS
========================================================= */
function soundIconBtn(audioUrl){
  const aud = String(audioUrl || "").trim();
  return aud
    ? `<button class="iconBtn" type="button" data-choice-audio="${esc(aud)}" aria-label="ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™">
         <i class="bi bi-volume-up-fill" aria-hidden="true"></i>
       </button>`
    : `<button class="iconBtn" type="button" disabled title="ŸÑÿß ŸäŸàÿ¨ÿØ ÿµŸàÿ™" aria-label="ŸÑÿß ŸäŸàÿ¨ÿØ ÿµŸàÿ™">
         <i class="bi bi-volume-mute-fill" aria-hidden="true"></i>
       </button>`;
}

/* for list cards: ONLY if visible text exists */
function inlineAudioBtn(obj){
  if(!hasVisibleText(obj)) return "";
  const aud = String(obj?.audioUrl || "").trim();
  if(!aud) return "";
  return `
    <button class="iconBtn" type="button" data-audio="${esc(aud)}" aria-label="ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™">
      <i class="bi bi-volume-up-fill" aria-hidden="true"></i>
    </button>
  `;
}

function normalizeDragDrop(q){
  const drags = Array.isArray(q.draggable) ? q.draggable
             : Array.isArray(q.draggables) ? q.draggables
             : [];
  const drops = Array.isArray(q.targets) ? q.targets
             : Array.isArray(q.dropZones) ? q.dropZones
             : [];
  return { drags, drops };
}

/* =========================================================
  RENDERERS
========================================================= */

/* CHOICE (multiple_choice + listen_choose) */
function renderChoice(entry){
  const q = entry.q;
  const choices = Array.isArray(q.choices)?q.choices:[];
  state.q.selected ??= null;

  setTop({
    title: q?.prompt?.text || "ÿ≥ÿ§ÿßŸÑ",
    sub: hintFor(q.type),
    lesson: state.lesson?.title || "‚Äî",
    progress: progressText(),
    type: (q.type === "listen_choose") ? "ÿßÿ≥ÿ™ŸÖÿπ ŸàÿßÿÆÿ™ÿ±" : "ÿßÿÆÿ™Ÿäÿßÿ±",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  $stage().html(`
    <div class="choiceGrid" id="choiceGrid">
      ${choices.map((c, i) => {
        const id  = String(c.id ?? i);
        const img = visualSrc(c);
        const txt = pickText(c);
        const showMic = hasVisibleText(c) && String(c.audioUrl||"").trim().length>0;
        const micBtn = showMic ? soundIconBtn(c.audioUrl) : "";

        return `
          <div class="cardBtn choiceCard" role="button" tabindex="0"
            data-choice="${esc(id)}"
            data-selected="${state.q.selected===id ? "1":"0"}">

            <div class="choiceImgWrap">
              ${ img
                ? `<img class="choiceImg" src="${esc(img)}" alt=""/>`
                : `<div class="choiceNoImg"><span class="pill">ÿ®ÿØŸàŸÜ ÿµŸàÿ±ÿ©</span></div>`
              }

              <div class="choiceMetaMobile">
                <div class="choiceNameMobile">${esc(txt || "‚Äî")}</div>
                ${micBtn}
              </div>
            </div>

            <div class="choiceMetaDesktop">
              <div class="choiceNameDesktop">${esc(txt || "‚Äî")}</div>
              ${micBtn}
            </div>

          </div>
        `;
      }).join("")}
    </div>

    ${footerControls()}
  `);

  fitChoiceCardsHard();
  $(window).off("resize.fitChoice").on("resize.fitChoice", ()=>fitChoiceCardsHard());

  $stage()
    .off("click.choice").on("click.choice", "[data-choice]", function(e){
      if($(e.target).is("[data-choice-audio]")) return;
      state.q.selected = $(this).attr("data-choice");
      render();
    })
    .off("click.choiceAudio").on("click.choiceAudio", "[data-choice-audio]", function(e){
      e.stopPropagation();
      playSound($(this).attr("data-choice-audio"));
    });

  wireFooter();
}

/* MATCH */
function renderMatch(entry){
  const q = entry.q;
  const left  = Array.isArray(q.left)?q.left:[];
  const right = Array.isArray(q.right)?q.right:[];
  state.q.leftPick ??= null;
  state.q.pairs ??= {};

  setTop({
    title: q?.prompt?.text || "ÿ∑ÿßÿ®ŸÇ",
    sub: hintFor("match"),
    lesson: state.lesson?.title || "‚Äî",
    progress: progressText(),
    type: `ŸÖÿ∑ÿßÿ®ŸÇÿ© (${Object.keys(state.q.pairs).length}/${left.length})`,
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const rows = Math.max(left.length, right.length);

  $stage().html(`
    <div class="panelKid panelFlex">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <p class="panelTitle m-0">ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ© <small>ÿßŸÑŸäÿ≥ÿßÿ± ŸÖÿπ ÿßŸÑŸäŸÖŸäŸÜ (ÿµŸÅ ÿ®ÿµŸÅ)</small></p>

        <div class="d-flex align-items-center gap-2">
          <button class="btnKid btnSecondary px-3" id="matchClear" type="button">ŸÖÿ≥ÿ≠</button>
          <span class="pill">ÿßÿÆÿ™ÿ± Ÿäÿ≥ÿßÿ± ÿ´ŸÖ ŸäŸÖŸäŸÜ</span>
        </div>
      </div>

      <div class="pairGrid panelBodyGrow mt-2" id="pairGrid">
        ${Array.from({length: rows}).map((_, i) => {
          const l = left[i] || null;
          const r = right[i] || null;

          const lHtml = l ? (() => {
            const img = visualSrc(l);
            const txt = pickText(l);
            const audioHtml = inlineAudioBtn(l);
            return `
              <div class="cardBtn" role="button" tabindex="0"
                   data-left="${esc(l.id)}"
                   data-selected="${state.q.leftPick===l.id ? "1":"0"}">
                <div class="cardLeft">
                  ${img
                    ? `<img class="matchLeftImg" src="${esc(img)}" alt=""/>`
                    : `<div class="cardText">${esc(txt || "‚Äî")}</div>`
                  }
                </div>
                ${audioHtml ? `<div class="cardSide">${audioHtml}</div>` : ``}
              </div>
            `;
          })() : `<div></div>`;

          const rHtml = r ? (() => {
            const txt = pickText(r);
            const audioHtml = inlineAudioBtn(r);
            return `
              <div class="cardBtn" role="button" tabindex="0" data-right="${esc(r.id)}">
                <div class="cardLeft">
                  <div class="cardText">${esc(txt || "‚Äî")}</div>
                </div>
                ${audioHtml ? `<div class="cardSide">${audioHtml}</div>` : ``}
              </div>
            `;
          })() : `<div></div>`;

          return `<div class="pairRow">${lHtml}${rHtml}</div>`;
        }).join("")}
      </div>
    </div>

    ${footerControls()}
  `);

  $stage()
    .off("click.matchAudio").on("click.matchAudio", "[data-audio]", function(e){
      e.stopPropagation();
      playSound($(this).attr("data-audio"));
    })
    .off("click.matchL").on("click.matchL", "[data-left]", function(){
      state.q.leftPick = $(this).attr("data-left");
      render();
    })
    .off("click.matchR").on("click.matchR", "[data-right]", function(){
      const rid = $(this).attr("data-right");
      const lid = state.q.leftPick;
      if(!lid){ toast("ÿ™ŸÜÿ®ŸäŸá","ÿßÿÆÿ™ÿ± ÿπŸÜÿµÿ±Ÿãÿß ŸÖŸÜ ÿßŸÑŸäÿ≥ÿßÿ± ÿ£ŸàŸÑŸãÿß"); return; }
      state.q.pairs = state.q.pairs || {};
      state.q.pairs[lid] = rid;
      state.q.leftPick = null;
      render();
    })
    .off("click.matchClear").on("click.matchClear", "#matchClear", function(){
      state.q.leftPick=null; state.q.pairs={}; render();
    });

  wireFooter();
}

/* DRAG & DROP */
function renderDragDrop(entry){
  const q = entry.q;
  const { drags, drops } = normalizeDragDrop(q);
  state.q.assign ??= {};

  setTop({
    title: q?.prompt?.text || "ÿßÿ≥ÿ≠ÿ® Ÿàÿ∂ÿπ",
    sub: hintFor("drag_drop"),
    lesson: state.lesson?.title || "‚Äî",
    progress: progressText(),
    type: "ÿ≥ÿ≠ÿ® Ÿàÿ•ŸÅŸÑÿßÿ™",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const leftHtml = drags.map(d => {
    const used = Object.values(state.q.assign).includes(String(d.id));
    const img = visualSrc(d);
    const txt = pickText(d);
    const audioHtml = inlineAudioBtn(d);

    return `
      <div class="cardBtn dragItem" role="button" tabindex="0"
        ${isTouch() ? "" : `draggable="true"`}
        data-dragid="${esc(d.id)}"
        style="${used ? "opacity:.55" : ""}">
        <div class="cardLeft">
          ${img ? `<img class="cardImg" src="${esc(img)}" alt=""/>` : ``}
          <div class="cardText">${esc(txt || "‚Äî")}</div>
        </div>
        ${audioHtml ? `<div class="cardSide">${audioHtml}</div>` : ``}
      </div>
    `;
  }).join("");

  const rightHtml = drops.map(z => {
    const tid = String(z.id);
    const fillId = state.q.assign[tid] || "";
    const fillObj = drags.find(d => String(d.id) === String(fillId));
    const fillText = fillObj ? pickText(fillObj) : (isTouch() ? "ÿßÿ∂ÿ∫ÿ∑ ŸÑÿßÿÆÿ™Ÿäÿßÿ±" : "ÿßÿ≥ÿ≠ÿ® ŸáŸÜÿß");

    const img = visualSrc(z);
    const label = String(z.label ?? pickText(z) ?? "").trim();

    return `
      <div class="dropZone" data-dropid="${esc(tid)}" data-active="0">
        <div class="d-flex align-items-center gap-2 min-w-0" style="min-width:0">
          ${img ? `<img class="cardImg" src="${esc(img)}" alt=""/>` : ``}
          <div style="font-weight:1000; font-size:var(--fs1); overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            ${esc(label || "‚Äî")}
          </div>
        </div>
        <div class="zoneFill">${esc(fillText || "‚Äî")}</div>
      </div>
    `;
  }).join("");

  $stage().html(`
    <div class="twoColGrid">
      <div class="panelKid panelFlex">
        <p class="panelTitle">ÿßŸÑÿπŸÜÿßÿµÿ± <small>${isTouch() ? "ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±" : "ÿßÿ≥ÿ≠ÿ®"}</small></p>
        <div class="vList panelBodyGrow" id="ddLeft">${leftHtml}</div>
        ${isTouch() ? `<div class="mt-2"><span class="pill">ÿßŸÑŸÖÿÆÿ™ÿßÿ±: <span id="tapPick">‚Äî</span></span></div>` : ``}
      </div>

      <div class="panelKid panelFlex">
        <p class="panelTitle">ÿßŸÑÿ£ŸáÿØÿßŸÅ <small>${isTouch() ? "ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑŸáÿØŸÅ ŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿÆÿ™ÿßÿ±" : "ÿ•ŸÅŸÑÿßÿ™"}</small></p>
        <div class="vList panelBodyGrow" id="ddRight">${rightHtml}</div>
        <div class="d-flex gap-2 flex-wrap mt-3">
          <button class="btnKid btnSecondary px-3" id="ddClear" type="button">ŸÖÿ≥ÿ≠</button>
        </div>
      </div>
    </div>

    ${footerControls()}
  `);

  if(isTouch()){
    const name = state.selectedForTap
      ? pickText(drags.find(d=>String(d.id)===String(state.selectedForTap))||{})
      : "‚Äî";
    $("#tapPick").text(name || "‚Äî");
  }

  $stage()
    .off("click.ddAudio").on("click.ddAudio", "[data-audio]", function(e){
      e.stopPropagation();
      playSound($(this).attr("data-audio"));
    })
    .off("drop.dd").on("drop.dd", "[data-dropid]", function(e){
      e.preventDefault();
      $(this).attr("data-active","0");

      const targetId = $(this).attr("data-dropid");
      const dragId = state.dragId || (()=>{ try{return e.originalEvent.dataTransfer.getData("text/plain")}catch(_){return ""} })();
      if(!dragId || !targetId) return;

      state.q.assign = state.q.assign || {};
      state.q.assign[targetId] = String(dragId);
      render();
    })
    .off("click.ddtapDrag").on("click.ddtapDrag", "#ddLeft [data-dragid]", function(e){
      if($(e.target).closest("[data-audio]").length) return;
      if(!isTouch()) return;
      state.selectedForTap = $(this).attr("data-dragid");
      render();
    })
    .off("click.ddtapDrop").on("click.ddtapDrop", "#ddRight [data-dropid]", function(){
      if(!isTouch()) return;
      const targetId = $(this).attr("data-dropid");
      if(!state.selectedForTap){ toast("ÿ™ŸÜÿ®ŸäŸá","ÿßÿÆÿ™ÿ± ÿπŸÜÿµÿ±Ÿãÿß ÿ£ŸàŸÑŸãÿß"); return; }
      state.q.assign = state.q.assign || {};
      state.q.assign[targetId] = String(state.selectedForTap);
      state.selectedForTap = null;
      render();
    })
    .off("click.ddClear").on("click.ddClear", "#ddClear", function(){
      state.q.assign = {}; state.selectedForTap=null; render();
    });

  wireFooter();
}

/* ORDERING */
function renderOrdering(entry){
  const q = entry.q;
  const items = Array.isArray(q.tiles) ? q.tiles
             : Array.isArray(q.items) ? q.items
             : [];
  state.q.order ??= items.map(x => String(x.id));

  setTop({
    title: q?.prompt?.text || "ÿ±ÿ™Ÿëÿ®",
    sub: hintFor("ordering"),
    lesson: state.lesson?.title || "‚Äî",
    progress: progressText(),
    type: "ÿ™ÿ±ÿ™Ÿäÿ®",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const byId = new Map(items.map(it => [String(it.id), it]));
  const rows = state.q.order.map((id, idx) => {
    const it = byId.get(String(id)) || {};
    const img = visualSrc(it);
    const txt = pickText(it);
    const audioHtml = inlineAudioBtn(it);

    return `
      <div class="cardBtn ${isTouch() ? "" : "dragItem"}"
           ${isTouch() ? "" : `draggable="true"`}
           data-orderid="${esc(id)}" data-index="${idx}">
        <div class="cardLeft">
          <div class="orderIdx">${idx+1}</div>
          ${img ? `<img class="cardImg" src="${esc(img)}" alt=""/>` : ``}
          <div class="cardText">${esc(txt || "‚Äî")}</div>
        </div>

        <div class="d-flex gap-2 align-items-center">
          ${audioHtml ? `<div class="cardSide">${audioHtml}</div>` : ``}

          ${isTouch() ? `
            <button class="iconBtn" type="button" data-move="up" ${idx===0?"disabled":""}>‚¨ÜÔ∏è</button>
            <button class="iconBtn" type="button" data-move="down" ${idx===state.q.order.length-1?"disabled":""}>‚¨áÔ∏è</button>
          ` : `<span class="pill">‚ÜïÔ∏è</span>`}
        </div>
      </div>
    `;
  }).join("");

  $stage().html(`
    <div class="panelKid panelFlex">
      <p class="panelTitle">ÿ±ÿ™Ÿëÿ® ÿßŸÑÿπŸÜÿßÿµÿ± <small>${isTouch() ? "ÿ®ÿßŸÑÿ£ÿ≥ŸáŸÖ" : "ÿßÿ≥ÿ≠ÿ® ŸÑÿ£ÿπŸÑŸâ/ÿ£ÿ≥ŸÅŸÑ"}</small></p>
      <div class="vList panelBodyGrow" id="orderList">${rows}</div>
    </div>

    ${footerControls()}
  `);

  $stage()
    .off("click.orderAudio").on("click.orderAudio", "[data-audio]", function(e){
      e.stopPropagation();
      playSound($(this).attr("data-audio"));
    })
    .off("click.orderMove").on("click.orderMove", "[data-move]", function(e){
      e.stopPropagation();
      const dir = $(this).attr("data-move");
      const $row = $(this).closest("[data-orderid]");
      const idx = Number($row.attr("data-index"));
      const arr = (state.q.order || []).slice();
      const swapWith = dir === "up" ? idx-1 : idx+1;
      if(swapWith < 0 || swapWith >= arr.length) return;
      [arr[idx], arr[swapWith]] = [arr[swapWith], arr[idx]];
      state.q.order = arr;
      render();
    })
    .off("drop.order").on("drop.order", "[data-orderid]", function(e){
      e.preventDefault();
      if(isTouch()) return;

      const targetId = $(this).attr("data-orderid");
      const dragId = state.dragId;
      if(!dragId || !targetId || dragId === targetId) return;

      const arr = (state.q.order || []).slice();
      const from = arr.indexOf(String(dragId));
      const to   = arr.indexOf(String(targetId));
      if(from < 0 || to < 0) return;
      arr.splice(to, 0, arr.splice(from, 1)[0]);
      state.q.order = arr;
      render();
    });

  wireFooter();
}

/* CLASSIFICATION */
function renderClassification(entry){
  const q = entry.q;
  const items = Array.isArray(q.items)?q.items:[];
  const cats  = Array.isArray(q.categories)?q.categories:[];
  state.q.catAssign ??= {};

  setTop({
    title: q?.prompt?.text || "ÿµŸÜŸëŸÅ",
    sub: hintFor("classification"),
    lesson: state.lesson?.title || "‚Äî",
    progress: progressText(),
    type: "ÿ™ÿµŸÜŸäŸÅ",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const itemsHtml = items.map(it => {
    const used = !!state.q.catAssign[String(it.id)];
    const img = visualSrc(it);
    const txt = pickText(it);
    const audioHtml = inlineAudioBtn(it);
    return `
      <div class="cardBtn dragItem" role="button" tabindex="0"
        ${isTouch() ? "" : `draggable="true"`}
        data-dragid="${esc(it.id)}"
        style="${used ? "opacity:.55" : ""}">
        <div class="cardLeft">
          ${img ? `<img class="cardImg" src="${esc(img)}" alt=""/>` : ``}

          <div class="clsTitleRow">
            ${txt ? `<div class="cardText">${esc(txt)}</div>` : ``}
            ${audioHtml ? `<div class="cardSide">${audioHtml}</div>` : ``}
          </div>
        </div>
      </div>
    `;
  }).join("");

  const catsHtml = cats.map(c => {
    const label = String(c.label ?? c.name ?? c.text ?? "");
    const assigned = items
      .filter(it => String(state.q.catAssign[String(it.id)]||"") === String(c.id))
      .map(it => ({ id: String(it.id), text: pickText(it) }))
      .filter(x => x.text);

    return `
      <div class="dropZone" data-dropid="${esc(c.id)}" data-active="0"
           style="flex-direction:column; align-items:stretch;">
        <div class="d-flex align-items-center justify-content-between gap-2">
          <div style="font-weight:1000; font-size:var(--fs1);">${esc(label || "ŸÅÿ¶ÿ©")}</div>
          <span class="pill">${assigned.length} ÿπŸÜÿµÿ±</span>
        </div>

        <div class="mt-2" style="display:flex; gap:8px; flex-wrap:wrap;">
          ${
            assigned.length
              ? assigned.map(a => `
                  <span class="clsChip">
                    <span>${esc(a.text)}</span>
                    <button type="button" class="clsX"
                            title="ÿ≠ÿ∞ŸÅ" aria-label="ÿ≠ÿ∞ŸÅ"
                            data-unassign="${esc(a.id)}">√ó</button>
                  </span>
                `).join("")
              : `<span class="pill">ÿ∂ÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ŸáŸÜÿß</span>`
          }
        </div>
      </div>
    `;
  }).join("");

  $stage().html(`
    <div class="twoColGrid">
      <div class="panelKid panelFlex">
        <p class="panelTitle">ÿßŸÑÿπŸÜÿßÿµÿ± <small>${isTouch() ? "ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±" : "ÿßÿ≥ÿ≠ÿ®"}</small></p>
        <div class="panelBodyGrow" id="clsItems" style="display:flex; flex-direction:column; gap: var(--gap);">${itemsHtml}</div>
        ${isTouch() ? `<div class="mt-2"><span class="pill">ÿßŸÑŸÖÿÆÿ™ÿßÿ±: <span id="clsPick">‚Äî</span></span></div>` : ``}
      </div>

      <div class="panelKid panelFlex">
        <p class="panelTitle">ÿßŸÑŸÅÿ¶ÿßÿ™ <small>${isTouch() ? "ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑŸÅÿ¶ÿ© ŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿÆÿ™ÿßÿ±" : "ÿ•ŸÅŸÑÿßÿ™"}</small></p>
        <div class="panelBodyGrow vList" id="clsCats">${catsHtml}</div>
      </div>
    </div>

    ${footerControls()}
  `);

  if(isTouch()){
    const name = state.selectedForTap ? pickText(items.find(d=>String(d.id)===String(state.selectedForTap))||{}) : "‚Äî";
    $("#clsPick").text(name || "‚Äî");
  }

  $stage()
    .off("click.clsAudio").on("click.clsAudio", "[data-audio]", function(e){
      e.stopPropagation();
      playSound($(this).attr("data-audio"));
    })
    .off("drop.cls").on("drop.cls", "#clsCats [data-dropid]", function(e){
      e.preventDefault();
      $(this).attr("data-active","0");
      const catId = $(this).attr("data-dropid");
      const itemId = state.dragId;
      if(!catId || !itemId) return;
      state.q.catAssign = state.q.catAssign || {};
      state.q.catAssign[String(itemId)] = String(catId);
      render();
    })
    .off("click.clsPick").on("click.clsPick", "#clsItems [data-dragid]", function(e){
      if($(e.target).closest("[data-audio]").length) return;
      if(!isTouch()) return;
      state.selectedForTap = $(this).attr("data-dragid");
      render();
    })
    .off("click.clsCat").on("click.clsCat", "#clsCats [data-dropid]", function(e){
      if(!isTouch()) return;
      if($(e.target).closest("[data-unassign]").length) return;
      const catId = $(this).attr("data-dropid");
      if(!state.selectedForTap){ toast("ÿ™ŸÜÿ®ŸäŸá","ÿßÿÆÿ™ÿ± ÿπŸÜÿµÿ±Ÿãÿß ÿ£ŸàŸÑŸãÿß"); return; }
      state.q.catAssign = state.q.catAssign || {};
      state.q.catAssign[String(state.selectedForTap)] = String(catId);
      state.selectedForTap = null;
      render();
    })
    .off("click.clsRemove").on("click.clsRemove", "[data-unassign]", function(e){
      e.stopPropagation();
      const itemId = $(this).attr("data-unassign");
      if(!itemId) return;
      if(state.q.catAssign) delete state.q.catAssign[String(itemId)];
      render();
    });

  wireFooter();
}

/* BUILD */
function renderBuild(entry){
  const q = entry.q;
  const tiles = Array.isArray(q.tiles)?q.tiles:[];
  const target = norm(q?.answer?.text || "");

  state.q.built ??= [];
  const builtText = state.q.built
    .map(id => tiles.find(t => String(t.id)===String(id)))
    .filter(Boolean).map(t => pickText(t)).join("");

  setTop({
    title: q?.prompt?.text || "ŸÉŸàŸëŸÜ ÿßŸÑŸÉŸÑŸÖÿ©",
    sub: hintFor("build_construct"),
    lesson: state.lesson?.title || "‚Äî",
    progress: progressText(),
    type: "ÿ™ŸÉŸàŸäŸÜ",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const slotCount = Math.max(target.length || 0, state.q.built.length, 3);
  const slots = Array.from({length: slotCount}).map((_,i)=>`
    <div class="pill" style="min-width:56px; justify-content:center; font-size:var(--fs2); padding:10px 12px;">
      ${esc(builtText[i]||" ")}
    </div>
  `).join("");

  $stage().html(`
    <div class="panelKid" id="buildWrap">
      <p class="panelTitle">ŸÉŸÑŸÖÿ© ÿßŸÑÿ™ŸÉŸàŸäŸÜ <small>ŸÉŸàŸëŸÜ ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©</small></p>

      <div class="d-flex gap-2 flex-wrap justify-content-center p-3"
           style="border-radius:22px;border:1px solid rgba(15,23,42,.10);background:rgba(255,255,255,.98);box-shadow:0 8px 14px rgba(15,23,42,.06);">
        ${slots}
      </div>

      <div class="d-flex gap-2 flex-wrap justify-content-center mt-3">
        <button class="btnKid btnSecondary px-3" id="buildBack" type="button">ÿ≠ÿ∞ŸÅ</button>
        <button class="btnKid btnSecondary px-3" id="buildClear" type="button">ŸÖÿ≥ÿ≠</button>
        <span class="pill">ÿßŸÑŸÜÿßÿ™ÿ¨: <b>${esc(builtText||"‚Äî")}</b></span>
      </div>

      <div class="d-flex gap-2 flex-wrap justify-content-center mt-3" id="tiles">
        ${tiles.map(t => `
          <button class="btnKid btnSecondary" style="height:48px; min-width:64px;" type="button" data-tile="${esc(t.id)}">
            ${esc(pickText(t) || t.id)}
          </button>
        `).join("")}
      </div>

      <div class="mt-3 text-center" style="color:rgba(15,23,42,.62);font-weight:900;line-height:1.7;">
        ÿßŸÑŸáÿØŸÅ: <b>${esc(target || "‚Äî")}</b>
      </div>
    </div>

    ${footerControls()}
  `);

  $stage()
    .off("click.tile").on("click.tile", "[data-tile]", function(){
      state.q.built = state.q.built || [];
      state.q.built.push($(this).attr("data-tile"));
      render();
    })
    .off("click.buildBack").on("click.buildBack", "#buildBack", function(){
      state.q.built = state.q.built || [];
      state.q.built.pop();
      render();
    })
    .off("click.buildClear").on("click.buildClear", "#buildClear", function(){
      state.q.built = [];
      render();
    });

  wireFooter();
}

/* COLORING */
async function renderColoring(entry){
  const q = entry.q;

  setTop({
    title: q?.prompt?.text || "ÿ™ŸÑŸàŸäŸÜ",
    sub: hintFor("coloring"),
    lesson: state.lesson?.title || "‚Äî",
    progress: progressText(),
    type: "ÿ™ŸÑŸàŸäŸÜ",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const cw = Number(q?.canvas?.width  || 900);
  const ch = Number(q?.canvas?.height || 520);

  const baseUrl = String(q?.canvas?.baseImageUrl || "").trim();
  const maskUrl = String(q?.canvas?.maskImageUrl || "").trim();
  const hintUrl = String(q?.canvas?.targetHintImageUrl || "").trim();

  const requiredCoverage = Number(q?.successCriteria?.coveragePercent ?? 0.6);

  const palette = Array.isArray(q?.palette) && q.palette.length ? q.palette : [
    "#111827","#ef4444","#f59e0b","#22c55e","#3b82f6","#a855f7","#ec4899","#06b6d4"
  ];
  const brushSizeDefault = Number(q?.brush?.size || 18);
  const brushOpacityDefault = Number(q?.brush?.opacity || 1);

  $stage().html(`
    <div class="grid2_1">
      <div class="panelKid">
        <p class="panelTitle">ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ™ŸÑŸàŸäŸÜ <small>${baseUrl ? "ŸÑŸàŸëŸÜ ŸÅŸàŸÇ ÿßŸÑÿ¥ŸÉŸÑ" : "ÿ™ŸÑŸàŸäŸÜ ÿ≠ÿ±"}</small></p>
        <div style="position:relative;">
          <canvas class="paintCanvas" id="paintBase" width="${cw}" height="${ch}"
                  style="position:absolute; inset:0; z-index:1;"></canvas>

          <canvas class="paintCanvas" id="paintHintLayer" width="${cw}" height="${ch}"
                  style="position:absolute; inset:0; z-index:2; opacity:0; pointer-events:none;"></canvas>

          <canvas class="paintCanvas" id="paintDraw" width="${cw}" height="${ch}"
                  style="position:relative; z-index:3; background:transparent;"></canvas>
        </div>
      </div>

      <div class="panelKid">
        <p class="panelTitle">ÿ£ÿØŸàÿßÿ™ <small>ÿßÿÆÿ™ÿ± ŸÑŸàŸÜŸãÿß Ÿàÿ≠ÿ¨ŸÖŸãÿß</small></p>

        <div class="d-flex gap-2 flex-wrap" id="paintPalette"></div>

        <div class="mt-3">
          <div class="paintSizeRow">
            <span class="pill paintSizeLabel">ÿ≠ÿ¨ŸÖ ÿßŸÑŸÅÿ±ÿ¥ÿßÿ©</span>
            <span class="pill paintSizeVal" id="paintSizeVal">‚Äî</span>

            <input class="form-range paintSizeRange"
              id="paintSize"
              type="range"
              min="6"
              max="52"
              step="1"
              value="${brushSizeDefault}">
          </div>

          <div class="mt-3">
            <div class="paintOpacityRow">
              <span class="pill paintOpacityLabel">ÿßŸÑÿ¥ŸÅÿßŸÅŸäÿ©</span>
              <span class="pill paintOpacityVal" id="paintOpacityVal">‚Äî</span>

              <input class="form-range paintOpacityRange"
                id="paintOpacity"
                type="range"
                min="0.2"
                max="1"
                step="0.05"
                value="${brushOpacityDefault}">
            </div>
          </div>

          <div class="d-flex gap-2 flex-wrap mt-3">
            <button class="btnKid btnSecondary px-3" id="paintUndo" type="button">ÿ™ÿ±ÿßÿ¨ÿπ</button>
            <button class="btnKid btnSecondary px-3" id="paintClear" type="button">ŸÖÿ≥ÿ≠</button>
            <button class="btnKid btnSecondary px-3" id="paintHint" type="button" ${hintUrl ? "" : "disabled"}>ÿ™ŸÑŸÖŸäÿ≠</button>
          </div>

          <div class="mt-3">
            <div class="pill"
                 style="display:flex;justify-content:space-between;align-items:center;gap:12px;font-weight:900;">
              <span>ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤: <b><span id="colorPct">0</span>%</b></span>
              <span>ÿ¥ÿ±ÿ∑ ÿßŸÑŸÜÿ¨ÿßÿ≠: <b>${Math.round(requiredCoverage*100)}%</b></span>
            </div>
          </div>

          ${footerControls()}
        </div>
      </div>
    </div>
  `);

  wireFooter();

  $("#paintPalette").html(
    palette.map((c,i)=>`
      <div class="swatch" data-color="${esc(c)}" data-selected="${i===0?"1":"0"}" style="background:${esc(c)}"></div>
    `).join("")
  );

  const baseCanvas = $("#paintBase")[0];
  const hintCanvas = $("#paintHintLayer")[0];
  const drawCanvas = $("#paintDraw")[0];

  const bctx = baseCanvas.getContext("2d", { willReadFrequently:true });
  const hctx = hintCanvas.getContext("2d", { willReadFrequently:true });
  const dctx = drawCanvas.getContext("2d", { willReadFrequently:true });

  const maskC = document.createElement("canvas");
  maskC.width = cw; maskC.height = ch;
  const mctx = maskC.getContext("2d", { willReadFrequently:true });

  bctx.clearRect(0,0,cw,ch);
  bctx.fillStyle = "#ffffff";
  bctx.fillRect(0,0,cw,ch);
  hctx.clearRect(0,0,cw,ch);
  dctx.clearRect(0,0,cw,ch);
  mctx.clearRect(0,0,cw,ch);

  try{ if(baseUrl){ const img = await loadImg(baseUrl); drawContain(bctx, img, 18); } }catch(_){}
  try{ if(hintUrl){ const img = await loadImg(hintUrl); drawContain(hctx, img, 18); } }catch(_){}

  try{
    if(maskUrl){
      const img = await loadImg(maskUrl);
      drawContain(mctx, img, 18);
    }else{
      mctx.fillStyle = "rgba(0,0,0,1)";
      mctx.fillRect(0,0,cw,ch);
    }
  }catch(_){
    mctx.clearRect(0,0,cw,ch);
    mctx.fillStyle = "rgba(0,0,0,1)";
    mctx.fillRect(0,0,cw,ch);
  }

  state.paint = {
    drawCtx: dctx,
    maskCtx: mctx,
    undo: [],
    size: brushSizeDefault,
    opacity: brushOpacityDefault,
    color: palette[0],
    requiredCoverage
  };

  function pushUndo(){
    // ensure we store a valid (already-masked) snapshot
    applyMaskToDrawing(dctx, mctx);
    const img = dctx.getImageData(0,0,cw,ch);
    state.paint.undo.push(img);
    if(state.paint.undo.length > 20) state.paint.undo.shift();
  }
  pushUndo();

  function updateLabels(){
    $("#paintSizeVal").text(String(state.paint.size));
    $("#paintOpacityVal").text(String(state.paint.opacity));
  }
  updateLabels();

  function updateColorProgress(){
    if(!state.paint?.drawCtx || !state.paint?.maskCtx) return;
    // always enforce mask before measuring
    applyMaskToDrawing(state.paint.drawCtx, state.paint.maskCtx);

    const pct = coverageFromMask(state.paint.drawCtx, state.paint.maskCtx);
    const percent = Math.min(100, Math.floor(pct * 100));
    $("#colorPct").text(String(percent));
  }
  updateColorProgress();

  $("#paintPalette").off("click").on("click", ".swatch", function(){
    const c = $(this).attr("data-color");
    state.paint.color = c;
    $(".swatch").attr("data-selected","0");
    $(this).attr("data-selected","1");
  });

  $("#paintSize").off("input").on("input", function(){
    state.paint.size = Number(this.value);
    updateLabels();
  });
  $("#paintOpacity").off("input").on("input", function(){
    state.paint.opacity = Number(this.value);
    updateLabels();
  });

  $("#paintUndo").off("click").on("click", function(){
    const u = state.paint.undo;
    if(u.length <= 1) return;
    u.pop();
    dctx.putImageData(u[u.length-1],0,0);
    updateColorProgress();
  });

  $("#paintClear").off("click").on("click", function(){
    pushUndo();
    dctx.clearRect(0,0,cw,ch);
    applyMaskToDrawing(dctx, mctx);
    pushUndo();
    updateColorProgress();
  });

  $("#paintHint").off(".hint");
  $("#paintHint").on("pointerdown.hint", function(e){
    if(!hintUrl) return;
    e.preventDefault();
    $("#paintHintLayer").css("opacity","0.85");
  });
  $(window).off(".hint");
  $(window).on("pointerup.hint pointercancel.hint", function(){
    $("#paintHintLayer").css("opacity","0");
  });

  installPointerDraw({
    canvas: drawCanvas,
    ctx: dctx,
    getStrokeStyle: () => ({
      color: state.paint.color,
      size: state.paint.size,
      opacity: state.paint.opacity,
      composite: "source-over"
    }),
    onStrokeStart: () => pushUndo(),
    onDraw: () => applyMaskToDrawing(dctx, mctx),
    onEnd: () => updateColorProgress()
  });
}

/* TRACE */
async function renderTrace(entry){
  const q = entry.q;

  setTop({
    title: q?.prompt?.text || "ŸÉÿ™ÿßÿ®ÿ©",
    sub: hintFor("trace_write"),
    lesson: state.lesson?.title || "‚Äî",
    progress: progressText(),
    type: "ŸÉÿ™ÿßÿ®ÿ© Ÿàÿ™ÿ™ÿ®ÿπ",
    audioUrl: q?.prompt?.audioUrl || ""
  });

  const cw = Number(q?.canvas?.width  || 900);
  const ch = Number(q?.canvas?.height || 520);

  const traceText = String(q?.trace?.text || q?.traceText || q?.letter || "").trim()
                 || String(q?.target?.text || "").trim()
                 || "ÿß";

  const svgUrl = String(q?.trace?.svgUrl || q?.target?.svgUrl || "").trim();

  let minInkPixels = Number(q?.minInkPixels || 0);
  const minInkPercent = Number(q?.successCriteria?.minInkPercent || 0);
  if(!minInkPixels && minInkPercent){
    minInkPixels = Math.floor((cw * ch) * minInkPercent);
  }
  if(!minInkPixels) minInkPixels = Math.floor((cw*ch) * 0.006);

  $stage().html(`
    <div class="grid2_1">
      <div class="panelKid">
        <p class="panelTitle">ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÉÿ™ÿßÿ®ÿ© <small>ÿßŸÉÿ™ÿ® ŸÅŸàŸÇ ÿßŸÑŸÇÿßŸÑÿ®</small></p>
        <div style="position:relative;">
          <canvas class="traceCanvas" id="traceBase" width="${cw}" height="${ch}"
                  style="position:absolute; inset:0; z-index:1;"></canvas>
          <canvas class="traceCanvas" id="traceDraw" width="${cw}" height="${ch}"
                  style="position:relative; z-index:2; background:transparent;"></canvas>
        </div>
      </div>

      <div class="panelKid">
        <p class="panelTitle">ÿ£ÿØŸàÿßÿ™</p>

        <div class="mt-3">
          <div class="d-flex align-items-center justify-content-between">
            <span class="pill">ÿ≥ŸÖŸÉ ÿßŸÑŸÇŸÑŸÖ</span>
            <span class="pill" id="traceSizeVal">‚Äî</span>
          </div>
          <input class="form-range mt-2" id="traceSize" type="range" min="6" max="44" step="1" value="18">
        </div>

        <div class="d-flex gap-2 flex-wrap mt-3">
          <button class="btnKid btnSecondary px-3" id="traceUndo" type="button">ÿ™ÿ±ÿßÿ¨ÿπ</button>
          <button class="btnKid btnSecondary px-3" id="traceClear" type="button">ŸÖÿ≥ÿ≠</button>
        </div>

        <div class="mt-3" style="color:rgba(15,23,42,.62);font-weight:900;line-height:1.7;">
          ÿ¥ÿ±ÿ∑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ: Ÿàÿ¨ŸàÿØ ŸÉÿ™ÿßÿ®ÿ© ŸÉÿßŸÅŸäÿ© ÿπŸÑŸâ ÿßŸÑŸÑŸàÿ≠ÿ©.
        </div>

        ${footerControls()}
      </div>
    </div>
  `);

  wireFooter();

  const base = $("#traceBase")[0];
  const draw = $("#traceDraw")[0];

  const bctx = base.getContext("2d", { willReadFrequently:true });
  const dctx = draw.getContext("2d", { willReadFrequently:true });

  bctx.clearRect(0,0,cw,ch);
  bctx.fillStyle = "#ffffff";
  bctx.fillRect(0,0,cw,ch);

  try{
    if(svgUrl){
      await drawSvgToCanvas(bctx, svgUrl, cw, ch);
    }else{
      drawTemplateText(bctx, traceText);
    }
  }catch(_){
    drawTemplateText(bctx, traceText);
  }

  dctx.clearRect(0,0,draw.width, draw.height);

  state.trace = {
    drawCtx: dctx,
    undo: [],
    minInkPixels,
    size: 18
  };

  function pushUndo(){
    const img = dctx.getImageData(0,0,draw.width, draw.height);
    state.trace.undo.push(img);
    if(state.trace.undo.length > 20) state.trace.undo.shift();
  }
  pushUndo();

  function updateLabels(){ $("#traceSizeVal").text(String(state.trace.size)); }
  updateLabels();

  $("#traceSize").off("input").on("input", function(){
    state.trace.size = Number(this.value);
    updateLabels();
  });

  $("#traceUndo").off("click").on("click", function(){
    const u = state.trace.undo;
    if(u.length <= 1) return;
    u.pop();
    dctx.putImageData(u[u.length-1],0,0);
  });

  $("#traceClear").off("click").on("click", function(){
    pushUndo();
    dctx.clearRect(0,0,draw.width, draw.height);
    pushUndo();
  });

  installPointerDraw({
    canvas: draw,
    ctx: dctx,
    getStrokeStyle: () => ({
      color: "rgba(59,130,246,0.95)",
      size: state.trace.size,
      opacity: 1,
      composite: "source-over"
    }),
    onStrokeStart: () => pushUndo()
  });
}

function renderUnsupported(entry){
  setTop({
    title:"ŸÜŸàÿπ ÿ≥ÿ§ÿßŸÑ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ",
    sub:"ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ type ÿØÿßÿÆŸÑ questionBank",
    lesson:state.lesson?.title||"‚Äî",
    progress:progressText(),
    type:"ÿ™ÿ≠ÿ∞Ÿäÿ±",
    audioUrl:""
  });
  $stage().html(`<div class="panelKid">Ÿáÿ∞ÿß ÿßŸÑŸÜŸàÿπ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ: <b>${esc(entry?.q?.type || "")}</b></div>`);
}

/* =========================================================
  VALIDATION
========================================================= */
function validate(){
  const entry = curEntry();
  const q = entry?.q || {};
  const type = String(q.type||"");

  if(type === "multiple_choice" || type === "listen_choose"){
    if(!state.q.selected){
      feedback(false, "ÿßÿÆÿ™ÿ± ÿ•ÿ¨ÿßÿ®ÿ© ÿ£ŸàŸÑŸãÿß", $stage());
      return;
    }
    const ok = String(state.q.selected) === String(q?.answer?.choiceId);
    if(ok){
      feedback(true, "ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©", $(`[data-choice="${CSS.escape(state.q.selected)}"]`));
      setTimeout(nextQ, 520);
    }else{
      feedback(false, "ÿ¨ÿ±Ÿëÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ", $(`[data-choice="${CSS.escape(state.q.selected)}"]`));
    }
    return;
  }

  if(type === "match"){
    const expected = Array.isArray(q.pairs)?q.pairs:[];
    const got = state.q.pairs || {};
    let ok = expected.length > 0;
    for(const p of expected){
      if(String(got[p.leftId]) !== String(p.rightId)){ ok=false; break; }
    }
    feedback(ok, ok ? "ÿ™ÿ∑ÿßÿ®ŸÇ ÿµÿ≠Ÿäÿ≠" : "ÿ®ÿπÿ∂ ÿßŸÑÿ™ÿ∑ÿßÿ®ŸÇÿßÿ™ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©", $stage());
    if(ok) setTimeout(nextQ, 520);
    return;
  }

  if(type === "drag_drop"){
    const expected = Array.isArray(q.map) ? q.map
                   : Array.isArray(q.answers) ? q.answers
                   : [];
    const got = state.q.assign || {};
    let ok = expected.length > 0;
    for(const a of expected){
      const targetId = String(a.targetId ?? a.dropId);
      const dragId   = String(a.dragId);
      if(String(got[targetId]) !== dragId){ ok=false; break; }
    }
    feedback(ok, ok ? "ÿ™Ÿàÿ≤Ÿäÿπ ÿµÿ≠Ÿäÿ≠" : "ÿ¨ÿ±Ÿëÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ", $stage());
    if(ok) setTimeout(nextQ, 520);
    return;
  }

  if(type === "ordering"){
    const expected = Array.isArray(q.answer?.orderedIds) ? q.answer.orderedIds.map(String) : [];
    const got = (state.q.order||[]).map(String);
    const ok = expected.length && expected.length === got.length && expected.every((v,i)=>v===got[i]);
    feedback(ok, ok ? "ÿ™ÿ±ÿ™Ÿäÿ® ÿµÿ≠Ÿäÿ≠" : "ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠", $stage());
    if(ok) setTimeout(nextQ, 520);
    return;
  }

  if(type === "classification"){
    const expected = Array.isArray(q.answer?.map) ? q.answer.map
                   : Array.isArray(q.answers) ? q.answers
                   : [];
    const got = state.q.catAssign || {};
    let ok = expected.length > 0;
    for(const a of expected){
      const itemId = String(a.itemId);
      const catId  = String(a.categoryId);
      if(String(got[itemId]) !== catId){ ok=false; break; }
    }
    feedback(ok, ok ? "ÿ™ÿµŸÜŸäŸÅ ÿµÿ≠Ÿäÿ≠" : "ÿ®ÿπÿ∂ ÿßŸÑÿπŸÜÿßÿµÿ± ŸÅŸä ŸÅÿ¶ÿ© ÿÆÿßÿ∑ÿ¶ÿ©", $stage());
    if(ok) setTimeout(nextQ, 520);
    return;
  }

  if(type === "build_construct"){
    const tiles = Array.isArray(q.tiles)?q.tiles:[];
    const target = norm(q?.answer?.text || "");
    const built = (state.q.built||[])
      .map(id => tiles.find(t => String(t.id)===String(id)))
      .filter(Boolean).map(t=>pickText(t)).join("");
    const ok = norm(built) === target;
    feedback(ok, ok ? "ÿßŸÑŸÉŸÑŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ©" : "ÿ¨ÿ±Ÿëÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ", $stage());
    if(ok) setTimeout(nextQ, 520);
    return;
  }

  if(type === "coloring"){
    if(!state.paint?.drawCtx || !state.paint?.maskCtx){
      feedback(false, "ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ŸÑŸàŸäŸÜ", $stage());
      return;
    }
    // enforce mask before checking
    applyMaskToDrawing(state.paint.drawCtx, state.paint.maskCtx);

    const pct = coverageFromMask(state.paint.drawCtx, state.paint.maskCtx);
    const ok = pct >= Number(state.paint.requiredCoverage || 0.6);
    feedback(ok, ok ? `ŸÖŸÖÿ™ÿßÿ≤ (${(pct*100).toFixed(0)}%)` : `ŸÑŸàŸëŸÜ ÿ£ŸÉÿ´ÿ± (${(pct*100).toFixed(0)}%)`, $("#paintDraw"));
    if(ok) setTimeout(nextQ, 520);
    return;
  }

  if(type === "trace_write"){
    if(!state.trace?.drawCtx){
      feedback(false, "ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ŸÑŸàÿ≠ÿ© ÿßŸÑŸÉÿ™ÿßÿ®ÿ©", $stage());
      return;
    }
    const ink = countNonTransparentPixels(state.trace.drawCtx);
    const ok = ink >= state.trace.minInkPixels;
    feedback(ok, ok ? "ŸÉÿ™ÿßÿ®ÿ© ŸÖŸÖÿ™ÿßÿ≤ÿ©" : "ÿßŸÉÿ™ÿ® ÿ£ŸÉÿ´ÿ± ŸÅŸàŸÇ ÿßŸÑŸÇÿßŸÑÿ®", $("#traceDraw"));
    if(ok) setTimeout(nextQ, 520);
    return;
  }

  feedback(false, "Ÿáÿ∞ÿß ÿßŸÑŸÜŸàÿπ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ", $stage());
}

/* =========================================================
  MAIN RENDER SWITCH
========================================================= */
const RENDERERS = {
  multiple_choice: renderChoice,
  listen_choose:   renderChoice,
  match:           renderMatch,
  drag_drop:       renderDragDrop,
  ordering:        renderOrdering,
  classification:  renderClassification,
  build_construct: renderBuild,
  coloring:        renderColoring,
  trace_write:     renderTrace
};

async function render(){
  wireFooter();

  if(!state.flow.length){
    setTop({
      title:"ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ≥ÿ¶ŸÑÿ©",
      sub:"ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ questionBank",
      lesson:state.lesson?.title||"‚Äî",
      progress:"0/0",
      type:"‚Äî",
      audioUrl:""
    });
    $stage().html(`<div class="panelKid">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÑŸáÿ∞ÿß ÿßŸÑÿØÿ±ÿ≥.</div>`);
    return;
  }

  const entry = curEntry();
  entry.q = resolveQuestion(entry);

  const type = String(entry.q?.type || "");
  const isChoiceType = (type === "multiple_choice" || type === "listen_choose");
  setStageMode(isChoiceType ? "choice" : "default");

  fitStageToViewport();
  if(isChoiceType){
    fitChoiceCardsHard();
  }

  const fn = RENDERERS[type];
  if(!fn) return renderUnsupported(entry);
  return await fn(entry);
}

/* =========================================================
  LOAD
========================================================= */
async function load(){
  try{
    resetQ();
    $stage().text("ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...");

    const res = await fetch(DATA_FILE, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const level = findBy(data?.levels, "levelId", levelId);
    if(!level) throw new Error(`ŸÑÿß ŸäŸàÿ¨ÿØ levelId=${levelId}`);

    const {sec, les} = findLesson(level, sectionId, lessonId);
    if(!sec) throw new Error(`ŸÑÿß ŸäŸàÿ¨ÿØ section=${sectionId}`);
    if(!les) throw new Error(`ŸÑÿß ŸäŸàÿ¨ÿØ lesson=${lessonId}`);

    // ‚úÖ RANDOMIZE (SAFE) ‚Äî shuffle question bank + per-item flow + internal options
    les.interactive = randomizeInteractive(les.interactive);

    state.data = data;
    state.level = level;
    state.section = sec;
    state.lesson = les;

    state.flow = buildFlow(les);
    state.idx = 0;

    await render();
  }catch(e){
    setTop({
      title:"ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ",
      sub:"ÿ™ÿ£ŸÉÿØ ŸÖŸÜ sections-lessens.json ŸàÿßŸÑŸÖÿ≥ÿßÿ±",
      lesson:"‚Äî",
      progress:"‚Äî",
      type:"‚ö†Ô∏è",
      audioUrl:""
    });

    $stage().html(`
      <div class="panelKid">
        <div style="font-weight:1000;">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿ∑ÿ£</div>
        <div class="mt-2" style="color:rgba(15,23,42,.65);font-weight:900;line-height:1.7;">
          ${esc(e?.message||"")}
        </div>
        <div class="d-flex gap-2 flex-wrap mt-3">
          <button class="btnKid btnPrimary px-3" id="retry" type="button">üîÑ ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</button>
        </div>
      </div>
    `);

    $("#retry").off("click").on("click", load);
  }
}

/* =========================================================
  INIT
========================================================= */
load();
</script>


</body>
</html>
